import{CanvasTexture as t,LinearFilter as e,RepeatWrapping as r,Frustum as s,Matrix4 as n,Group as i,PlaneGeometry as o,Vector3 as a,MeshBasicMaterial as c,DoubleSide as h,Mesh as u,ArrowHelper as l,Color as d,BoxGeometry as f,EdgesGeometry as m,LineSegments as p,LineBasicMaterial as g,Vector2 as y,ShaderMaterial as w,BufferGeometry as b,Float32BufferAttribute as _,Uint8BufferAttribute as T,Points as v}from"three";import{GLTFLoader as E}from"three/examples/jsm/loaders/GLTFLoader.js";import{DRACOLoader as S}from"three/examples/jsm/loaders/DRACOLoader.js";import{KTX2Loader as x}from"three/examples/jsm/loaders/KTX2Loader.js";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function A(t,e,r,s){return new(r||(r=Promise))((function(n,i){function o(t){try{c(s.next(t))}catch(t){i(t)}}function a(t){try{c(s.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(o,a)}c((s=s.apply(t,e||[])).next())}))}function M(t,e){if(!t)throw new Error(e||"loader assertion failed.")}const O={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:"undefined"!=typeof global&&global,document:"undefined"!=typeof document&&document},I=O.global||O.self||O.window||{},N="object"!=typeof process||"[object process]"!==String(process)||process.browser,R="undefined"!=typeof process&&process.version&&/v([0-9]*)/.exec(process.version);R&&parseFloat(R[1]);function C(t,e){if(!t)throw new Error(e||"loaders.gl assertion failed.")}const L={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:"undefined"!=typeof global&&global,document:"undefined"!=typeof document&&document},P=L.global||L.self||L.window||{},k="object"!=typeof process||"[object process]"!==String(process)||process.browser,U="function"==typeof importScripts,D="undefined"!=typeof window&&void 0!==window.orientation,j="undefined"!=typeof process&&process.version&&/v([0-9]*)/.exec(process.version);function B(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}j&&parseFloat(j[1]);class V{constructor(t,e){B(this,"name",void 0),B(this,"workerThread",void 0),B(this,"isRunning",void 0),B(this,"result",void 0),B(this,"_resolve",void 0),B(this,"_reject",void 0),this.name=t,this.workerThread=e,this.isRunning=!0,this._resolve=()=>{},this._reject=()=>{},this.result=new Promise(((t,e)=>{this._resolve=t,this._reject=e}))}postMessage(t,e){this.workerThread.postMessage({source:"loaders.gl",type:t,payload:e})}done(t){C(this.isRunning),this.isRunning=!1,this._resolve(t)}error(t){C(this.isRunning),this.isRunning=!1,this._reject(t)}}const F=new Map;function q(t){C(t.source&&!t.url||!t.source&&t.url);let e=F.get(t.source||t.url);return e||(t.url&&(e=function(t){if(!t.startsWith("http"))return t;return z((e=t,`try {\n  importScripts('${e}');\n} catch (error) {\n  console.error(error);\n  throw error;\n}`));var e}(t.url),F.set(t.url,e)),t.source&&(e=z(t.source),F.set(t.source,e))),C(e),e}function z(t){const e=new Blob([t],{type:"application/javascript"});return URL.createObjectURL(e)}function G(t,e=!0,r){const s=r||new Set;if(t){if($(t))s.add(t);else if($(t.buffer))s.add(t.buffer);else if(ArrayBuffer.isView(t));else if(e&&"object"==typeof t)for(const r in t)G(t[r],e,s)}else;return void 0===r?Array.from(s):[]}function $(t){return!!t&&(t instanceof ArrayBuffer||("undefined"!=typeof MessagePort&&t instanceof MessagePort||("undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&t instanceof OffscreenCanvas)))}const W=()=>{};class H{static isSupported(){return"undefined"!=typeof Worker}constructor(t){B(this,"name",void 0),B(this,"source",void 0),B(this,"url",void 0),B(this,"terminated",!1),B(this,"worker",void 0),B(this,"onMessage",void 0),B(this,"onError",void 0),B(this,"_loadableURL","");const{name:e,source:r,url:s}=t;C(r||s),this.name=e,this.source=r,this.url=s,this.onMessage=W,this.onError=t=>console.log(t),this.worker=this._createBrowserWorker()}destroy(){this.onMessage=W,this.onError=W,this.worker.terminate(),this.terminated=!0}get isRunning(){return Boolean(this.onMessage)}postMessage(t,e){e=e||G(t),this.worker.postMessage(t,e)}_getErrorFromErrorEvent(t){let e="Failed to load ";return e+=`worker ${this.name}. `,t.message&&(e+=`${t.message} in `),t.lineno&&(e+=`:${t.lineno}:${t.colno}`),new Error(e)}_createBrowserWorker(){this._loadableURL=q({source:this.source,url:this.url});const t=new Worker(this._loadableURL,{name:this.name});return t.onmessage=t=>{t.data?this.onMessage(t.data):this.onError(new Error("No data received"))},t.onerror=t=>{this.onError(this._getErrorFromErrorEvent(t)),this.terminated=!0},t.onmessageerror=t=>console.error(t),t}}class Q{constructor(t){B(this,"name","unnamed"),B(this,"source",void 0),B(this,"url",void 0),B(this,"maxConcurrency",1),B(this,"maxMobileConcurrency",1),B(this,"onDebug",(()=>{})),B(this,"reuseWorkers",!0),B(this,"props",{}),B(this,"jobQueue",[]),B(this,"idleQueue",[]),B(this,"count",0),B(this,"isDestroyed",!1),this.source=t.source,this.url=t.url,this.setProps(t)}destroy(){this.idleQueue.forEach((t=>t.destroy())),this.isDestroyed=!0}setProps(t){this.props={...this.props,...t},void 0!==t.name&&(this.name=t.name),void 0!==t.maxConcurrency&&(this.maxConcurrency=t.maxConcurrency),void 0!==t.maxMobileConcurrency&&(this.maxMobileConcurrency=t.maxMobileConcurrency),void 0!==t.reuseWorkers&&(this.reuseWorkers=t.reuseWorkers),void 0!==t.onDebug&&(this.onDebug=t.onDebug)}async startJob(t,e=((t,e,r)=>t.done(r)),r=((t,e)=>t.error(e))){const s=new Promise((s=>(this.jobQueue.push({name:t,onMessage:e,onError:r,onStart:s}),this)));return this._startQueuedJob(),await s}async _startQueuedJob(){if(!this.jobQueue.length)return;const t=this._getAvailableWorker();if(!t)return;const e=this.jobQueue.shift();if(e){this.onDebug({message:"Starting job",name:e.name,workerThread:t,backlog:this.jobQueue.length});const r=new V(e.name,t);t.onMessage=t=>e.onMessage(r,t.type,t.payload),t.onError=t=>e.onError(r,t),e.onStart(r);try{await r.result}finally{this.returnWorkerToQueue(t)}}}returnWorkerToQueue(t){this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(t.destroy(),this.count--):this.idleQueue.push(t),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const t=`${this.name.toLowerCase()} (#${this.count} of ${this.maxConcurrency})`;return new H({name:t,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return D?this.maxMobileConcurrency:this.maxConcurrency}}const K={maxConcurrency:3,maxMobileConcurrency:1,onDebug:()=>{},reuseWorkers:!0};class Y{static isSupported(){return H.isSupported()}static getWorkerFarm(t={}){return Y._workerFarm=Y._workerFarm||new Y({}),Y._workerFarm.setProps(t),Y._workerFarm}constructor(t){B(this,"props",void 0),B(this,"workerPools",new Map),this.props={...K},this.setProps(t),this.workerPools=new Map}destroy(){for(const t of this.workerPools.values())t.destroy()}setProps(t){this.props={...this.props,...t};for(const t of this.workerPools.values())t.setProps(this._getWorkerPoolProps())}getWorkerPool(t){const{name:e,source:r,url:s}=t;let n=this.workerPools.get(e);return n||(n=new Q({name:e,source:r,url:s}),n.setProps(this._getWorkerPoolProps()),this.workerPools.set(e,n)),n}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}B(Y,"_workerFarm",void 0);var Z={};const J={};async function X(t,e=null,r={}){return e&&(t=function(t,e,r){if(t.startsWith("http"))return t;const s=r.modules||{};if(s[t])return s[t];if(!k)return`modules/${e}/dist/libs/${t}`;if(r.CDN)return C(r.CDN.startsWith("http")),`${r.CDN}/${e}@3.0.10/dist/libs/${t}`;if(U)return`../src/libs/${t}`;return`modules/${e}/src/libs/${t}`}(t,e,r)),J[t]=J[t]||async function(t){if(t.endsWith("wasm")){const e=await fetch(t);return await e.arrayBuffer()}if(!k)return Z.requireFromFile&&await Z.requireFromFile(t);if(U)return importScripts(t);const e=await fetch(t);return function(t,e){if(!k)return Z.requireFromString&&Z.requireFromString(t,e);if(U)return eval.call(P,t),null;const r=document.createElement("script");r.id=e;try{r.appendChild(document.createTextNode(t))}catch(e){r.text=t}return document.body.appendChild(r),null}(await e.text(),t)}(t),await J[t]}async function tt(t,e,r,s,n){const i=t.id,o=function(t,e={}){const r=e[t.id]||{},s=`${t.id}-worker.js`;let n=r.workerUrl;if("test"===e._workerType&&(n=`modules/${t.module}/dist/${s}`),!n){let e=t.version;"latest"===e&&(e="latest");const r=e?`@${e}`:"";n=`https://unpkg.com/@loaders.gl/${t.module}${r}/dist/${s}`}return C(n),n}(t,r),a=Y.getWorkerFarm(r).getWorkerPool({name:i,url:o});r=JSON.parse(JSON.stringify(r));const c=await a.startJob("process-on-worker",et.bind(null,n));c.postMessage("process",{input:e,options:r});const h=await c.result;return await h.result}async function et(t,e,r,s){switch(r){case"done":e.done(s);break;case"error":e.error(s.error);break;case"process":const{id:n,input:i,options:o}=s;try{const r=await t(i,o);e.postMessage("done",{id:n,result:r})}catch(t){const r=t instanceof Error?t.message:"unknown error";e.postMessage("error",{id:n,error:r})}break;default:console.warn(`parse-with-worker unknown message ${r}`)}}function rt(t,e,r){if(t.byteLength<=e+r)return"";const s=new DataView(t);let n="";for(let t=0;t<r;t++)n+=String.fromCharCode(s.getUint8(e+t));return n}function st(t){try{return JSON.parse(t)}catch(e){throw new Error(`Failed to parse JSON from data starting with "${function(t,e=5){if("string"==typeof t)return t.slice(0,e);if(ArrayBuffer.isView(t))return rt(t.buffer,t.byteOffset,e);if(t instanceof ArrayBuffer)return rt(t,0,e);return""}(t)}"`)}}function nt(t){if(Z.toArrayBuffer&&(t=Z.toArrayBuffer(t)),t instanceof ArrayBuffer)return t;if(ArrayBuffer.isView(t))return t.buffer;if("string"==typeof t){const e=t;return(new TextEncoder).encode(e).buffer}if(t&&"object"==typeof t&&t._toArrayBuffer)return t._toArrayBuffer();throw new Error("toArrayBuffer")}function it(t,e,r){const s=void 0!==r?new Uint8Array(t).subarray(e,e+r):new Uint8Array(t).subarray(e);return new Uint8Array(s).buffer}function ot(t,e){return M(t>=0),M(e>0),t+(e-1)&~(e-1)}function at(t,e,r){let s;if(t instanceof ArrayBuffer)s=new Uint8Array(t);else{const e=t.byteOffset,r=t.byteLength;s=new Uint8Array(t.buffer||t.arrayBuffer,e,r)}return e.set(s,r),r+ot(s.byteLength,4)}async function ct(t){const e=[];for await(const r of t)e.push(r);return function(...t){const e=t.map((t=>t instanceof ArrayBuffer?new Uint8Array(t):t)),r=e.reduce(((t,e)=>t+e.byteLength),0),s=new Uint8Array(r);let n=0;for(const t of e)s.set(t,n),n+=t.byteLength;return s.buffer}(...e)}function ht(){let t;if("undefined"!=typeof window&&window.performance)t=window.performance.now();else if("undefined"!=typeof process&&process.hrtime){const e=process.hrtime();t=1e3*e[0]+e[1]/1e6}else t=Date.now();return t}class ut{constructor(t,e){this.name=t,this.type=e,this.sampleSize=1,this.reset()}setSampleSize(t){return this.sampleSize=t,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(t){return this._count+=t,this._samples++,this._checkSampling(),this}subtractCount(t){return this._count-=t,this._samples++,this._checkSampling(),this}addTime(t){return this._time+=t,this.lastTiming=t,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=ht(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(ht()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}}class lt{constructor({id:t,stats:e}){this.id=t,this.stats={},this._initializeStats(e),Object.seal(this)}get(t,e="count"){return this._getOrCreate({name:t,type:e})}get size(){return Object.keys(this.stats).length}reset(){for(const t in this.stats)this.stats[t].reset();return this}forEach(t){for(const e in this.stats)t(this.stats[e])}getTable(){const t={};return this.forEach((e=>{t[e.name]={time:e.time||0,count:e.count||0,average:e.getAverageTime()||0,hz:e.getHz()||0}})),t}_initializeStats(t=[]){t.forEach((t=>this._getOrCreate(t)))}_getOrCreate(t){if(!t||!t.name)return null;const{name:e,type:r}=t;return this.stats[e]||(this.stats[e]=t instanceof ut?t:new ut(e,r)),this.stats[e]}}const dt={id:"request-scheduler",throttleRequests:!0,maxRequests:6};class ft{constructor(t={}){B(this,"props",void 0),B(this,"stats",void 0),B(this,"activeRequestCount",0),B(this,"requestQueue",[]),B(this,"requestMap",new Map),B(this,"deferredUpdate",null),this.props={...dt,...t},this.stats=new lt({id:this.props.id}),this.stats.get("Queued Requests"),this.stats.get("Active Requests"),this.stats.get("Cancelled Requests"),this.stats.get("Queued Requests Ever"),this.stats.get("Active Requests Ever")}scheduleRequest(t,e=(()=>0)){if(!this.props.throttleRequests)return Promise.resolve({done:()=>{}});if(this.requestMap.has(t))return this.requestMap.get(t);const r={handle:t,priority:0,getPriority:e},s=new Promise((t=>(r.resolve=t,r)));return this.requestQueue.push(r),this.requestMap.set(t,s),this._issueNewRequests(),s}_issueRequest(t){const{handle:e,resolve:r}=t;let s=!1;const n=()=>{s||(s=!0,this.requestMap.delete(e),this.activeRequestCount--,this._issueNewRequests())};return this.activeRequestCount++,r?r({done:n}):Promise.resolve({done:n})}_issueNewRequests(){this.deferredUpdate||(this.deferredUpdate=setTimeout((()=>this._issueNewRequestsAsync()),0))}_issueNewRequestsAsync(){this.deferredUpdate=null;const t=Math.max(this.props.maxRequests-this.activeRequestCount,0);if(0!==t){this._updateAllRequests();for(let e=0;e<t;++e){const t=this.requestQueue.shift();t&&this._issueRequest(t)}}}_updateAllRequests(){const t=this.requestQueue;for(let e=0;e<t.length;++e){const r=t[e];this._updateRequest(r)||(t.splice(e,1),this.requestMap.delete(r.handle),e--)}t.sort(((t,e)=>t.priority-e.priority))}_updateRequest(t){return t.priority=t.getPriority(t.handle),!(t.priority<0)||(t.resolve(null),!1)}}function mt(t){const e=t&&t.lastIndexOf("/");return e>=0?t.substr(0,e):""}const pt={};const gt=t=>"function"==typeof t,yt=t=>null!==t&&"object"==typeof t,wt=t=>yt(t)&&t.constructor==={}.constructor,bt=t=>"undefined"!=typeof Response&&t instanceof Response||t&&t.arrayBuffer&&t.text&&t.json,_t=t=>"undefined"!=typeof Blob&&t instanceof Blob,Tt=t=>(t=>"undefined"!=typeof ReadableStream&&t instanceof ReadableStream||yt(t)&&gt(t.tee)&&gt(t.cancel)&&gt(t.getReader))(t)||(t=>yt(t)&&gt(t.read)&&gt(t.pipe)&&(t=>"boolean"==typeof t)(t.readable))(t),vt=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,Et=/^([-\w.]+\/[-\w.+]+)/;function St(t){const e=Et.exec(t);return e?e[1]:t}function xt(t){const e=vt.exec(t);return e?e[1]:""}const At=/\?.*/;function Mt(t){if(bt(t)){const e=Ot(t.url||"");return{url:e,type:St(t.headers.get("content-type")||"")||xt(e)}}return _t(t)?{url:Ot(t.name||""),type:t.type||""}:"string"==typeof t?{url:Ot(t),type:xt(t)}:{url:"",type:""}}function Ot(t){return t.replace(At,"")}async function It(t){if(bt(t))return t;const e={},r=function(t){return bt(t)?t.headers["content-length"]||-1:_t(t)?t.size:"string"==typeof t?t.length:t instanceof ArrayBuffer||ArrayBuffer.isView(t)?t.byteLength:-1}(t);r>=0&&(e["content-length"]=String(r));const{url:s,type:n}=Mt(t);n&&(e["content-type"]=n);const i=await async function(t){const e=5;if("string"==typeof t)return`data:,${t.slice(0,e)}`;if(t instanceof Blob){const e=t.slice(0,5);return await new Promise((t=>{const r=new FileReader;r.onload=e=>{var r;return t(null==e||null===(r=e.target)||void 0===r?void 0:r.result)},r.readAsDataURL(e)}))}if(t instanceof ArrayBuffer){return`data:base64,${function(t){let e="";const r=new Uint8Array(t);for(let t=0;t<r.byteLength;t++)e+=String.fromCharCode(r[t]);return btoa(e)}(t.slice(0,e))}`}return null}(t);i&&(e["x-first-bytes"]=i),"string"==typeof t&&(t=(new TextEncoder).encode(t));const o=new Response(t,{headers:e});return Object.defineProperty(o,"url",{value:s}),o}async function Nt(t,e){if("string"==typeof t){t=function(t){for(const e in pt)if(t.startsWith(e)){const r=pt[e];t=t.replace(e,r)}return t.startsWith("http://")||t.startsWith("https://")||(t=`${t}`),t}(t);let r=e;return null!=e&&e.fetch&&"function"!=typeof(null==e?void 0:e.fetch)&&(r=e.fetch),await fetch(t,r)}return await It(t)}const Rt={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:"undefined"!=typeof global&&global,document:"undefined"!=typeof document&&document,process:"object"==typeof process&&process},Ct=Rt.window||Rt.self||Rt.global,Lt=Rt.process||{},Pt="undefined"!=typeof __VERSION__?__VERSION__:"untranspiled source",kt=!("object"==typeof process&&"[object process]"===String(process)&&!process.browser)||function(t){if("undefined"!=typeof window&&"object"==typeof window.process&&"renderer"===window.process.type)return!0;if("undefined"!=typeof process&&"object"==typeof process.versions&&Boolean(process.versions.electron))return!0;const e="object"==typeof navigator&&"string"==typeof navigator.userAgent&&navigator.userAgent,r=t||e;return!!(r&&r.indexOf("Electron")>=0)}();class Ut{constructor(t,e,r="sessionStorage"){this.storage=function(t){try{const e=window[t],r="__storage_test__";return e.setItem(r,r),e.removeItem(r),e}catch(t){return null}}(r),this.id=t,this.config={},Object.assign(this.config,e),this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(t){return this.config={},this.updateConfiguration(t)}updateConfiguration(t){if(Object.assign(this.config,t),this.storage){const t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}return this}_loadConfiguration(){let t={};if(this.storage){const e=this.storage.getItem(this.id);t=e?JSON.parse(e):{}}return Object.assign(this.config,t),this}}function Dt(t,e,r,s=600){const n=t.src.replace(/\(/g,"%28").replace(/\)/g,"%29");t.width>s&&(r=Math.min(r,s/t.width));const i=t.width*r,o=t.height*r,a=["font-size:1px;","padding:".concat(Math.floor(o/2),"px ").concat(Math.floor(i/2),"px;"),"line-height:".concat(o,"px;"),"background:url(".concat(n,");"),"background-size:".concat(i,"px ").concat(o,"px;"),"color:transparent;"].join("");return["".concat(e," %c+"),a]}const jt={BLACK:30,RED:31,GREEN:32,YELLOW:33,BLUE:34,MAGENTA:35,CYAN:36,WHITE:37,BRIGHT_BLACK:90,BRIGHT_RED:91,BRIGHT_GREEN:92,BRIGHT_YELLOW:93,BRIGHT_BLUE:94,BRIGHT_MAGENTA:95,BRIGHT_CYAN:96,BRIGHT_WHITE:97};function Bt(t){return"string"==typeof t?jt[t.toUpperCase()]||jt.WHITE:t}function Vt(t,e){if(!t)throw new Error(e||"Assertion failed")}function Ft(){let t;if(kt&&Ct.performance)t=Ct.performance.now();else if(Lt.hrtime){const e=Lt.hrtime();t=1e3*e[0]+e[1]/1e6}else t=Date.now();return t}const qt={debug:kt&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},zt={enabled:!0,level:0};function Gt(){}const $t={},Wt={once:!0};function Ht(t){for(const e in t)for(const r in t[e])return r||"untitled";return"empty"}class Qt{constructor({id:t}={id:""}){this.id=t,this.VERSION=Pt,this._startTs=Ft(),this._deltaTs=Ft(),this.LOG_THROTTLE_TIMEOUT=0,this._storage=new Ut("__probe-".concat(this.id,"__"),zt),this.userData={},this.timeStamp("".concat(this.id," started")),function(t,e=["constructor"]){const r=Object.getPrototypeOf(t),s=Object.getOwnPropertyNames(r);for(const r of s)"function"==typeof t[r]&&(e.find((t=>r===t))||(t[r]=t[r].bind(t)))}(this),Object.seal(this)}set level(t){this.setLevel(t)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((Ft()-this._startTs).toPrecision(10))}getDelta(){return Number((Ft()-this._deltaTs).toPrecision(10))}set priority(t){this.level=t}get priority(){return this.level}getPriority(){return this.level}enable(t=!0){return this._storage.updateConfiguration({enabled:t}),this}setLevel(t){return this._storage.updateConfiguration({level:t}),this}assert(t,e){Vt(t,e)}warn(t){return this._getLogFunction(0,t,qt.warn,arguments,Wt)}error(t){return this._getLogFunction(0,t,qt.error,arguments)}deprecated(t,e){return this.warn("`".concat(t,"` is deprecated and will be removed in a later version. Use `").concat(e,"` instead"))}removed(t,e){return this.error("`".concat(t,"` has been removed. Use `").concat(e,"` instead"))}probe(t,e){return this._getLogFunction(t,e,qt.log,arguments,{time:!0,once:!0})}log(t,e){return this._getLogFunction(t,e,qt.debug,arguments)}info(t,e){return this._getLogFunction(t,e,console.info,arguments)}once(t,e){return this._getLogFunction(t,e,qt.debug||qt.info,arguments,Wt)}table(t,e,r){return e?this._getLogFunction(t,e,console.table||Gt,r&&[r],{tag:Ht(e)}):Gt}image({logLevel:t,priority:e,image:r,message:s="",scale:n=1}){return this._shouldLog(t||e)?kt?function({image:t,message:e="",scale:r=1}){if("string"==typeof t){const s=new Image;return s.onload=()=>{const t=Dt(s,e,r);console.log(...t)},s.src=t,Gt}const s=t.nodeName||"";if("img"===s.toLowerCase())return console.log(...Dt(t,e,r)),Gt;if("canvas"===s.toLowerCase()){const s=new Image;return s.onload=()=>console.log(...Dt(s,e,r)),s.src=t.toDataURL(),Gt}return Gt}({image:r,message:s,scale:n}):function({image:t,message:e="",scale:r=1}){let s=null;try{s=module.require("asciify-image")}catch(t){}if(s)return()=>s(t,{fit:"box",width:"".concat(Math.round(80*r),"%")}).then((t=>console.log(t)));return Gt}({image:r,message:s,scale:n}):Gt}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}get(t){return this._storage.config[t]}set(t,e){this._storage.updateConfiguration({[t]:e})}time(t,e){return this._getLogFunction(t,e,console.time?console.time:console.info)}timeEnd(t,e){return this._getLogFunction(t,e,console.timeEnd?console.timeEnd:console.info)}timeStamp(t,e){return this._getLogFunction(t,e,console.timeStamp||Gt)}group(t,e,r={collapsed:!1}){r=Yt({logLevel:t,message:e,opts:r});const{collapsed:s}=r;return r.method=(s?console.groupCollapsed:console.group)||console.info,this._getLogFunction(r)}groupCollapsed(t,e,r={}){return this.group(t,e,Object.assign({},r,{collapsed:!0}))}groupEnd(t){return this._getLogFunction(t,"",console.groupEnd||Gt)}withGroup(t,e,r){this.group(t,e)();try{r()}finally{this.groupEnd(t)()}}trace(){console.trace&&console.trace()}_shouldLog(t){return this.isEnabled()&&this.getLevel()>=Kt(t)}_getLogFunction(t,e,r,s=[],n){if(this._shouldLog(t)){n=Yt({logLevel:t,message:e,args:s,opts:n}),Vt(r=r||n.method),n.total=this.getTotal(),n.delta=this.getDelta(),this._deltaTs=Ft();const i=n.tag||n.message;if(n.once){if($t[i])return Gt;$t[i]=Ft()}return e=function(t,e,r){if("string"==typeof e){const o=r.time?function(t,e=8){const r=Math.max(e-t.length,0);return"".concat(" ".repeat(r)).concat(t)}(function(t){let e;return e=t<10?"".concat(t.toFixed(2),"ms"):t<100?"".concat(t.toFixed(1),"ms"):t<1e3?"".concat(t.toFixed(0),"ms"):"".concat((t/1e3).toFixed(2),"s"),e}(r.total)):"";e=r.time?"".concat(t,": ").concat(o,"  ").concat(e):"".concat(t,": ").concat(e),s=e,n=r.color,i=r.background,kt||"string"!=typeof s||(n&&(n=Bt(n),s="[".concat(n,"m").concat(s,"[39m")),i&&(n=Bt(i),s="[".concat(i+10,"m").concat(s,"[49m"))),e=s}var s,n,i;return e}(this.id,n.message,n),r.bind(console,e,...n.args)}return Gt}}function Kt(t){if(!t)return 0;let e;switch(typeof t){case"number":e=t;break;case"object":e=t.logLevel||t.priority||0;break;default:return 0}return Vt(Number.isFinite(e)&&e>=0),e}function Yt(t){const{logLevel:e,message:r}=t;t.logLevel=Kt(e);const s=t.args?Array.from(t.args):[];for(;s.length&&s.shift()!==r;);switch(t.args=s,typeof e){case"string":case"function":void 0!==r&&s.unshift(r),t.message=e;break;case"object":Object.assign(t,e)}"function"==typeof t.message&&(t.message=t.message());const n=typeof t.message;return Vt("string"===n||"object"===n),Object.assign(t,t.opts)}Qt.VERSION=Pt;const Zt=new Qt({id:"loaders.gl"});class Jt{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}const Xt={fetch:null,mimeType:void 0,nothrow:!1,log:new class{constructor(){B(this,"console",void 0),this.console=console}log(...t){return this.console.log.bind(this.console,...t)}info(...t){return this.console.info.bind(this.console,...t)}warn(...t){return this.console.warn.bind(this.console,...t)}error(...t){return this.console.error.bind(this.console,...t)}},CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},te={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function ee(){I.loaders=I.loaders||{};const{loaders:t}=I;return t._state=t._state||{},t._state}const re=()=>{const t=ee();return t.globalOptions=t.globalOptions||{...Xt},t.globalOptions};function se(t,e,r,s){return r=r||[],function(t,e){ie(t,null,Xt,te,e);for(const r of e){const s=t&&t[r.id]||{},n=r.options&&r.options[r.id]||{},i=r.deprecatedOptions&&r.deprecatedOptions[r.id]||{};ie(s,r.id,n,i,e)}}(t,r=Array.isArray(r)?r:[r]),function(t,e,r){const s={...t.options||{}};(function(t,e){e&&!("baseUri"in t)&&(t.baseUri=e)})(s,r),null===s.log&&(s.log=new Jt);return ae(s,re()),ae(s,e),s}(e,t,s)}function ne(t,e){const r=re(),s=t||r;return"function"==typeof s.fetch?s.fetch:yt(s.fetch)?t=>Nt(t,s):null!=e&&e.fetch?null==e?void 0:e.fetch:Nt}function ie(t,e,r,s,n){const i=e||"Top level",o=e?`${e}.`:"";for(const a in t){const c=!e&&yt(t[a]),h="baseUri"===a&&!e,u="workerUrl"===a&&e;if(!(a in r)&&!h&&!u)if(a in s)Zt.warn(`${i} loader option '${o}${a}' no longer supported, use '${s[a]}'`)();else if(!c){const t=oe(a,n);Zt.warn(`${i} loader option '${o}${a}' not recognized. ${t}`)()}}}function oe(t,e){const r=t.toLowerCase();let s="";for(const n of e)for(const e in n.options){if(t===e)return`Did you mean '${n.id}.${e}'?`;const i=e.toLowerCase();(r.startsWith(i)||i.startsWith(r))&&(s=s||`Did you mean '${n.id}.${e}'?`)}return s}function ae(t,e){for(const r in e)if(r in e){const s=e[r];wt(s)&&wt(t[r])?t[r]={...t[r],...e[r]}:t[r]=e[r]}}function ce(t){var e;if(!t)return!1;Array.isArray(t)&&(t=t[0]);return Array.isArray(null===(e=t)||void 0===e?void 0:e.extensions)}function he(t){var e,r;let s;return M(t,"null loader"),M(ce(t),"invalid loader"),Array.isArray(t)&&(s=t[1],t=t[0],t={...t,options:{...t.options,...s}}),(null!==(e=t)&&void 0!==e&&e.parseTextSync||null!==(r=t)&&void 0!==r&&r.parseText)&&(t.text=!0),t.text||(t.binary=!0),t}function ue(){return(()=>{const t=ee();return t.loaderRegistry=t.loaderRegistry||[],t.loaderRegistry})()}const le=/\.([^.]+)$/;function de(t,e=[],r,s){if(!fe(t))return null;if(e&&!Array.isArray(e))return he(e);let n=[];e&&(n=n.concat(e)),null!=r&&r.ignoreRegisteredLoaders||n.push(...ue()),function(t){for(const e of t)he(e)}(n);const i=function(t,e,r,s){const{url:n,type:i}=Mt(t),o=n||(null==s?void 0:s.url);let a=null;null!=r&&r.mimeType&&(a=pe(e,null==r?void 0:r.mimeType));return a=a||function(t,e){const r=e&&le.exec(e),s=r&&r[1];return s?function(t,e){e=e.toLowerCase();for(const r of t)for(const t of r.extensions)if(t.toLowerCase()===e)return r;return null}(t,s):null}(e,o),a=a||pe(e,i),a=a||function(t,e){if(!e)return null;for(const r of t)if("string"==typeof e){if(ge(e,r))return r}else if(ArrayBuffer.isView(e)){if(ye(e.buffer,e.byteOffset,r))return r}else if(e instanceof ArrayBuffer){if(ye(e,0,r))return r}return null}(e,t),a=a||pe(e,null==r?void 0:r.fallbackMimeType),a}(t,n,r,s);if(!(i||null!=r&&r.nothrow))throw new Error(me(t));return i}function fe(t){return!(t instanceof Response&&204===t.status)}function me(t){const{url:e,type:r}=Mt(t);let s="No valid loader found";return t&&(s+=` data: "${function(t,e=5){if("string"==typeof t)return t.slice(0,e);if(ArrayBuffer.isView(t))return we(t.buffer,t.byteOffset,e);if(t instanceof ArrayBuffer){return we(t,0,e)}return""}(t)}", contentType: "${r}"`),e&&(s+=` url: ${e}`),s}function pe(t,e){for(const r of t){if(r.mimeTypes&&r.mimeTypes.includes(e))return r;if(e===`application/x.${r.id}`)return r}return null}function ge(t,e){if(e.testText)return e.testText(t);return(Array.isArray(e.tests)?e.tests:[e.tests]).some((e=>t.startsWith(e)))}function ye(t,e,r){return(Array.isArray(r.tests)?r.tests:[r.tests]).some((s=>function(t,e,r,s){if(s instanceof ArrayBuffer)return function(t,e,r){if(r=r||t.byteLength,t.byteLength<r||e.byteLength<r)return!1;const s=new Uint8Array(t),n=new Uint8Array(e);for(let t=0;t<s.length;++t)if(s[t]!==n[t])return!1;return!0}(s,t,s.byteLength);switch(typeof s){case"function":return s(t,r);case"string":return s===we(t,e,s.length);default:return!1}}(t,e,r,s)))}function we(t,e,r){if(t.byteLength<e+r)return"";const s=new DataView(t);let n="";for(let t=0;t<r;t++)n+=String.fromCharCode(s.getUint8(e+t));return n}const be=262144;function _e(t,e){return N?async function*(t,e){const r=t.getReader();let s;try{for(;;){const t=s||r.read();null!=e&&e._streamReadAhead&&(s=r.read());const{done:n,value:i}=await t;if(n)return;yield nt(i)}}catch(t){r.releaseLock()}}(t,e):async function*(t,e){for await(const e of t)yield nt(e)}(t)}function Te(t,e){if("string"==typeof t)return function*(t,e){const r=(null==e?void 0:e.chunkSize)||262144;let s=0;const n=new TextEncoder;for(;s<t.length;){const e=Math.min(t.length-s,r),i=t.slice(s,s+e);s+=e,yield n.encode(i)}}(t,e);if(t instanceof ArrayBuffer)return function*(t,e={}){const{chunkSize:r=be}=e;let s=0;for(;s<t.byteLength;){const e=Math.min(t.byteLength-s,r),n=new ArrayBuffer(e),i=new Uint8Array(t,s,e);new Uint8Array(n).set(i),s+=e,yield n}}(t,e);if(_t(t))return async function*(t,e){const r=(null==e?void 0:e.chunkSize)||1048576;let s=0;for(;s<t.size;){const e=s+r,n=await t.slice(s,e).arrayBuffer();s=e,yield n}}(t,e);if(Tt(t))return _e(t,e);if(bt(t)){return _e(t.body,e)}throw new Error("makeIterator")}const ve="Cannot convert supplied data type";async function Ee(t,e,r){const s=t instanceof ArrayBuffer||ArrayBuffer.isView(t);if("string"==typeof t||s)return function(t,e,r){if(e.text&&"string"==typeof t)return t;var s;if((s=t)&&"object"==typeof s&&s.isBuffer&&(t=t.buffer),t instanceof ArrayBuffer){const r=t;return e.text&&!e.binary?new TextDecoder("utf8").decode(r):r}if(ArrayBuffer.isView(t)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(t);let r=t.buffer;const s=t.byteLength||t.length;return 0===t.byteOffset&&s===r.byteLength||(r=r.slice(t.byteOffset,t.byteOffset+s)),r}throw new Error(ve)}(t,e);if(_t(t)&&(t=await It(t)),bt(t)){const r=t;return await async function(t){if(!t.ok){const e=await async function(t){let e=`Failed to fetch resource ${t.url} (${t.status}): `;try{const r=t.headers.get("Content-Type");let s=t.statusText;r.includes("application/json")&&(s+=` ${await t.text()}`),e+=s,e=e.length>60?`${e.slice(60)}...`:e}catch(t){}return e}(t);throw new Error(e)}}(r),e.binary?await r.arrayBuffer():await r.text()}if(Tt(t)&&(t=Te(t,r)),(n=t)&&"function"==typeof n[Symbol.iterator]||(t=>t&&"function"==typeof t[Symbol.asyncIterator])(t))return ct(t);var n;throw new Error(ve)}async function Se(t,e,r,s){C(!s||"object"==typeof s),!e||Array.isArray(e)||ce(e)||(s=void 0,r=e,e=void 0),t=await t,r=r||{};const{url:n}=Mt(t),i=function(t,e){if(!e&&t&&!Array.isArray(t))return t;let r;if(t&&(r=Array.isArray(t)?t:[t]),e&&e.loaders){const t=Array.isArray(e.loaders)?e.loaders:[e.loaders];r=r?[...r,...t]:t}return r&&r.length?r:null}(e,s),o=await async function(t,e=[],r,s){if(!fe(t))return null;let n=de(t,e,{...r,nothrow:!0},s);if(n)return n;if(_t(t)&&(n=de(t=await t.slice(0,10).arrayBuffer(),e,r,s)),!(n||null!=r&&r.nothrow))throw new Error(me(t));return n}(t,i,r);return o?(s=function(t,e,r=null){if(r)return r;const s={fetch:ne(e,t),...t};return Array.isArray(s.loaders)||(s.loaders=null),s}({url:n,parse:Se,loaders:i},r=se(r,o,i,n),s),await async function(t,e,r,s){if(function(t,e="3.0.10"){C(t,"no worker provided");const r=t.version}(t),e=await Ee(e,t,r),t.parseTextSync&&"string"==typeof e)return r.dataType="text",t.parseTextSync(e,r,s,t);if(function(t,e){return!!Y.isSupported()&&t.worker&&(null==e?void 0:e.worker)}(t,r))return await tt(t,e,r,0,Se);if(t.parseText&&"string"==typeof e)return await t.parseText(e,r,s,t);if(t.parse)return await t.parse(e,r,s,t);throw C(!t.parseSync),new Error(`${t.id} loader - no parser found and worker is disabled`)}(o,t,r,s)):null}async function xe(t,e,r,s){Array.isArray(e)||ce(e)||(r=e,e=void 0);const n=ne(r);let i=t;return"string"==typeof t&&(i=await n(t)),_t(t)&&(i=await n(t)),await Se(i,e,r)}function Ae(t,e){if(!t)throw new Error("math.gl assertion ".concat(e))}const Me=1/Math.PI*180,Oe=1/180*Math.PI,Ie={};function Ne(t,{precision:e=Ie.precision||4}={}){return t=function(t){return Math.round(t/Ie.EPSILON)*Ie.EPSILON}(t),"".concat(parseFloat(t.toPrecision(e)))}function Re(t){return Array.isArray(t)||ArrayBuffer.isView(t)&&!(t instanceof DataView)}function Ce(t,e,r){if(Re(t)){r=r||((s=t).clone?s.clone():new Array(s.length));for(let s=0;s<r.length&&s<t.length;++s)r[s]=e(t[s],s,r);return r}var s;return e(t)}function Le(t){return function(t,e){return Ce(t,(t=>t*Oe),e)}(t)}function Pe(t,e){return Ce(t,(t=>t*Me),e)}function ke(t,e,r){const s=Ie.EPSILON;r&&(Ie.EPSILON=r);try{if(t===e)return!0;if(Re(t)&&Re(e)){if(t.length!==e.length)return!1;for(let r=0;r<t.length;++r)if(!ke(t[r],e[r]))return!1;return!0}return t&&t.equals?t.equals(e):e&&e.equals?e.equals(t):!(!Number.isFinite(t)||!Number.isFinite(e))&&Math.abs(t-e)<=Ie.EPSILON*Math.max(1,Math.abs(t),Math.abs(e))}finally{Ie.EPSILON=s}}Ie.EPSILON=1e-12,Ie.debug=!1,Ie.precision=4,Ie.printTypes=!1,Ie.printDegrees=!1,Ie.printRowMajor=!0;class Ue extends(function(t){function e(){var e=Reflect.construct(t,Array.from(arguments));return Object.setPrototypeOf(e,Object.getPrototypeOf(this)),e}return e.prototype=Object.create(t.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t,e}(Array)){get ELEMENTS(){return Ae(!1),0}clone(){return(new this.constructor).copy(this)}from(t){return Array.isArray(t)?this.copy(t):this.fromObject(t)}fromArray(t,e=0){for(let r=0;r<this.ELEMENTS;++r)this[r]=t[r+e];return this.check()}to(t){return t===this?this:Re(t)?this.toArray(t):this.toObject(t)}toTarget(t){return t?this.to(t):this}toArray(t=[],e=0){for(let r=0;r<this.ELEMENTS;++r)t[e+r]=this[r];return t}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(Ie)}formatString(t){let e="";for(let r=0;r<this.ELEMENTS;++r)e+=(r>0?", ":"")+Ne(this[r],t);return"".concat(t.printTypes?this.constructor.name:"","[").concat(e,"]")}equals(t){if(!t||this.length!==t.length)return!1;for(let e=0;e<this.ELEMENTS;++e)if(!ke(this[e],t[e]))return!1;return!0}exactEquals(t){if(!t||this.length!==t.length)return!1;for(let e=0;e<this.ELEMENTS;++e)if(this[e]!==t[e])return!1;return!0}negate(){for(let t=0;t<this.ELEMENTS;++t)this[t]=-this[t];return this.check()}lerp(t,e,r){void 0===r&&(r=e,e=t,t=this);for(let s=0;s<this.ELEMENTS;++s){const n=t[s];this[s]=n+r*(e[s]-n)}return this.check()}min(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=Math.min(t[e],this[e]);return this.check()}max(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=Math.max(t[e],this[e]);return this.check()}clamp(t,e){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],t[r]),e[r]);return this.check()}add(...t){for(const e of t)for(let t=0;t<this.ELEMENTS;++t)this[t]+=e[t];return this.check()}subtract(...t){for(const e of t)for(let t=0;t<this.ELEMENTS;++t)this[t]-=e[t];return this.check()}scale(t){if(Array.isArray(t))return this.multiply(t);for(let e=0;e<this.ELEMENTS;++e)this[e]*=t;return this.check()}sub(t){return this.subtract(t)}setScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=t;return this.check()}addScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]+=t;return this.check()}subScalar(t){return this.addScalar(-t)}multiplyScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]*=t;return this.check()}divideScalar(t){return this.scale(1/t)}clampScalar(t,e){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],t),e);return this.check()}multiplyByScalar(t){return this.scale(t)}get elements(){return this}check(){if(Ie.debug&&!this.validate())throw new Error("math.gl: ".concat(this.constructor.name," some fields set to invalid numbers'"));return this}validate(){let t=this.length===this.ELEMENTS;for(let e=0;e<this.ELEMENTS;++e)t=t&&Number.isFinite(this[e]);return t}}function De(t){if(!Number.isFinite(t))throw new Error("Invalid number ".concat(t));return t}function je(t,e,r=""){if(Ie.debug&&!function(t,e){if(t.length!==e)return!1;for(let e=0;e<t.length;++e)if(!Number.isFinite(t[e]))return!1;return!0}(t,e))throw new Error("math.gl: ".concat(r," some fields set to invalid numbers'"));return t}const Be={};function Ve(t,e){Be[t]||(Be[t]=!0,console.warn("".concat(t," has been removed in version ").concat(e,", see upgrade guide for more information")))}class Fe extends Ue{get ELEMENTS(){return Ae(!1),0}copy(t){return Ae(!1),this}get x(){return this[0]}set x(t){this[0]=De(t)}get y(){return this[1]}set y(t){this[1]=De(t)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let t=0;for(let e=0;e<this.ELEMENTS;++e)t+=this[e]*this[e];return t}magnitudeSquared(){return this.lengthSquared()}distance(t){return Math.sqrt(this.distanceSquared(t))}distanceSquared(t){let e=0;for(let r=0;r<this.ELEMENTS;++r){const s=this[r]-t[r];e+=s*s}return De(e)}dot(t){let e=0;for(let r=0;r<this.ELEMENTS;++r)e+=this[r]*t[r];return De(e)}normalize(){const t=this.magnitude();if(0!==t)for(let e=0;e<this.ELEMENTS;++e)this[e]/=t;return this.check()}multiply(...t){for(const e of t)for(let t=0;t<this.ELEMENTS;++t)this[t]*=e[t];return this.check()}divide(...t){for(const e of t)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e[t];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(t){return this.distance(t)}distanceToSquared(t){return this.distanceSquared(t)}getComponent(t){return Ae(t>=0&&t<this.ELEMENTS,"index is out of range"),De(this[t])}setComponent(t,e){return Ae(t>=0&&t<this.ELEMENTS,"index is out of range"),this[t]=e,this.check()}addVectors(t,e){return this.copy(t).add(e)}subVectors(t,e){return this.copy(t).subtract(e)}multiplyVectors(t,e){return this.copy(t).multiply(e)}addScaledVector(t,e){return this.add(new this.constructor(t).multiplyScalar(e))}}var qe,ze="undefined"!=typeof Float32Array?Float32Array:Array;function Ge(t,e,r){var s=e[0],n=e[1];return t[0]=r[0]*s+r[3]*n+r[6],t[1]=r[1]*s+r[4]*n+r[7],t}function $e(t,e,r){var s=e[0],n=e[1];return t[0]=r[0]*s+r[4]*n+r[12],t[1]=r[1]*s+r[5]*n+r[13],t}function We(t,e,r){const s=e[0],n=e[1],i=r[3]*s+r[7]*n||1;return t[0]=(r[0]*s+r[4]*n)/i,t[1]=(r[1]*s+r[5]*n)/i,t}function He(t,e,r){const s=e[0],n=e[1],i=e[2],o=r[3]*s+r[7]*n+r[11]*i||1;return t[0]=(r[0]*s+r[4]*n+r[8]*i)/o,t[1]=(r[1]*s+r[5]*n+r[9]*i)/o,t[2]=(r[2]*s+r[6]*n+r[10]*i)/o,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)}),qe=new ze(2),ze!=Float32Array&&(qe[0]=0,qe[1]=0);class Qe extends Fe{constructor(t=0,e=0){super(2),Re(t)&&1===arguments.length?this.copy(t):(Ie.debug&&(De(t),De(e)),this[0]=t,this[1]=e)}set(t,e){return this[0]=t,this[1]=e,this.check()}copy(t){return this[0]=t[0],this[1]=t[1],this.check()}fromObject(t){return Ie.debug&&(De(t.x),De(t.y)),this[0]=t.x,this[1]=t.y,this.check()}toObject(t){return t.x=this[0],t.y=this[1],t}get ELEMENTS(){return 2}horizontalAngle(){return Math.atan2(this.y,this.x)}verticalAngle(){return Math.atan2(this.x,this.y)}transform(t){return this.transformAsPoint(t)}transformAsPoint(t){return $e(this,this,t),this.check()}transformAsVector(t){return We(this,this,t),this.check()}transformByMatrix3(t){return Ge(this,this,t),this.check()}transformByMatrix2x3(t){return function(t,e,r){var s=e[0],n=e[1];t[0]=r[0]*s+r[2]*n+r[4],t[1]=r[1]*s+r[3]*n+r[5]}(this,this,t),this.check()}transformByMatrix2(t){return function(t,e,r){var s=e[0],n=e[1];t[0]=r[0]*s+r[2]*n,t[1]=r[1]*s+r[3]*n}(this,this,t),this.check()}}function Ke(){var t=new ze(3);return ze!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function Ye(t){var e=t[0],r=t[1],s=t[2];return Math.hypot(e,r,s)}function Ze(t,e,r){var s=new ze(3);return s[0]=t,s[1]=e,s[2]=r,s}function Je(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function Xe(t,e,r){var s=e[0],n=e[1],i=e[2],o=r[0],a=r[1],c=r[2];return t[0]=n*c-i*a,t[1]=i*o-s*c,t[2]=s*a-n*o,t}function tr(t,e,r){var s=e[0],n=e[1],i=e[2],o=r[3]*s+r[7]*n+r[11]*i+r[15];return o=o||1,t[0]=(r[0]*s+r[4]*n+r[8]*i+r[12])/o,t[1]=(r[1]*s+r[5]*n+r[9]*i+r[13])/o,t[2]=(r[2]*s+r[6]*n+r[10]*i+r[14])/o,t}function er(t,e,r){var s=e[0],n=e[1],i=e[2];return t[0]=s*r[0]+n*r[3]+i*r[6],t[1]=s*r[1]+n*r[4]+i*r[7],t[2]=s*r[2]+n*r[5]+i*r[8],t}function rr(t,e,r){var s=r[0],n=r[1],i=r[2],o=r[3],a=e[0],c=e[1],h=e[2],u=n*h-i*c,l=i*a-s*h,d=s*c-n*a,f=n*d-i*l,m=i*u-s*d,p=s*l-n*u,g=2*o;return u*=g,l*=g,d*=g,f*=2,m*=2,p*=2,t[0]=a+u+f,t[1]=c+l+m,t[2]=h+d+p,t}function sr(t,e,r,s){var n=[],i=[];return n[0]=e[0]-r[0],n[1]=e[1]-r[1],n[2]=e[2]-r[2],i[0]=n[0],i[1]=n[1]*Math.cos(s)-n[2]*Math.sin(s),i[2]=n[1]*Math.sin(s)+n[2]*Math.cos(s),t[0]=i[0]+r[0],t[1]=i[1]+r[1],t[2]=i[2]+r[2],t}function nr(t,e,r,s){var n=[],i=[];return n[0]=e[0]-r[0],n[1]=e[1]-r[1],n[2]=e[2]-r[2],i[0]=n[2]*Math.sin(s)+n[0]*Math.cos(s),i[1]=n[1],i[2]=n[2]*Math.cos(s)-n[0]*Math.sin(s),t[0]=i[0]+r[0],t[1]=i[1]+r[1],t[2]=i[2]+r[2],t}function ir(t,e,r,s){var n=[],i=[];return n[0]=e[0]-r[0],n[1]=e[1]-r[1],n[2]=e[2]-r[2],i[0]=n[0]*Math.cos(s)-n[1]*Math.sin(s),i[1]=n[0]*Math.sin(s)+n[1]*Math.cos(s),i[2]=n[2],t[0]=i[0]+r[0],t[1]=i[1]+r[1],t[2]=i[2]+r[2],t}function or(t,e){var r=t[0],s=t[1],n=t[2],i=e[0],o=e[1],a=e[2],c=Math.sqrt(r*r+s*s+n*n)*Math.sqrt(i*i+o*o+a*a),h=c&&Je(t,e)/c;return Math.acos(Math.min(Math.max(h,-1),1))}var ar=Ye;!function(){var t=Ke()}();const cr=[0,0,0],hr={};class ur extends Fe{static get ZERO(){return hr.ZERO=hr.ZERO||Object.freeze(new ur(0,0,0,0))}constructor(t=0,e=0,r=0){super(-0,-0,-0),1===arguments.length&&Re(t)?this.copy(t):(Ie.debug&&(De(t),De(e),De(r)),this[0]=t,this[1]=e,this[2]=r)}set(t,e,r){return this[0]=t,this[1]=e,this[2]=r,this.check()}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this.check()}fromObject(t){return Ie.debug&&(De(t.x),De(t.y),De(t.z)),this[0]=t.x,this[1]=t.y,this[2]=t.z,this.check()}toObject(t){return t.x=this[0],t.y=this[1],t.z=this[2],t}get ELEMENTS(){return 3}get z(){return this[2]}set z(t){this[2]=De(t)}angle(t){return or(this,t)}cross(t){return Xe(this,this,t),this.check()}rotateX({radians:t,origin:e=cr}){return sr(this,this,e,t),this.check()}rotateY({radians:t,origin:e=cr}){return nr(this,this,e,t),this.check()}rotateZ({radians:t,origin:e=cr}){return ir(this,this,e,t),this.check()}transform(t){return this.transformAsPoint(t)}transformAsPoint(t){return tr(this,this,t),this.check()}transformAsVector(t){return He(this,this,t),this.check()}transformByMatrix3(t){return er(this,this,t),this.check()}transformByMatrix2(t){return function(t,e,r){const s=e[0],n=e[1];t[0]=r[0]*s+r[2]*n,t[1]=r[1]*s+r[3]*n,t[2]=e[2]}(this,this,t),this.check()}transformByQuaternion(t){return rr(this,this,t),this.check()}}class lr extends Ue{get ELEMENTS(){return Ae(!1),0}get RANK(){return Ae(!1),0}toString(){let t="[";if(Ie.printRowMajor){t+="row-major:";for(let e=0;e<this.RANK;++e)for(let r=0;r<this.RANK;++r)t+=" ".concat(this[r*this.RANK+e])}else{t+="column-major:";for(let e=0;e<this.ELEMENTS;++e)t+=" ".concat(this[e])}return t+="]",t}getElementIndex(t,e){return e*this.RANK+t}getElement(t,e){return this[e*this.RANK+t]}setElement(t,e,r){return this[e*this.RANK+t]=De(r),this}getColumn(t,e=new Array(this.RANK).fill(-0)){const r=t*this.RANK;for(let t=0;t<this.RANK;++t)e[t]=this[r+t];return e}setColumn(t,e){const r=t*this.RANK;for(let t=0;t<this.RANK;++t)this[r+t]=e[t];return this}}function dr(t,e,r){var s=e[0],n=e[1],i=e[2],o=e[3],a=e[4],c=e[5],h=e[6],u=e[7],l=e[8],d=r[0],f=r[1],m=r[2],p=r[3],g=r[4],y=r[5],w=r[6],b=r[7],_=r[8];return t[0]=d*s+f*o+m*h,t[1]=d*n+f*a+m*u,t[2]=d*i+f*c+m*l,t[3]=p*s+g*o+y*h,t[4]=p*n+g*a+y*u,t[5]=p*i+g*c+y*l,t[6]=w*s+b*o+_*h,t[7]=w*n+b*a+_*u,t[8]=w*i+b*c+_*l,t}function fr(t,e,r){var s=r[0],n=r[1];return t[0]=s*e[0],t[1]=s*e[1],t[2]=s*e[2],t[3]=n*e[3],t[4]=n*e[4],t[5]=n*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}const mr=Object.freeze([1,0,0,0,1,0,0,0,1]),pr=Object.freeze([0,0,0,0,0,0,0,0,0]),gr=Object.freeze({COL0ROW0:0,COL0ROW1:1,COL0ROW2:2,COL1ROW0:3,COL1ROW1:4,COL1ROW2:5,COL2ROW0:6,COL2ROW1:7,COL2ROW2:8}),yr={};class wr extends lr{static get IDENTITY(){return yr.IDENTITY=yr.IDENTITY||Object.freeze(new wr(mr)),yr.IDENTITY}static get ZERO(){return yr.ZERO=yr.ZERO||Object.freeze(new wr(pr)),yr.ZERO}get ELEMENTS(){return 9}get RANK(){return 3}get INDICES(){return gr}constructor(t){super(-0,-0,-0,-0,-0,-0,-0,-0,-0),1===arguments.length&&Array.isArray(t)?this.copy(t):this.identity()}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3],this[4]=t[4],this[5]=t[5],this[6]=t[6],this[7]=t[7],this[8]=t[8],this.check()}set(t,e,r,s,n,i,o,a,c){return this[0]=t,this[1]=e,this[2]=r,this[3]=s,this[4]=n,this[5]=i,this[6]=o,this[7]=a,this[8]=c,this.check()}setRowMajor(t,e,r,s,n,i,o,a,c){return this[0]=t,this[1]=s,this[2]=o,this[3]=e,this[4]=n,this[5]=a,this[6]=r,this[7]=i,this[8]=c,this.check()}determinant(){return e=(t=this)[0],r=t[1],s=t[2],n=t[3],i=t[4],o=t[5],a=t[6],c=t[7],h=t[8],e*(h*i-o*c)+r*(-h*n+o*a)+s*(c*n-i*a);var t,e,r,s,n,i,o,a,c,h}identity(){return this.copy(mr)}fromQuaternion(t){return function(t,e){var r=e[0],s=e[1],n=e[2],i=e[3],o=r+r,a=s+s,c=n+n,h=r*o,u=s*o,l=s*a,d=n*o,f=n*a,m=n*c,p=i*o,g=i*a,y=i*c;t[0]=1-l-m,t[3]=u-y,t[6]=d+g,t[1]=u+y,t[4]=1-h-m,t[7]=f-p,t[2]=d-g,t[5]=f+p,t[8]=1-h-l}(this,t),this.check()}transpose(){return function(t,e){if(t===e){var r=e[1],s=e[2],n=e[5];t[1]=e[3],t[2]=e[6],t[3]=r,t[5]=e[7],t[6]=s,t[7]=n}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8]}(this,this),this.check()}invert(){return function(t,e){var r=e[0],s=e[1],n=e[2],i=e[3],o=e[4],a=e[5],c=e[6],h=e[7],u=e[8],l=u*o-a*h,d=-u*i+a*c,f=h*i-o*c,m=r*l+s*d+n*f;m&&(m=1/m,t[0]=l*m,t[1]=(-u*s+n*h)*m,t[2]=(a*s-n*o)*m,t[3]=d*m,t[4]=(u*r-n*c)*m,t[5]=(-a*r+n*i)*m,t[6]=f*m,t[7]=(-h*r+s*c)*m,t[8]=(o*r-s*i)*m)}(this,this),this.check()}multiplyLeft(t){return dr(this,t,this),this.check()}multiplyRight(t){return dr(this,this,t),this.check()}rotate(t){return function(t,e,r){var s=e[0],n=e[1],i=e[2],o=e[3],a=e[4],c=e[5],h=e[6],u=e[7],l=e[8],d=Math.sin(r),f=Math.cos(r);t[0]=f*s+d*o,t[1]=f*n+d*a,t[2]=f*i+d*c,t[3]=f*o-d*s,t[4]=f*a-d*n,t[5]=f*c-d*i,t[6]=h,t[7]=u,t[8]=l}(this,this,t),this.check()}scale(t){return Array.isArray(t)?fr(this,this,t):fr(this,this,[t,t,t]),this.check()}translate(t){return function(t,e,r){var s=e[0],n=e[1],i=e[2],o=e[3],a=e[4],c=e[5],h=e[6],u=e[7],l=e[8],d=r[0],f=r[1];t[0]=s,t[1]=n,t[2]=i,t[3]=o,t[4]=a,t[5]=c,t[6]=d*s+f*o+h,t[7]=d*n+f*a+u,t[8]=d*i+f*c+l}(this,this,t),this.check()}transform(t,e){switch(t.length){case 2:e=Ge(e||[-0,-0],t,this);break;case 3:e=er(e||[-0,-0,-0],t,this);break;case 4:e=function(t,e,r){const s=e[0],n=e[1],i=e[2];return t[0]=r[0]*s+r[3]*n+r[6]*i,t[1]=r[1]*s+r[4]*n+r[7]*i,t[2]=r[2]*s+r[5]*n+r[8]*i,t[3]=e[3],t}(e||[-0,-0,-0,-0],t,this);break;default:throw new Error("Illegal vector")}return je(e,t.length),e}transformVector(t,e){return Ve("Matrix3.transformVector"),this.transform(t,e)}transformVector2(t,e){return Ve("Matrix3.transformVector"),this.transform(t,e)}transformVector3(t,e){return Ve("Matrix3.transformVector"),this.transform(t,e)}}function br(t,e){if(t===e){var r=e[1],s=e[2],n=e[3],i=e[6],o=e[7],a=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=r,t[6]=e[9],t[7]=e[13],t[8]=s,t[9]=i,t[11]=e[14],t[12]=n,t[13]=o,t[14]=a}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t}function _r(t,e){var r=e[0],s=e[1],n=e[2],i=e[3],o=e[4],a=e[5],c=e[6],h=e[7],u=e[8],l=e[9],d=e[10],f=e[11],m=e[12],p=e[13],g=e[14],y=e[15],w=r*a-s*o,b=r*c-n*o,_=r*h-i*o,T=s*c-n*a,v=s*h-i*a,E=n*h-i*c,S=u*p-l*m,x=u*g-d*m,A=u*y-f*m,M=l*g-d*p,O=l*y-f*p,I=d*y-f*g,N=w*I-b*O+_*M+T*A-v*x+E*S;return N?(N=1/N,t[0]=(a*I-c*O+h*M)*N,t[1]=(n*O-s*I-i*M)*N,t[2]=(p*E-g*v+y*T)*N,t[3]=(d*v-l*E-f*T)*N,t[4]=(c*A-o*I-h*x)*N,t[5]=(r*I-n*A+i*x)*N,t[6]=(g*_-m*E-y*b)*N,t[7]=(u*E-d*_+f*b)*N,t[8]=(o*O-a*A+h*S)*N,t[9]=(s*A-r*O-i*S)*N,t[10]=(m*v-p*_+y*w)*N,t[11]=(l*_-u*v-f*w)*N,t[12]=(a*x-o*M-c*S)*N,t[13]=(r*M-s*x+n*S)*N,t[14]=(p*b-m*T-g*w)*N,t[15]=(u*T-l*b+d*w)*N,t):null}function Tr(t){var e=t[0],r=t[1],s=t[2],n=t[3],i=t[4],o=t[5],a=t[6],c=t[7],h=t[8],u=t[9],l=t[10],d=t[11],f=t[12],m=t[13],p=t[14],g=t[15];return(e*o-r*i)*(l*g-d*p)-(e*a-s*i)*(u*g-d*m)+(e*c-n*i)*(u*p-l*m)+(r*a-s*o)*(h*g-d*f)-(r*c-n*o)*(h*p-l*f)+(s*c-n*a)*(h*m-u*f)}function vr(t,e,r){var s=e[0],n=e[1],i=e[2],o=e[3],a=e[4],c=e[5],h=e[6],u=e[7],l=e[8],d=e[9],f=e[10],m=e[11],p=e[12],g=e[13],y=e[14],w=e[15],b=r[0],_=r[1],T=r[2],v=r[3];return t[0]=b*s+_*a+T*l+v*p,t[1]=b*n+_*c+T*d+v*g,t[2]=b*i+_*h+T*f+v*y,t[3]=b*o+_*u+T*m+v*w,b=r[4],_=r[5],T=r[6],v=r[7],t[4]=b*s+_*a+T*l+v*p,t[5]=b*n+_*c+T*d+v*g,t[6]=b*i+_*h+T*f+v*y,t[7]=b*o+_*u+T*m+v*w,b=r[8],_=r[9],T=r[10],v=r[11],t[8]=b*s+_*a+T*l+v*p,t[9]=b*n+_*c+T*d+v*g,t[10]=b*i+_*h+T*f+v*y,t[11]=b*o+_*u+T*m+v*w,b=r[12],_=r[13],T=r[14],v=r[15],t[12]=b*s+_*a+T*l+v*p,t[13]=b*n+_*c+T*d+v*g,t[14]=b*i+_*h+T*f+v*y,t[15]=b*o+_*u+T*m+v*w,t}function Er(t,e,r){var s,n,i,o,a,c,h,u,l,d,f,m,p=r[0],g=r[1],y=r[2];return e===t?(t[12]=e[0]*p+e[4]*g+e[8]*y+e[12],t[13]=e[1]*p+e[5]*g+e[9]*y+e[13],t[14]=e[2]*p+e[6]*g+e[10]*y+e[14],t[15]=e[3]*p+e[7]*g+e[11]*y+e[15]):(s=e[0],n=e[1],i=e[2],o=e[3],a=e[4],c=e[5],h=e[6],u=e[7],l=e[8],d=e[9],f=e[10],m=e[11],t[0]=s,t[1]=n,t[2]=i,t[3]=o,t[4]=a,t[5]=c,t[6]=h,t[7]=u,t[8]=l,t[9]=d,t[10]=f,t[11]=m,t[12]=s*p+a*g+l*y+e[12],t[13]=n*p+c*g+d*y+e[13],t[14]=i*p+h*g+f*y+e[14],t[15]=o*p+u*g+m*y+e[15]),t}function Sr(t,e,r){var s=r[0],n=r[1],i=r[2];return t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t[3]=e[3]*s,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t[8]=e[8]*i,t[9]=e[9]*i,t[10]=e[10]*i,t[11]=e[11]*i,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function xr(t,e,r,s){var n,i,o,a,c,h,u,l,d,f,m,p,g,y,w,b,_,T,v,E,S,x,A,M,O=s[0],I=s[1],N=s[2],R=Math.hypot(O,I,N);return R<1e-6?null:(O*=R=1/R,I*=R,N*=R,n=Math.sin(r),o=1-(i=Math.cos(r)),a=e[0],c=e[1],h=e[2],u=e[3],l=e[4],d=e[5],f=e[6],m=e[7],p=e[8],g=e[9],y=e[10],w=e[11],b=O*O*o+i,_=I*O*o+N*n,T=N*O*o-I*n,v=O*I*o-N*n,E=I*I*o+i,S=N*I*o+O*n,x=O*N*o+I*n,A=I*N*o-O*n,M=N*N*o+i,t[0]=a*b+l*_+p*T,t[1]=c*b+d*_+g*T,t[2]=h*b+f*_+y*T,t[3]=u*b+m*_+w*T,t[4]=a*v+l*E+p*S,t[5]=c*v+d*E+g*S,t[6]=h*v+f*E+y*S,t[7]=u*v+m*E+w*S,t[8]=a*x+l*A+p*M,t[9]=c*x+d*A+g*M,t[10]=h*x+f*A+y*M,t[11]=u*x+m*A+w*M,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)}function Ar(t,e,r){var s=Math.sin(r),n=Math.cos(r),i=e[4],o=e[5],a=e[6],c=e[7],h=e[8],u=e[9],l=e[10],d=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=i*n+h*s,t[5]=o*n+u*s,t[6]=a*n+l*s,t[7]=c*n+d*s,t[8]=h*n-i*s,t[9]=u*n-o*s,t[10]=l*n-a*s,t[11]=d*n-c*s,t}function Mr(t,e,r){var s=Math.sin(r),n=Math.cos(r),i=e[0],o=e[1],a=e[2],c=e[3],h=e[8],u=e[9],l=e[10],d=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=i*n-h*s,t[1]=o*n-u*s,t[2]=a*n-l*s,t[3]=c*n-d*s,t[8]=i*s+h*n,t[9]=o*s+u*n,t[10]=a*s+l*n,t[11]=c*s+d*n,t}function Or(t,e,r){var s=Math.sin(r),n=Math.cos(r),i=e[0],o=e[1],a=e[2],c=e[3],h=e[4],u=e[5],l=e[6],d=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=i*n+h*s,t[1]=o*n+u*s,t[2]=a*n+l*s,t[3]=c*n+d*s,t[4]=h*n-i*s,t[5]=u*n-o*s,t[6]=l*n-a*s,t[7]=d*n-c*s,t}function Ir(t,e){var r=e[0],s=e[1],n=e[2],i=e[3],o=r+r,a=s+s,c=n+n,h=r*o,u=s*o,l=s*a,d=n*o,f=n*a,m=n*c,p=i*o,g=i*a,y=i*c;return t[0]=1-l-m,t[1]=u+y,t[2]=d-g,t[3]=0,t[4]=u-y,t[5]=1-h-m,t[6]=f+p,t[7]=0,t[8]=d+g,t[9]=f-p,t[10]=1-h-l,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Nr(t,e,r,s,n,i,o){var a=1/(r-e),c=1/(n-s),h=1/(i-o);return t[0]=2*i*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*i*c,t[6]=0,t[7]=0,t[8]=(r+e)*a,t[9]=(n+s)*c,t[10]=(o+i)*h,t[11]=-1,t[12]=0,t[13]=0,t[14]=o*i*2*h,t[15]=0,t}function Rr(t,e,r,s,n){var i,o=1/Math.tan(e/2);return t[0]=o/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=n&&n!==1/0?(i=1/(s-n),t[10]=(n+s)*i,t[14]=2*n*s*i):(t[10]=-1,t[14]=-2*s),t}function Cr(t,e,r,s,n,i,o){var a=1/(e-r),c=1/(s-n),h=1/(i-o);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*c,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*h,t[11]=0,t[12]=(e+r)*a,t[13]=(n+s)*c,t[14]=(o+i)*h,t[15]=1,t}function Lr(t,e,r,s){var n,i,o,a,c,h,u,l,d,f,m=e[0],p=e[1],g=e[2],y=s[0],w=s[1],b=s[2],_=r[0],T=r[1],v=r[2];return Math.abs(m-_)<1e-6&&Math.abs(p-T)<1e-6&&Math.abs(g-v)<1e-6?function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(t):(u=m-_,l=p-T,d=g-v,n=w*(d*=f=1/Math.hypot(u,l,d))-b*(l*=f),i=b*(u*=f)-y*d,o=y*l-w*u,(f=Math.hypot(n,i,o))?(n*=f=1/f,i*=f,o*=f):(n=0,i=0,o=0),a=l*o-d*i,c=d*n-u*o,h=u*i-l*n,(f=Math.hypot(a,c,h))?(a*=f=1/f,c*=f,h*=f):(a=0,c=0,h=0),t[0]=n,t[1]=a,t[2]=u,t[3]=0,t[4]=i,t[5]=c,t[6]=l,t[7]=0,t[8]=o,t[9]=h,t[10]=d,t[11]=0,t[12]=-(n*m+i*p+o*g),t[13]=-(a*m+c*p+h*g),t[14]=-(u*m+l*p+d*g),t[15]=1,t)}function Pr(t,e,r){var s=e[0],n=e[1],i=e[2],o=e[3];return t[0]=r[0]*s+r[4]*n+r[8]*i+r[12]*o,t[1]=r[1]*s+r[5]*n+r[9]*i+r[13]*o,t[2]=r[2]*s+r[6]*n+r[10]*i+r[14]*o,t[3]=r[3]*s+r[7]*n+r[11]*i+r[15]*o,t}!function(){var t=function(){var t=new ze(4);return ze!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}()}();const kr=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),Ur=Object.freeze([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Dr=Object.freeze({COL0ROW0:0,COL0ROW1:1,COL0ROW2:2,COL0ROW3:3,COL1ROW0:4,COL1ROW1:5,COL1ROW2:6,COL1ROW3:7,COL2ROW0:8,COL2ROW1:9,COL2ROW2:10,COL2ROW3:11,COL3ROW0:12,COL3ROW1:13,COL3ROW2:14,COL3ROW3:15}),jr={};class Br extends lr{static get IDENTITY(){return jr.IDENTITY=jr.IDENTITY||Object.freeze(new Br(kr)),jr.IDENTITY}static get ZERO(){return jr.ZERO=jr.ZERO||Object.freeze(new Br(Ur)),jr.ZERO}get INDICES(){return Dr}get ELEMENTS(){return 16}get RANK(){return 4}constructor(t){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),1===arguments.length&&Array.isArray(t)?this.copy(t):this.identity()}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3],this[4]=t[4],this[5]=t[5],this[6]=t[6],this[7]=t[7],this[8]=t[8],this[9]=t[9],this[10]=t[10],this[11]=t[11],this[12]=t[12],this[13]=t[13],this[14]=t[14],this[15]=t[15],this.check()}set(t,e,r,s,n,i,o,a,c,h,u,l,d,f,m,p){return this[0]=t,this[1]=e,this[2]=r,this[3]=s,this[4]=n,this[5]=i,this[6]=o,this[7]=a,this[8]=c,this[9]=h,this[10]=u,this[11]=l,this[12]=d,this[13]=f,this[14]=m,this[15]=p,this.check()}setRowMajor(t,e,r,s,n,i,o,a,c,h,u,l,d,f,m,p){return this[0]=t,this[1]=n,this[2]=c,this[3]=d,this[4]=e,this[5]=i,this[6]=h,this[7]=f,this[8]=r,this[9]=o,this[10]=u,this[11]=m,this[12]=s,this[13]=a,this[14]=l,this[15]=p,this.check()}toRowMajor(t){return t[0]=this[0],t[1]=this[4],t[2]=this[8],t[3]=this[12],t[4]=this[1],t[5]=this[5],t[6]=this[9],t[7]=this[13],t[8]=this[2],t[9]=this[6],t[10]=this[10],t[11]=this[14],t[12]=this[3],t[13]=this[7],t[14]=this[11],t[15]=this[15],t}identity(){return this.copy(kr)}fromQuaternion(t){return Ir(this,t),this.check()}frustum({left:t,right:e,bottom:r,top:s,near:n,far:i}){return i===1/0?Br._computeInfinitePerspectiveOffCenter(this,t,e,r,s,n):Nr(this,t,e,r,s,n,i),this.check()}static _computeInfinitePerspectiveOffCenter(t,e,r,s,n,i){const o=2*i/(r-e),a=2*i/(n-s),c=(r+e)/(r-e),h=(n+s)/(n-s),u=-2*i;return t[0]=o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=c,t[9]=h,t[10]=-1,t[11]=-1,t[12]=0,t[13]=0,t[14]=u,t[15]=0,t}lookAt(t,e,r){return 1===arguments.length&&({eye:t,center:e,up:r}=t),Lr(this,t,e=e||[0,0,0],r=r||[0,1,0]),this.check()}ortho({left:t,right:e,bottom:r,top:s,near:n=.1,far:i=500}){return Cr(this,t,e,r,s,n,i),this.check()}orthographic({fovy:t=45*Math.PI/180,aspect:e=1,focalDistance:r=1,near:s=.1,far:n=500}){if(t>2*Math.PI)throw Error("radians");const i=t/2,o=r*Math.tan(i),a=o*e;return(new Br).ortho({left:-a,right:a,bottom:-o,top:o,near:s,far:n})}perspective({fovy:t,fov:e=45*Math.PI/180,aspect:r=1,near:s=.1,far:n=500}={}){if((t=t||e)>2*Math.PI)throw Error("radians");return Rr(this,t,r,s,n),this.check()}determinant(){return Tr(this)}getScale(t=[-0,-0,-0]){return t[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),t[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),t[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),t}getTranslation(t=[-0,-0,-0]){return t[0]=this[12],t[1]=this[13],t[2]=this[14],t}getRotation(t=[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],e=null){const r=this.getScale(e||[-0,-0,-0]),s=1/r[0],n=1/r[1],i=1/r[2];return t[0]=this[0]*s,t[1]=this[1]*n,t[2]=this[2]*i,t[3]=0,t[4]=this[4]*s,t[5]=this[5]*n,t[6]=this[6]*i,t[7]=0,t[8]=this[8]*s,t[9]=this[9]*n,t[10]=this[10]*i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}getRotationMatrix3(t=[-0,-0,-0,-0,-0,-0,-0,-0,-0],e=null){const r=this.getScale(e||[-0,-0,-0]),s=1/r[0],n=1/r[1],i=1/r[2];return t[0]=this[0]*s,t[1]=this[1]*n,t[2]=this[2]*i,t[3]=this[4]*s,t[4]=this[5]*n,t[5]=this[6]*i,t[6]=this[8]*s,t[7]=this[9]*n,t[8]=this[10]*i,t}transpose(){return br(this,this),this.check()}invert(){return _r(this,this),this.check()}multiplyLeft(t){return vr(this,t,this),this.check()}multiplyRight(t){return vr(this,this,t),this.check()}rotateX(t){return Ar(this,this,t),this.check()}rotateY(t){return Mr(this,this,t),this.check()}rotateZ(t){return Or(this,this,t),this.check()}rotateXYZ([t,e,r]){return this.rotateX(t).rotateY(e).rotateZ(r)}rotateAxis(t,e){return xr(this,this,t,e),this.check()}scale(t){return Array.isArray(t)?Sr(this,this,t):Sr(this,this,[t,t,t]),this.check()}translate(t){return Er(this,this,t),this.check()}transform(t,e){return 4===t.length?(je(e=Pr(e||[-0,-0,-0,-0],t,this),4),e):this.transformAsPoint(t,e)}transformAsPoint(t,e){const{length:r}=t;switch(r){case 2:e=$e(e||[-0,-0],t,this);break;case 3:e=tr(e||[-0,-0,-0],t,this);break;default:throw new Error("Illegal vector")}return je(e,t.length),e}transformAsVector(t,e){switch(t.length){case 2:e=We(e||[-0,-0],t,this);break;case 3:e=He(e||[-0,-0,-0],t,this);break;default:throw new Error("Illegal vector")}return je(e,t.length),e}makeRotationX(t){return this.identity().rotateX(t)}makeTranslation(t,e,r){return this.identity().translate([t,e,r])}transformPoint(t,e){return Ve("Matrix4.transformPoint","3.0"),this.transformAsPoint(t,e)}transformVector(t,e){return Ve("Matrix4.transformVector","3.0"),this.transformAsPoint(t,e)}transformDirection(t,e){return Ve("Matrix4.transformDirection","3.0"),this.transformAsVector(t,e)}}function Vr(){var t=new ze(4);return ze!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function Fr(t,e,r){r*=.5;var s=Math.sin(r);return t[0]=s*e[0],t[1]=s*e[1],t[2]=s*e[2],t[3]=Math.cos(r),t}function qr(t,e,r){var s=e[0],n=e[1],i=e[2],o=e[3],a=r[0],c=r[1],h=r[2],u=r[3];return t[0]=s*u+o*a+n*h-i*c,t[1]=n*u+o*c+i*a-s*h,t[2]=i*u+o*h+s*c-n*a,t[3]=o*u-s*a-n*c-i*h,t}function zr(t,e,r,s){var n,i,o,a,c,h=e[0],u=e[1],l=e[2],d=e[3],f=r[0],m=r[1],p=r[2],g=r[3];return(i=h*f+u*m+l*p+d*g)<0&&(i=-i,f=-f,m=-m,p=-p,g=-g),1-i>1e-6?(n=Math.acos(i),o=Math.sin(n),a=Math.sin((1-s)*n)/o,c=Math.sin(s*n)/o):(a=1-s,c=s),t[0]=a*h+c*f,t[1]=a*u+c*m,t[2]=a*l+c*p,t[3]=a*d+c*g,t}function Gr(t,e){var r,s=e[0]+e[4]+e[8];if(s>0)r=Math.sqrt(s+1),t[3]=.5*r,r=.5/r,t[0]=(e[5]-e[7])*r,t[1]=(e[6]-e[2])*r,t[2]=(e[1]-e[3])*r;else{var n=0;e[4]>e[0]&&(n=1),e[8]>e[3*n+n]&&(n=2);var i=(n+1)%3,o=(n+2)%3;r=Math.sqrt(e[3*n+n]-e[3*i+i]-e[3*o+o]+1),t[n]=.5*r,r=.5/r,t[3]=(e[3*i+o]-e[3*o+i])*r,t[i]=(e[3*i+n]+e[3*n+i])*r,t[o]=(e[3*o+n]+e[3*n+o])*r}return t}var $r,Wr,Hr,Qr=function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t},Kr=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t},Yr=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},Zr=function(t,e,r,s){var n=e[0],i=e[1],o=e[2],a=e[3];return t[0]=n+s*(r[0]-n),t[1]=i+s*(r[1]-i),t[2]=o+s*(r[2]-o),t[3]=a+s*(r[3]-a),t},Jr=function(t){var e=t[0],r=t[1],s=t[2],n=t[3];return Math.hypot(e,r,s,n)},Xr=function(t){var e=t[0],r=t[1],s=t[2],n=t[3];return e*e+r*r+s*s+n*n},ts=function(t,e){var r=e[0],s=e[1],n=e[2],i=e[3],o=r*r+s*s+n*n+i*i;return o>0&&(o=1/Math.sqrt(o)),t[0]=r*o,t[1]=s*o,t[2]=n*o,t[3]=i*o,t},es=($r=Ke(),Wr=Ze(1,0,0),Hr=Ze(0,1,0),function(t,e,r){var s=Je(e,r);return s<-.999999?(Xe($r,Wr,e),ar($r)<1e-6&&Xe($r,Hr,e),function(t,e){var r=e[0],s=e[1],n=e[2],i=r*r+s*s+n*n;i>0&&(i=1/Math.sqrt(i)),t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i}($r,$r),Fr(t,$r,Math.PI),t):s>.999999?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(Xe($r,e,r),t[0]=$r[0],t[1]=$r[1],t[2]=$r[2],t[3]=1+s,ts(t,t))});Vr(),Vr(),function(){var t=new ze(9);ze!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1}();const rs=[0,0,0,1];class ss extends Ue{constructor(t=0,e=0,r=0,s=1){super(-0,-0,-0,-0),Array.isArray(t)&&1===arguments.length?this.copy(t):this.set(t,e,r,s)}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3],this.check()}set(t,e,r,s){return this[0]=t,this[1]=e,this[2]=r,this[3]=s,this.check()}fromMatrix3(t){return Gr(this,t),this.check()}identity(){return function(t){t[0]=0,t[1]=0,t[2]=0,t[3]=1}(this),this.check()}fromAxisRotation(t,e){return Fr(this,t,e),this.check()}setAxisAngle(t,e){return this.fromAxisRotation(t,e)}get ELEMENTS(){return 4}get x(){return this[0]}set x(t){this[0]=De(t)}get y(){return this[1]}set y(t){this[1]=De(t)}get z(){return this[2]}set z(t){this[2]=De(t)}get w(){return this[3]}set w(t){this[3]=De(t)}len(){return Jr(this)}lengthSquared(){return Xr(this)}dot(t,e){if(void 0!==e)throw new Error("Quaternion.dot only takes one argument");return Yr(this,t)}rotationTo(t,e){return es(this,t,e),this.check()}add(t,e){if(void 0!==e)throw new Error("Quaternion.add only takes one argument");return Qr(this,this,t),this.check()}calculateW(){return function(t,e){var r=e[0],s=e[1],n=e[2];t[0]=r,t[1]=s,t[2]=n,t[3]=Math.sqrt(Math.abs(1-r*r-s*s-n*n))}(this,this),this.check()}conjugate(){return function(t,e){t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3]}(this,this),this.check()}invert(){return function(t,e){var r=e[0],s=e[1],n=e[2],i=e[3],o=r*r+s*s+n*n+i*i,a=o?1/o:0;t[0]=-r*a,t[1]=-s*a,t[2]=-n*a,t[3]=i*a}(this,this),this.check()}lerp(t,e,r){return Zr(this,t,e,r),this.check()}multiplyRight(t,e){return Ae(!e),qr(this,this,t),this.check()}multiplyLeft(t,e){return Ae(!e),qr(this,t,this),this.check()}normalize(){const t=this.len(),e=t>0?1/t:0;return this[0]=this[0]*e,this[1]=this[1]*e,this[2]=this[2]*e,this[3]=this[3]*e,0===t&&(this[3]=1),this.check()}rotateX(t){return function(t,e,r){r*=.5;var s=e[0],n=e[1],i=e[2],o=e[3],a=Math.sin(r),c=Math.cos(r);t[0]=s*c+o*a,t[1]=n*c+i*a,t[2]=i*c-n*a,t[3]=o*c-s*a}(this,this,t),this.check()}rotateY(t){return function(t,e,r){r*=.5;var s=e[0],n=e[1],i=e[2],o=e[3],a=Math.sin(r),c=Math.cos(r);t[0]=s*c-i*a,t[1]=n*c+o*a,t[2]=i*c+s*a,t[3]=o*c-n*a}(this,this,t),this.check()}rotateZ(t){return function(t,e,r){r*=.5;var s=e[0],n=e[1],i=e[2],o=e[3],a=Math.sin(r),c=Math.cos(r);t[0]=s*c+n*a,t[1]=n*c-s*a,t[2]=i*c+o*a,t[3]=o*c-i*a}(this,this,t),this.check()}scale(t){return Kr(this,this,t),this.check()}slerp(t,e,r){switch(arguments.length){case 1:({start:t=rs,target:e,ratio:r}=arguments[0]);break;case 2:[e,r]=arguments,t=this}return zr(this,t,e,r),this.check()}transformVector4(t,e=t){return function(t,e,r){var s=e[0],n=e[1],i=e[2],o=r[0],a=r[1],c=r[2],h=r[3],u=h*s+a*i-c*n,l=h*n+c*s-o*i,d=h*i+o*n-a*s,f=-o*s-a*n-c*i;t[0]=u*h+f*-o+l*-c-d*-a,t[1]=l*h+f*-a+d*-o-u*-c,t[2]=d*h+f*-c+u*-a-l*-o,t[3]=e[3]}(e,t,this),je(e,4)}lengthSq(){return this.lengthSquared()}setFromAxisAngle(t,e){return this.setAxisAngle(t,e)}premultiply(t,e){return this.multiplyLeft(t,e)}multiply(t,e){return this.multiplyRight(t,e)}}function ns(t,e){if(!t)throw new Error(`math.gl assertion ${e}`)}const is=1/Math.PI*180,os=1/180*Math.PI,as={};function cs(t,{precision:e=as.precision||4}={}){return t=function(t){return Math.round(t/as.EPSILON)*as.EPSILON}(t),`${parseFloat(t.toPrecision(e))}`}function hs(t){return Array.isArray(t)||ArrayBuffer.isView(t)&&!(t instanceof DataView)}function us(t,e,r){if(hs(t)){r=r||((s=t).clone?s.clone():new Array(s.length));for(let s=0;s<r.length&&s<t.length;++s)r[s]=e(t[s],s,r);return r}var s;return e(t)}function ls(t){return function(t,e){return us(t,(t=>t*os),e)}(t)}function ds(t){return function(t,e){return us(t,(t=>t*is),e)}(t)}function fs(t,e,r){const s=as.EPSILON;r&&(as.EPSILON=r);try{if(t===e)return!0;if(hs(t)&&hs(e)){if(t.length!==e.length)return!1;for(let r=0;r<t.length;++r)if(!fs(t[r],e[r]))return!1;return!0}return t&&t.equals?t.equals(e):e&&e.equals?e.equals(t):!(!Number.isFinite(t)||!Number.isFinite(e))&&Math.abs(t-e)<=as.EPSILON*Math.max(1,Math.abs(t),Math.abs(e))}finally{as.EPSILON=s}}as.EPSILON=1e-12,as.debug=!1,as.precision=4,as.printTypes=!1,as.printDegrees=!1,as.printRowMajor=!0;class ms extends(function(t){function e(){var e=Reflect.construct(t,Array.from(arguments));return Object.setPrototypeOf(e,Object.getPrototypeOf(this)),e}return e.prototype=Object.create(t.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t,e}(Array)){get ELEMENTS(){return ns(!1),0}clone(){return(new this.constructor).copy(this)}from(t){return Array.isArray(t)?this.copy(t):this.fromObject(t)}fromArray(t,e=0){for(let r=0;r<this.ELEMENTS;++r)this[r]=t[r+e];return this.check()}to(t){return t===this?this:hs(t)?this.toArray(t):this.toObject(t)}toTarget(t){return t?this.to(t):this}toArray(t=[],e=0){for(let r=0;r<this.ELEMENTS;++r)t[e+r]=this[r];return t}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(as)}formatString(t){let e="";for(let r=0;r<this.ELEMENTS;++r)e+=(r>0?", ":"")+cs(this[r],t);return`${t.printTypes?this.constructor.name:""}[${e}]`}equals(t){if(!t||this.length!==t.length)return!1;for(let e=0;e<this.ELEMENTS;++e)if(!fs(this[e],t[e]))return!1;return!0}exactEquals(t){if(!t||this.length!==t.length)return!1;for(let e=0;e<this.ELEMENTS;++e)if(this[e]!==t[e])return!1;return!0}negate(){for(let t=0;t<this.ELEMENTS;++t)this[t]=-this[t];return this.check()}lerp(t,e,r){void 0===r&&(r=e,e=t,t=this);for(let s=0;s<this.ELEMENTS;++s){const n=t[s];this[s]=n+r*(e[s]-n)}return this.check()}min(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=Math.min(t[e],this[e]);return this.check()}max(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=Math.max(t[e],this[e]);return this.check()}clamp(t,e){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],t[r]),e[r]);return this.check()}add(...t){for(const e of t)for(let t=0;t<this.ELEMENTS;++t)this[t]+=e[t];return this.check()}subtract(...t){for(const e of t)for(let t=0;t<this.ELEMENTS;++t)this[t]-=e[t];return this.check()}scale(t){if(Array.isArray(t))return this.multiply(t);for(let e=0;e<this.ELEMENTS;++e)this[e]*=t;return this.check()}sub(t){return this.subtract(t)}setScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=t;return this.check()}addScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]+=t;return this.check()}subScalar(t){return this.addScalar(-t)}multiplyScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]*=t;return this.check()}divideScalar(t){return this.scale(1/t)}clampScalar(t,e){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],t),e);return this.check()}multiplyByScalar(t){return this.scale(t)}get elements(){return this}check(){if(as.debug&&!this.validate())throw new Error(`math.gl: ${this.constructor.name} some fields set to invalid numbers'`);return this}validate(){let t=this.length===this.ELEMENTS;for(let e=0;e<this.ELEMENTS;++e)t=t&&Number.isFinite(this[e]);return t}}function ps(t){if(!Number.isFinite(t))throw new Error(`Invalid number ${t}`);return t}function gs(t,e,r=""){if(as.debug&&!function(t,e){if(t.length!==e)return!1;for(let e=0;e<t.length;++e)if(!Number.isFinite(t[e]))return!1;return!0}(t,e))throw new Error(`math.gl: ${r} some fields set to invalid numbers'`);return t}const ys={};function ws(t,e){ys[t]||(ys[t]=!0,console.warn(`${t} has been removed in version ${e}, see upgrade guide for more information`))}class bs extends ms{get ELEMENTS(){return ns(!1),0}copy(t){return ns(!1),this}get x(){return this[0]}set x(t){this[0]=ps(t)}get y(){return this[1]}set y(t){this[1]=ps(t)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let t=0;for(let e=0;e<this.ELEMENTS;++e)t+=this[e]*this[e];return t}magnitudeSquared(){return this.lengthSquared()}distance(t){return Math.sqrt(this.distanceSquared(t))}distanceSquared(t){let e=0;for(let r=0;r<this.ELEMENTS;++r){const s=this[r]-t[r];e+=s*s}return ps(e)}dot(t){let e=0;for(let r=0;r<this.ELEMENTS;++r)e+=this[r]*t[r];return ps(e)}normalize(){const t=this.magnitude();if(0!==t)for(let e=0;e<this.ELEMENTS;++e)this[e]/=t;return this.check()}multiply(...t){for(const e of t)for(let t=0;t<this.ELEMENTS;++t)this[t]*=e[t];return this.check()}divide(...t){for(const e of t)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e[t];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(t){return this.distance(t)}distanceToSquared(t){return this.distanceSquared(t)}getComponent(t){return ns(t>=0&&t<this.ELEMENTS,"index is out of range"),ps(this[t])}setComponent(t,e){return ns(t>=0&&t<this.ELEMENTS,"index is out of range"),this[t]=e,this.check()}addVectors(t,e){return this.copy(t).add(e)}subVectors(t,e){return this.copy(t).subtract(e)}multiplyVectors(t,e){return this.copy(t).multiply(e)}addScaledVector(t,e){return this.add(new this.constructor(t).multiplyScalar(e))}}function _s(t,e,r){const s=e[0],n=e[1],i=e[2],o=r[3]*s+r[7]*n+r[11]*i||1;return t[0]=(r[0]*s+r[4]*n+r[8]*i)/o,t[1]=(r[1]*s+r[5]*n+r[9]*i)/o,t[2]=(r[2]*s+r[6]*n+r[10]*i)/o,t}const Ts=[0,0,0],vs={};class Es extends bs{static get ZERO(){return vs.ZERO=vs.ZERO||Object.freeze(new Es(0,0,0,0))}constructor(t=0,e=0,r=0){super(-0,-0,-0),1===arguments.length&&hs(t)?this.copy(t):(as.debug&&(ps(t),ps(e),ps(r)),this[0]=t,this[1]=e,this[2]=r)}set(t,e,r){return this[0]=t,this[1]=e,this[2]=r,this.check()}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this.check()}fromObject(t){return as.debug&&(ps(t.x),ps(t.y),ps(t.z)),this[0]=t.x,this[1]=t.y,this[2]=t.z,this.check()}toObject(t){return t.x=this[0],t.y=this[1],t.z=this[2],t}get ELEMENTS(){return 3}get z(){return this[2]}set z(t){this[2]=ps(t)}angle(t){return or(this,t)}cross(t){return Xe(this,this,t),this.check()}rotateX({radians:t,origin:e=Ts}){return sr(this,this,e,t),this.check()}rotateY({radians:t,origin:e=Ts}){return nr(this,this,e,t),this.check()}rotateZ({radians:t,origin:e=Ts}){return ir(this,this,e,t),this.check()}transform(t){return this.transformAsPoint(t)}transformAsPoint(t){return tr(this,this,t),this.check()}transformAsVector(t){return _s(this,this,t),this.check()}transformByMatrix3(t){return er(this,this,t),this.check()}transformByMatrix2(t){return function(t,e,r){const s=e[0],n=e[1];t[0]=r[0]*s+r[2]*n,t[1]=r[1]*s+r[3]*n,t[2]=e[2]}(this,this,t),this.check()}transformByQuaternion(t){return rr(this,this,t),this.check()}}class Ss extends ms{get ELEMENTS(){return ns(!1),0}get RANK(){return ns(!1),0}toString(){let t="[";if(as.printRowMajor){t+="row-major:";for(let e=0;e<this.RANK;++e)for(let r=0;r<this.RANK;++r)t+=` ${this[r*this.RANK+e]}`}else{t+="column-major:";for(let e=0;e<this.ELEMENTS;++e)t+=` ${this[e]}`}return t+="]",t}getElementIndex(t,e){return e*this.RANK+t}getElement(t,e){return this[e*this.RANK+t]}setElement(t,e,r){return this[e*this.RANK+t]=ps(r),this}getColumn(t,e=new Array(this.RANK).fill(-0)){const r=t*this.RANK;for(let t=0;t<this.RANK;++t)e[t]=this[r+t];return e}setColumn(t,e){const r=t*this.RANK;for(let t=0;t<this.RANK;++t)this[r+t]=e[t];return this}}const xs=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),As=Object.freeze([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Ms=Object.freeze({COL0ROW0:0,COL0ROW1:1,COL0ROW2:2,COL0ROW3:3,COL1ROW0:4,COL1ROW1:5,COL1ROW2:6,COL1ROW3:7,COL2ROW0:8,COL2ROW1:9,COL2ROW2:10,COL2ROW3:11,COL3ROW0:12,COL3ROW1:13,COL3ROW2:14,COL3ROW3:15}),Os={};class Is extends Ss{static get IDENTITY(){return Os.IDENTITY=Os.IDENTITY||Object.freeze(new Is(xs)),Os.IDENTITY}static get ZERO(){return Os.ZERO=Os.ZERO||Object.freeze(new Is(As)),Os.ZERO}get INDICES(){return Ms}get ELEMENTS(){return 16}get RANK(){return 4}constructor(t){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),1===arguments.length&&Array.isArray(t)?this.copy(t):this.identity()}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3],this[4]=t[4],this[5]=t[5],this[6]=t[6],this[7]=t[7],this[8]=t[8],this[9]=t[9],this[10]=t[10],this[11]=t[11],this[12]=t[12],this[13]=t[13],this[14]=t[14],this[15]=t[15],this.check()}set(t,e,r,s,n,i,o,a,c,h,u,l,d,f,m,p){return this[0]=t,this[1]=e,this[2]=r,this[3]=s,this[4]=n,this[5]=i,this[6]=o,this[7]=a,this[8]=c,this[9]=h,this[10]=u,this[11]=l,this[12]=d,this[13]=f,this[14]=m,this[15]=p,this.check()}setRowMajor(t,e,r,s,n,i,o,a,c,h,u,l,d,f,m,p){return this[0]=t,this[1]=n,this[2]=c,this[3]=d,this[4]=e,this[5]=i,this[6]=h,this[7]=f,this[8]=r,this[9]=o,this[10]=u,this[11]=m,this[12]=s,this[13]=a,this[14]=l,this[15]=p,this.check()}toRowMajor(t){return t[0]=this[0],t[1]=this[4],t[2]=this[8],t[3]=this[12],t[4]=this[1],t[5]=this[5],t[6]=this[9],t[7]=this[13],t[8]=this[2],t[9]=this[6],t[10]=this[10],t[11]=this[14],t[12]=this[3],t[13]=this[7],t[14]=this[11],t[15]=this[15],t}identity(){return this.copy(xs)}fromQuaternion(t){return Ir(this,t),this.check()}frustum({left:t,right:e,bottom:r,top:s,near:n,far:i}){return i===1/0?Is._computeInfinitePerspectiveOffCenter(this,t,e,r,s,n):Nr(this,t,e,r,s,n,i),this.check()}static _computeInfinitePerspectiveOffCenter(t,e,r,s,n,i){const o=2*i/(r-e),a=2*i/(n-s),c=(r+e)/(r-e),h=(n+s)/(n-s),u=-2*i;return t[0]=o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=c,t[9]=h,t[10]=-1,t[11]=-1,t[12]=0,t[13]=0,t[14]=u,t[15]=0,t}lookAt(t,e,r){return 1===arguments.length&&({eye:t,center:e,up:r}=t),Lr(this,t,e=e||[0,0,0],r=r||[0,1,0]),this.check()}ortho({left:t,right:e,bottom:r,top:s,near:n=.1,far:i=500}){return Cr(this,t,e,r,s,n,i),this.check()}orthographic({fovy:t=45*Math.PI/180,aspect:e=1,focalDistance:r=1,near:s=.1,far:n=500}){if(t>2*Math.PI)throw Error("radians");const i=t/2,o=r*Math.tan(i),a=o*e;return(new Is).ortho({left:-a,right:a,bottom:-o,top:o,near:s,far:n})}perspective({fovy:t,fov:e=45*Math.PI/180,aspect:r=1,near:s=.1,far:n=500}={}){if((t=t||e)>2*Math.PI)throw Error("radians");return Rr(this,t,r,s,n),this.check()}determinant(){return Tr(this)}getScale(t=[-0,-0,-0]){return t[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),t[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),t[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),t}getTranslation(t=[-0,-0,-0]){return t[0]=this[12],t[1]=this[13],t[2]=this[14],t}getRotation(t=[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],e=null){const r=this.getScale(e||[-0,-0,-0]),s=1/r[0],n=1/r[1],i=1/r[2];return t[0]=this[0]*s,t[1]=this[1]*n,t[2]=this[2]*i,t[3]=0,t[4]=this[4]*s,t[5]=this[5]*n,t[6]=this[6]*i,t[7]=0,t[8]=this[8]*s,t[9]=this[9]*n,t[10]=this[10]*i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}getRotationMatrix3(t=[-0,-0,-0,-0,-0,-0,-0,-0,-0],e=null){const r=this.getScale(e||[-0,-0,-0]),s=1/r[0],n=1/r[1],i=1/r[2];return t[0]=this[0]*s,t[1]=this[1]*n,t[2]=this[2]*i,t[3]=this[4]*s,t[4]=this[5]*n,t[5]=this[6]*i,t[6]=this[8]*s,t[7]=this[9]*n,t[8]=this[10]*i,t}transpose(){return br(this,this),this.check()}invert(){return _r(this,this),this.check()}multiplyLeft(t){return vr(this,t,this),this.check()}multiplyRight(t){return vr(this,this,t),this.check()}rotateX(t){return Ar(this,this,t),this.check()}rotateY(t){return Mr(this,this,t),this.check()}rotateZ(t){return Or(this,this,t),this.check()}rotateXYZ([t,e,r]){return this.rotateX(t).rotateY(e).rotateZ(r)}rotateAxis(t,e){return xr(this,this,t,e),this.check()}scale(t){return Array.isArray(t)?Sr(this,this,t):Sr(this,this,[t,t,t]),this.check()}translate(t){return Er(this,this,t),this.check()}transform(t,e){return 4===t.length?(gs(e=Pr(e||[-0,-0,-0,-0],t,this),4),e):this.transformAsPoint(t,e)}transformAsPoint(t,e){const{length:r}=t;switch(r){case 2:e=$e(e||[-0,-0],t,this);break;case 3:e=tr(e||[-0,-0,-0],t,this);break;default:throw new Error("Illegal vector")}return gs(e,t.length),e}transformAsVector(t,e){switch(t.length){case 2:e=function(t,e,r){const s=e[0],n=e[1],i=r[3]*s+r[7]*n||1;return t[0]=(r[0]*s+r[4]*n)/i,t[1]=(r[1]*s+r[5]*n)/i,t}(e||[-0,-0],t,this);break;case 3:e=_s(e||[-0,-0,-0],t,this);break;default:throw new Error("Illegal vector")}return gs(e,t.length),e}makeRotationX(t){return this.identity().rotateX(t)}makeTranslation(t,e,r){return this.identity().translate([t,e,r])}transformPoint(t,e){return ws("Matrix4.transformPoint","3.0"),this.transformAsPoint(t,e)}transformVector(t,e){return ws("Matrix4.transformVector","3.0"),this.transformAsPoint(t,e)}transformDirection(t,e){return ws("Matrix4.transformDirection","3.0"),this.transformAsVector(t,e)}}var Ns=.1,Rs=1e-12,Cs=1e-15;Math.PI,Math.PI,Math.PI,Math.PI;const Ls=t=>t,Ps=new Es;function ks(t,e=Ps){return function(t,e,r=Ls){return hs(t)?(e[0]=r(t[0]),e[1]=r(t[1]),e[2]=t[2]):"longitude"in t?(e[0]=r(t.longitude),e[1]=r(t.latitude),e[2]=t.height):(e[0]=r(t.x),e[1]=r(t.y),e[2]=t.z),e}(t,e,as._cartographicRadians?Ls:ls)}function Us(t,e){return function(t,e,r=Ls){return hs(e)?(e[0]=r(t[0]),e[1]=r(t[1]),e[2]=t[2]):"longitude"in e?(e.longitude=r(t[0]),e.latitude=r(t[1]),e.height=t[2]):(e.x=r(t[0]),e.y=r(t[1]),e.z=t[2]),e}(t,e,as._cartographicRadians?Ls:ds)}const Ds=new Es,js=new Es,Bs=new Es;const Vs=new Es,Fs={up:{south:"east",north:"west",west:"south",east:"north"},down:{south:"west",north:"east",west:"north",east:"south"},south:{up:"west",down:"east",west:"down",east:"up"},north:{up:"east",down:"west",west:"up",east:"down"},west:{up:"north",down:"south",north:"down",south:"up"},east:{up:"south",down:"north",north:"up",south:"down"}},qs={north:[-1,0,0],east:[0,1,0],up:[0,0,1],south:[1,0,0],west:[0,-1,0],down:[0,0,-1]},zs={east:new Es,north:new Es,up:new Es,west:new Es,south:new Es,down:new Es},Gs=new Es,$s=new Es,Ws=new Es;function Hs(t,e,r,s,n,i){const o=Fs[e]&&Fs[e][r];let a,c,h;ns(o&&(!s||s===o));const u=Vs.copy(n);if(fs(u.x,0,1e-14)&&fs(u.y,0,1e-14)){const t=Math.sign(u.z);a=Gs.fromArray(qs[e]),"east"!==e&&"west"!==e&&a.scale(t),c=$s.fromArray(qs[r]),"east"!==r&&"west"!==r&&c.scale(t),h=Ws.fromArray(qs[s]),"east"!==s&&"west"!==s&&h.scale(t)}else{const{up:n,east:i,north:o}=zs;i.set(-u.y,u.x,0).normalize(),t.geodeticSurfaceNormal(u,n),o.copy(n).cross(i);const{down:l,west:d,south:f}=zs;l.copy(n).scale(-1),d.copy(i).scale(-1),f.copy(o).scale(-1),a=zs[e],c=zs[r],h=zs[s]}return i[0]=a.x,i[1]=a.y,i[2]=a.z,i[3]=0,i[4]=c.x,i[5]=c.y,i[6]=c.z,i[7]=0,i[8]=h.x,i[9]=h.y,i[10]=h.z,i[11]=0,i[12]=u.x,i[13]=u.y,i[14]=u.z,i[15]=1,i}const Qs=new Es,Ks=new Es,Ys=new Es,Zs=new Es,Js=new Es,Xs=new Es;let tn;class en{static get WGS84(){return tn=tn||new en(6378137,6378137,6356752.314245179),tn}constructor(t=0,e=0,r=0){ns(t>=0),ns(e>=0),ns(r>=0),this.radii=new Es(t,e,r),this.radiiSquared=new Es(t*t,e*e,r*r),this.radiiToTheFourth=new Es(t*t*t*t,e*e*e*e,r*r*r*r),this.oneOverRadii=new Es(0===t?0:1/t,0===e?0:1/e,0===r?0:1/r),this.oneOverRadiiSquared=new Es(0===t?0:1/(t*t),0===e?0:1/(e*e),0===r?0:1/(r*r)),this.minimumRadius=Math.min(t,e,r),this.maximumRadius=Math.max(t,e,r),this.centerToleranceSquared=Ns,0!==this.radiiSquared.z&&(this.squaredXOverSquaredZ=this.radiiSquared.x/this.radiiSquared.z),Object.freeze(this)}equals(t){return this===t||Boolean(t&&this.radii.equals(t.radii))}toString(){return this.radii.toString()}cartographicToCartesian(t,e=[0,0,0]){const r=Ks,s=Ys,[,,n]=t;this.geodeticSurfaceNormalCartographic(t,r),s.copy(this.radiiSquared).scale(r);const i=Math.sqrt(r.dot(s));return s.scale(1/i),r.scale(n),s.add(r),s.to(e)}cartesianToCartographic(t,e=[0,0,0]){Xs.from(t);const r=this.scaleToGeodeticSurface(Xs,Zs);if(!r)return;const s=this.geodeticSurfaceNormal(r,Ks),n=Js;n.copy(Xs).subtract(r);return Us([Math.atan2(s.y,s.x),Math.asin(s.z),Math.sign(Je(n,Xs))*Ye(n)],e)}eastNorthUpToFixedFrame(t,e=new Is){return Hs(this,"east","north","up",t,e)}localFrameToFixedFrame(t,e,r,s,n=new Is){return Hs(this,t,e,r,s,n)}geocentricSurfaceNormal(t,e=[0,0,0]){return Qs.from(t).normalize().to(e)}geodeticSurfaceNormalCartographic(t,e=[0,0,0]){const r=ks(t),s=r[0],n=r[1],i=Math.cos(n);return Qs.set(i*Math.cos(s),i*Math.sin(s),Math.sin(n)).normalize(),Qs.to(e)}geodeticSurfaceNormal(t,e=[0,0,0]){return Qs.from(t).scale(this.oneOverRadiiSquared).normalize().to(e)}scaleToGeodeticSurface(t,e){return function(t,e,r=new Es){const{oneOverRadii:s,oneOverRadiiSquared:n,centerToleranceSquared:i}=e;Ds.from(t);const o=t.x,a=t.y,c=t.z,h=s.x,u=s.y,l=s.z,d=o*o*h*h,f=a*a*u*u,m=c*c*l*l,p=d+f+m,g=Math.sqrt(1/p);if(!Number.isFinite(g))return;const y=js;if(y.copy(t).scale(g),p<i)return y.to(r);const w=n.x,b=n.y,_=n.z,T=Bs;T.set(y.x*w*2,y.y*b*2,y.z*_*2);let v,E,S,x,A=(1-g)*t.len()/(.5*T.len()),M=0;do{A-=M,v=1/(1+A*w),E=1/(1+A*b),S=1/(1+A*_);const t=v*v,e=E*E,r=S*S;x=d*t+f*e+m*r-1,M=x/(-2*(d*(t*v)*w+f*(e*E)*b+m*(r*S)*_))}while(Math.abs(x)>Rs);return Ds.scale([v,E,S]).to(r)}(t,this,e)}scaleToGeocentricSurface(t,e=[0,0,0]){Zs.from(t);const r=Zs.x,s=Zs.y,n=Zs.z,i=this.oneOverRadiiSquared,o=1/Math.sqrt(r*r*i.x+s*s*i.y+n*n*i.z);return Zs.multiplyScalar(o).to(e)}transformPositionToScaledSpace(t,e=[0,0,0]){return Zs.from(t).scale(this.oneOverRadii).to(e)}transformPositionFromScaledSpace(t,e=[0,0,0]){return Zs.from(t).scale(this.radii).to(e)}getSurfaceNormalIntersectionWithZAxis(t,e=0,r=[0,0,0]){ns(fs(this.radii.x,this.radii.y,Cs)),ns(this.radii.z>0),Zs.from(t);const s=Zs.z*(1-this.squaredXOverSquaredZ);if(!(Math.abs(s)>=this.radii.z-e))return Zs.set(0,0,s).to(r)}}class rn{constructor(t,e,r){this.item=t,this.previous=e,this.next=r}}class sn{constructor(){this.head=null,this.tail=null,this._length=0}get length(){return this._length}add(t){const e=new rn(t,this.tail,null);return this.tail?(this.tail.next=e,this.tail=e):(this.head=e,this.tail=e),++this._length,e}remove(t){t&&(t.previous&&t.next?(t.previous.next=t.next,t.next.previous=t.previous):t.previous?(t.previous.next=null,this.tail=t.previous):t.next?(t.next.previous=null,this.head=t.next):(this.head=null,this.tail=null),t.next=null,t.previous=null,--this._length)}splice(t,e){t!==e&&(this.remove(e),this._insert(t,e))}_insert(t,e){const r=t.next;t.next=e,this.tail===t?this.tail=e:r.previous=e,e.next=r,e.previous=t,++this._length}}function nn(t){return null!=t}class on{constructor(){B(this,"_list",void 0),B(this,"_sentinel",void 0),B(this,"_trimTiles",void 0),this._list=new sn,this._sentinel=this._list.add("sentinel"),this._trimTiles=!1}reset(){this._list.splice(this._list.tail,this._sentinel)}touch(t){const e=t._cacheNode;nn(e)&&this._list.splice(this._sentinel,e)}add(t,e,r){nn(e._cacheNode)||(e._cacheNode=this._list.add(e),r&&r(t,e))}unloadTile(t,e,r){const s=e._cacheNode;nn(s)&&(this._list.remove(s),e._cacheNode=void 0,r&&r(t,e))}unloadTiles(t,e){const r=this._trimTiles;this._trimTiles=!1;const s=this._list,n=1024*t.maximumMemoryUsage*1024,i=this._sentinel;let o=s.head;for(;o!==i&&(t.gpuMemoryUsageInBytes>n||r);){const r=o.item;o=o.next,this.unloadTile(t,r,e)}}trim(){this._trimTiles=!0}}const an=Object.freeze({OUTSIDE:-1,INTERSECTING:0,INSIDE:1});new ur,new ur;const cn=new ur,hn=new ur;class un{constructor(t=[0,0,0],e=0){this.radius=-0,this.center=new ur,this.fromCenterRadius(t,e)}fromCenterRadius(t,e){return this.center.from(t),this.radius=e,this}fromCornerPoints(t,e){return e=cn.from(e),this.center=(new ur).from(t).add(e).scale(.5),this.radius=this.center.distance(e),this}equals(t){return this===t||Boolean(t)&&this.center.equals(t.center)&&this.radius===t.radius}clone(){return new un(this.center,this.radius)}union(t){const e=this.center,r=this.radius,s=t.center,n=t.radius,i=cn.copy(s).subtract(e),o=i.magnitude();if(r>=o+n)return this.clone();if(n>=o+r)return t.clone();const a=.5*(r+o+n);return hn.copy(i).scale((-r+a)/o).add(e),this.center.copy(hn),this.radius=a,this}expand(t){const e=(t=cn.from(t)).subtract(this.center).magnitude();return e>this.radius&&(this.radius=e),this}transform(t){this.center.transform(t);const e=function(t,e){var r=e[0],s=e[1],n=e[2],i=e[4],o=e[5],a=e[6],c=e[8],h=e[9],u=e[10];return t[0]=Math.hypot(r,s,n),t[1]=Math.hypot(i,o,a),t[2]=Math.hypot(c,h,u),t}(cn,t);return this.radius=Math.max(e[0],Math.max(e[1],e[2]))*this.radius,this}distanceSquaredTo(t){return(t=cn.from(t)).subtract(this.center).lengthSquared()-this.radius*this.radius}distanceTo(t){return Math.sqrt(this.distanceSquaredTo(t))}intersectPlane(t){const e=this.center,r=this.radius,s=t.normal.dot(e)+t.distance;return s<-r?an.OUTSIDE:s<r?an.INTERSECTING:an.INSIDE}}const ln=new ur,dn=new ur,fn=new ur,mn=new ur,pn=new ur,gn=new ur,yn=new ur,wn=0,bn=1,_n=2,Tn=3,vn=4,En=5,Sn=6,xn=7,An=8;class Mn{constructor(t=[0,0,0],e=[0,0,0,0,0,0,0,0,0]){this.center=(new ur).from(t),this.halfAxes=new wr(e)}get halfSize(){const t=this.halfAxes.getColumn(0),e=this.halfAxes.getColumn(1),r=this.halfAxes.getColumn(2);return[new ur(t).len(),new ur(e).len(),new ur(r).len()]}get quaternion(){const t=this.halfAxes.getColumn(0),e=this.halfAxes.getColumn(1),r=this.halfAxes.getColumn(2),s=new ur(t).normalize(),n=new ur(e).normalize(),i=new ur(r).normalize();return(new ss).fromMatrix3(new wr([...s,...n,...i]))}fromCenterHalfSizeQuaternion(t,e,r){const s=new ss(r),n=(new wr).fromQuaternion(s);return n[0]=n[0]*e[0],n[1]=n[1]*e[0],n[2]=n[2]*e[0],n[3]=n[3]*e[1],n[4]=n[4]*e[1],n[5]=n[5]*e[1],n[6]=n[6]*e[2],n[7]=n[7]*e[2],n[8]=n[8]*e[2],this.center=(new ur).from(t),this.halfAxes=n,this}clone(){return new Mn(this.center,this.halfAxes)}equals(t){return this===t||Boolean(t)&&this.center.equals(t.center)&&this.halfAxes.equals(t.halfAxes)}getBoundingSphere(t=new un){const e=this.halfAxes,r=e.getColumn(0,fn),s=e.getColumn(1,mn),n=e.getColumn(2,pn),i=ln.copy(r).add(s).add(n);return t.center.copy(this.center),t.radius=i.magnitude(),t}intersectPlane(t){const e=this.center,r=t.normal,s=this.halfAxes,n=r.x,i=r.y,o=r.z,a=Math.abs(n*s[wn]+i*s[bn]+o*s[_n])+Math.abs(n*s[Tn]+i*s[vn]+o*s[En])+Math.abs(n*s[Sn]+i*s[xn]+o*s[An]),c=r.dot(e)+t.distance;return c<=-a?an.OUTSIDE:c>=a?an.INSIDE:an.INTERSECTING}distanceTo(t){return Math.sqrt(this.distanceSquaredTo(t))}distanceSquaredTo(t){const e=dn.from(t).subtract(this.center),r=this.halfAxes,s=r.getColumn(0,fn),n=r.getColumn(1,mn),i=r.getColumn(2,pn),o=s.magnitude(),a=n.magnitude(),c=i.magnitude();s.normalize(),n.normalize(),i.normalize();let h,u=0;return h=Math.abs(e.dot(s))-o,h>0&&(u+=h*h),h=Math.abs(e.dot(n))-a,h>0&&(u+=h*h),h=Math.abs(e.dot(i))-c,h>0&&(u+=h*h),u}computePlaneDistances(t,e,r=[-0,-0]){let s=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY;const i=this.center,o=this.halfAxes,a=o.getColumn(0,fn),c=o.getColumn(1,mn),h=o.getColumn(2,pn),u=gn.copy(a).add(c).add(h).add(i),l=yn.copy(u).subtract(t);let d=e.dot(l);return s=Math.min(d,s),n=Math.max(d,n),u.copy(i).add(a).add(c).subtract(h),l.copy(u).subtract(t),d=e.dot(l),s=Math.min(d,s),n=Math.max(d,n),u.copy(i).add(a).subtract(c).add(h),l.copy(u).subtract(t),d=e.dot(l),s=Math.min(d,s),n=Math.max(d,n),u.copy(i).add(a).subtract(c).subtract(h),l.copy(u).subtract(t),d=e.dot(l),s=Math.min(d,s),n=Math.max(d,n),i.copy(u).subtract(a).add(c).add(h),l.copy(u).subtract(t),d=e.dot(l),s=Math.min(d,s),n=Math.max(d,n),i.copy(u).subtract(a).add(c).subtract(h),l.copy(u).subtract(t),d=e.dot(l),s=Math.min(d,s),n=Math.max(d,n),i.copy(u).subtract(a).subtract(c).add(h),l.copy(u).subtract(t),d=e.dot(l),s=Math.min(d,s),n=Math.max(d,n),i.copy(u).subtract(a).subtract(c).subtract(h),l.copy(u).subtract(t),d=e.dot(l),s=Math.min(d,s),n=Math.max(d,n),r[0]=s,r[1]=n,r}transform(t){this.center.transformAsPoint(t);const e=this.halfAxes.getColumn(0,fn);e.transformAsPoint(t);const r=this.halfAxes.getColumn(1,mn);r.transformAsPoint(t);const s=this.halfAxes.getColumn(2,pn);return s.transformAsPoint(t),this.halfAxes=new wr([...e,...r,...s]),this}getTransform(){throw new Error("not implemented")}}const On=new ur,In=new ur;class Nn{constructor(t=[0,0,1],e=0){this.normal=new ur,this.distance=-0,this.fromNormalDistance(t,e)}fromNormalDistance(t,e){return Ae(Number.isFinite(e)),this.normal.from(t).normalize(),this.distance=e,this}fromPointNormal(t,e){t=On.from(t),this.normal.from(e).normalize();const r=-this.normal.dot(t);return this.distance=r,this}fromCoefficients(t,e,r,s){return this.normal.set(t,e,r),Ae(ke(this.normal.len(),1)),this.distance=s,this}clone(t){return new Nn(this.normal,this.distance)}equals(t){return ke(this.distance,t.distance)&&ke(this.normal,t.normal)}getPointDistance(t){return this.normal.dot(t)+this.distance}transform(t){const e=In.copy(this.normal).transformAsVector(t).normalize(),r=this.normal.scale(-this.distance).transform(t);return this.fromPointNormal(r,e)}projectPointOntoPlane(t,e=[0,0,0]){t=On.from(t);const r=this.getPointDistance(t),s=In.copy(this.normal).scale(r);return t.subtract(s).to(e)}}const Rn=[new ur([1,0,0]),new ur([0,1,0]),new ur([0,0,1])],Cn=new ur,Ln=new ur;new Nn(new ur(1,0,0),0);class Pn{static get MASK_OUTSIDE(){return 4294967295}static get MASK_INSIDE(){return 0}static get MASK_INDETERMINATE(){return 2147483647}constructor(t=[]){this.planes=t,Ae(this.planes.every((t=>t instanceof Nn)))}fromBoundingSphere(t){this.planes.length=2*Rn.length;const e=t.center,r=t.radius;let s=0;for(const t of Rn){let n=this.planes[s],i=this.planes[s+1];n||(n=this.planes[s]=new Nn),i||(i=this.planes[s+1]=new Nn);const o=Cn.copy(t).scale(-r).add(e);t.dot(o),n.fromPointNormal(o,t);const a=Cn.copy(t).scale(r).add(e),c=Ln.copy(t).negate();c.dot(a),i.fromPointNormal(a,c),s+=2}return this}computeVisibility(t){Ae(t);let e=an.INSIDE;for(const r of this.planes){switch(t.intersectPlane(r)){case an.OUTSIDE:return an.OUTSIDE;case an.INTERSECTING:e=an.INTERSECTING}}return e}computeVisibilityWithPlaneMask(t,e){if(Ae(t,"boundingVolume is required."),Ae(Number.isFinite(e),"parentPlaneMask is required."),e===Pn.MASK_OUTSIDE||e===Pn.MASK_INSIDE)return e;let r=Pn.MASK_INSIDE;const s=this.planes;for(let n=0;n<this.planes.length;++n){const i=n<31?1<<n:0;if(n<31&&0==(e&i))continue;const o=s[n],a=t.intersectPlane(o);if(a===an.OUTSIDE)return Pn.MASK_OUTSIDE;a===an.INTERSECTING&&(r|=i)}return r}}const kn=new ur,Un=new ur,Dn=new ur,jn=new ur,Bn=new ur;class Vn{constructor(t={}){t={near:1,far:5e8,...t},this.left=t.left,this._left=void 0,this.right=t.right,this._right=void 0,this.top=t.top,this._top=void 0,this.bottom=t.bottom,this._bottom=void 0,this.near=t.near,this._near=this.near,this.far=t.far,this._far=this.far,this._cullingVolume=new Pn([new Nn,new Nn,new Nn,new Nn,new Nn,new Nn]),this._perspectiveMatrix=new Br,this._infinitePerspective=new Br}clone(){return new Vn({right:this.right,left:this.left,top:this.top,bottom:this.bottom,near:this.near,far:this.far})}equals(t){return t&&t instanceof Vn&&this.right===t.right&&this.left===t.left&&this.top===t.top&&this.bottom===t.bottom&&this.near===t.near&&this.far===t.far}get projectionMatrix(){return Fn(this),this._perspectiveMatrix}get infiniteProjectionMatrix(){return Fn(this),this._infinitePerspective}computeCullingVolume(t,e,r){Ae(t,"position is required."),Ae(e,"direction is required."),Ae(r,"up is required.");const s=this._cullingVolume.planes;r=kn.copy(r).normalize();const n=Un.copy(e).cross(r).normalize(),i=Dn.copy(e).multiplyByScalar(this.near).add(t),o=jn.copy(e).multiplyByScalar(this.far).add(t);let a=Bn;return a.copy(n).multiplyByScalar(this.left).add(i).subtract(t).cross(r),s[0].fromPointNormal(t,a),a.copy(n).multiplyByScalar(this.right).add(i).subtract(t).cross(r).negate(),s[1].fromPointNormal(t,a),a.copy(r).multiplyByScalar(this.bottom).add(i).subtract(t).cross(n).negate(),s[2].fromPointNormal(t,a),a.copy(r).multiplyByScalar(this.top).add(i).subtract(t).cross(n),s[3].fromPointNormal(t,a),a=(new ur).copy(e),s[4].fromPointNormal(i,a),a.negate(),s[5].fromPointNormal(o,a),this._cullingVolume}getPixelDimensions(t,e,r,s){Fn(this),Ae(Number.isFinite(t)&&Number.isFinite(e)),Ae(t>0),Ae(e>0),Ae(r>0),Ae(s);const n=1/this.near;let i=this.top*n;const o=2*r*i/e;i=this.right*n;const a=2*r*i/t;return s.x=a,s.y=o,s}}function Fn(t){Ae(Number.isFinite(t.right)&&Number.isFinite(t.left)&&Number.isFinite(t.top)&&Number.isFinite(t.bottom)&&Number.isFinite(t.near)&&Number.isFinite(t.far));const{top:e,bottom:r,right:s,left:n,near:i,far:o}=t;e===t._top&&r===t._bottom&&n===t._left&&s===t._right&&i===t._near&&o===t._far||(Ae(t.near>0&&t.near<t.far,"near must be greater than zero and less than far."),t._left=n,t._right=s,t._top=e,t._bottom=r,t._near=i,t._far=o,t._perspectiveMatrix=(new Br).frustum({left:n,right:s,bottom:r,top:e,near:i,far:o}),t._infinitePerspective=(new Br).frustum({left:n,right:s,bottom:r,top:e,near:i,far:1/0}))}class qn{constructor(t={}){t={near:1,far:5e8,xOffset:0,yOffset:0,...t},this._offCenterFrustum=new Vn,this.fov=t.fov,this._fov=void 0,this._fovy=void 0,this._sseDenominator=void 0,this.aspectRatio=t.aspectRatio,this._aspectRatio=void 0,this.near=t.near,this._near=this.near,this.far=t.far,this._far=this.far,this.xOffset=t.xOffset,this._xOffset=this.xOffset,this.yOffset=t.yOffset,this._yOffset=this.yOffset}clone(){return new qn({aspectRatio:this.aspectRatio,fov:this.fov,near:this.near,far:this.far})}equals(t){return null!=t&&t instanceof qn&&(zn(this),zn(t),this.fov===t.fov&&this.aspectRatio===t.aspectRatio&&this.near===t.near&&this.far===t.far&&this._offCenterFrustum.equals(t._offCenterFrustum))}get projectionMatrix(){return zn(this),this._offCenterFrustum.projectionMatrix}get infiniteProjectionMatrix(){return zn(this),this._offCenterFrustum.infiniteProjectionMatrix}get fovy(){return zn(this),this._fovy}get sseDenominator(){return zn(this),this._sseDenominator}computeCullingVolume(t,e,r){return zn(this),this._offCenterFrustum.computeCullingVolume(t,e,r)}getPixelDimensions(t,e,r,s){return zn(this),this._offCenterFrustum.getPixelDimensions(t,e,r,s)}}function zn(t){Ae(Number.isFinite(t.fov)&&Number.isFinite(t.aspectRatio)&&Number.isFinite(t.near)&&Number.isFinite(t.far));const e=t._offCenterFrustum;t.fov===t._fov&&t.aspectRatio===t._aspectRatio&&t.near===t._near&&t.far===t._far&&t.xOffset===t._xOffset&&t.yOffset===t._yOffset||(Ae(t.fov>=0&&t.fov<Math.PI),Ae(t.aspectRatio>0),Ae(t.near>=0&&t.near<t.far),t._aspectRatio=t.aspectRatio,t._fov=t.fov,t._fovy=t.aspectRatio<=1?t.fov:2*Math.atan(Math.tan(.5*t.fov)/t.aspectRatio),t._near=t.near,t._far=t.far,t._sseDenominator=2*Math.tan(.5*t._fovy),t._xOffset=t.xOffset,t._yOffset=t.yOffset,e.top=t.near*Math.tan(.5*t._fovy),e.bottom=-e.top,e.right=t.aspectRatio*e.top,e.left=-e.right,e.near=t.near,e.far=t.far,e.right+=t.xOffset,e.left+=t.xOffset,e.top+=t.yOffset,e.bottom+=t.yOffset)}new ur,new ur,new ur,new ur,new ur,new ur,new ur,new ur,new ur,new ur,new ur,new ur,new wr,new wr,new wr,new wr,new wr,new ur,new ur,new ur,new ur,new ur,new wr,new wr,new wr;const Gn=new ur,$n=new ur,Wn=new Pn([new Nn,new Nn,new Nn,new Nn,new Nn,new Nn]);function Hn(t,e){const{cameraDirection:r,cameraUp:s,height:n}=t,{metersPerUnit:i}=t.distanceScales,o=[t.longitude,t.latitude,0],a=en.WGS84.cartographicToCartesian(o,new ur),c=en.WGS84.eastNorthUpToFixedFrame(a),h=t.unprojectPosition(t.cameraPosition),u=en.WGS84.cartographicToCartesian(h,new ur),l=new ur(c.transformAsVector(new ur(r).scale(i))).normalize(),d=new ur(c.transformAsVector(new ur(s).scale(i))).normalize();return function(t,e){const r=t.getFrustumPlanes();let s=0;for(const n in r){const i=r[n],o=i.normal.dot(t.center);$n.copy(i.normal).scale(i.distance-o).add(t.center);const a=t.unprojectPosition($n),c=en.WGS84.cartographicToCartesian(a,new ur);Wn.planes[s++].fromPointNormal(c,Gn.copy(e).subtract(c))}}(t,a),{camera:{position:u,direction:l,up:d},viewport:t,height:n,cullingVolume:Wn,frameNumber:e,sseDenominator:1.15}}const Qn=new ur;function Kn(t){const{halfAxes:e,radius:r,width:s,height:n}=t;if(e){const t=function(t){t.getColumn(0,Qn);const e=t.getColumn(1),r=t.getColumn(2),s=Qn.add(e).add(r);return s.len()}(e);return Math.log2(6356752.314245179/t)}if(r)return Math.log2(6356752.314245179/r);if(n&&s){return(Math.log2(6378137/s)+Math.log2(6378137/n))/2}return 1}const Yn=0,Zn=1,Jn=3,Xn=4,ti=5,ei=1,ri=2,si="empty",ni="scenegraph",ii="pointcloud",oi="mesh",ai="I3S",ci="TILES3D",hi="geometricError",ui=1;function li(t){return null!=t}const di=new ur,fi=new ur,mi=new ur;function pi(t,e,r){if(M(t,"3D Tile: boundingVolume must be defined"),t.box)return function(t,e,r){const s=new ur(t[0],t[1],t[2]);e.transform(s,s);let n=[];if(10===t.length){const e=t.slice(3,6),r=new ss;r.fromArray(t,6);const s=new ur([1,0,0]),i=new ur([0,1,0]),o=new ur([0,0,1]);s.transformByQuaternion(r),s.scale(e[0]),i.transformByQuaternion(r),i.scale(e[1]),o.transformByQuaternion(r),o.scale(e[2]),n=[...s.toArray(),...i.toArray(),...o.toArray()]}else n=[...t.slice(3,6),...t.slice(6,9),...t.slice(9,12)];const i=e.transformAsVector(n.slice(0,3)),o=e.transformAsVector(n.slice(3,6)),a=e.transformAsVector(n.slice(6,9)),c=new wr([i[0],i[1],i[2],o[0],o[1],o[2],a[0],a[1],a[2]]);if(li(r))return r.center=s,r.halfAxes=c,r;return new Mn(s,c)}(t.box,e,r);if(t.region){const[e,r,s,n,i,o]=t.region,a=en.WGS84.cartographicToCartesian([Pe(e),Pe(n),i],fi),c=en.WGS84.cartographicToCartesian([Pe(s),Pe(r),o],mi),h=(new ur).addVectors(a,c).multiplyScalar(.5),u=(new ur).subVectors(a,c).len()/2;return gi([h[0],h[1],h[2],u],new Br)}if(t.sphere)return gi(t.sphere,e,r);throw new Error("3D Tile: boundingVolume must contain a sphere, region, or box")}function gi(t,e,r){const s=new ur(t[0],t[1],t[2]);e.transform(s,s);const n=e.getScale(di),i=Math.max(Math.max(n[0],n[1]),n[2]),o=t[3]*i;return li(r)?(r.center=s,r.radius=o,r):new un(s,o)}function yi(t,e){if(t.dynamicScreenSpaceError&&t.dynamicScreenSpaceErrorComputedDensity){const r=t.dynamicScreenSpaceErrorComputedDensity,s=t.dynamicScreenSpaceErrorFactor;return function(t,e){const r=t*e;return 1-Math.exp(-r*r)}(e,r)*s}return 0}new ur,new ur,new Br,new ur,new ur,new ur;const wi=Math.PI/2;function bi([t,e,r]){const s=Le(t),n=Le(e),i=1+r/6378137,o=i*Math.cos(n);return[t=o*Math.cos(s),e=o*Math.sin(s),r=i*Math.sin(n)]}function _i(t,e){const[r,s,n=0]=t,[i,o,a=0]=e,c=bi([i,o,a]),h=bi([r,s,n]),u=h[0]-c[0],l=h[1]-c[1],d=h[2]-c[2];return u*u+l*l+d*d}function Ti(t,e){const r=e.viewport,s=t.header.mbs[1],n=[t.header.mbs[0],s,t.header.mbs[2]],i=t.header.mbs[3]/6378137,o=_i(r.unprojectPosition(r.cameraPosition),n)-i*i;if(o<=0)return 170141175e30;return function(t){const{projectionMatrix:e}=t.viewport;return e[5]}(e)*i/Math.sqrt(o)*300}class vi{constructor(t=0){this._array=new Array(t),this._map=new Map,this._length=t}get length(){return this._length}set length(t){this._length=t,t>this._array.length&&(this._array.length=t)}get values(){return this._array}get(t){return M(t<this._array.length),this._array[t]}set(t,e){M(t>=0),t>=this.length&&(this.length=t+1),this._map.has(this._array[t])&&this._map.delete(this._array[t]),this._array[t]=e,this._map.set(e,t)}delete(t){const e=this._map.get(t);e>=0&&(this._array.splice(e,1),this._map.delete(t),this.length--)}peek(){return this._array[this._length-1]}push(t){if(!this._map.has(t)){const e=this.length++;this._array[e]=t,this._map.set(t,e)}}pop(){const t=this._array[--this.length];return this._map.delete(t),t}reserve(t){M(t>=0),t>this._array.length&&(this._array.length=t)}resize(t){M(t>=0),this.length=t}trim(t){null==t&&(t=this.length),this._array.length=t}reset(){this._array=[],this._map=new Map,this._length=0}find(t){return this._map.has(t)}}const Ei={loadSiblings:!1,skipLevelOfDetail:!1,maximumScreenSpaceError:2,updateTransforms:!0,onTraversalEnd:()=>{},viewportTraversersMap:{},basePath:""};class Si{constructor(t){B(this,"options",void 0),B(this,"root",void 0),B(this,"requestedTiles",void 0),B(this,"selectedTiles",void 0),B(this,"emptyTiles",void 0),B(this,"_traversalStack",void 0),B(this,"_emptyTraversalStack",void 0),B(this,"_frameNumber",void 0),this.options={...Ei,...t},this._traversalStack=new vi,this._emptyTraversalStack=new vi,this._frameNumber=null,this.root=null,this.selectedTiles={},this.requestedTiles={},this.emptyTiles={}}traverse(t,e,r){this.root=t,this.options={...this.options,...r},this.reset(),this.updateTile(t,e),this._frameNumber=e.frameNumber,this.executeTraversal(t,e)}reset(){this.requestedTiles={},this.selectedTiles={},this.emptyTiles={},this._traversalStack.reset(),this._emptyTraversalStack.reset()}executeTraversal(t,e){const r=this._traversalStack;for(t._selectionDepth=1,r.push(t);r.length>0;){const t=r.pop();let s=!1;this.canTraverse(t,e)&&(this.updateChildTiles(t,e),s=this.updateAndPushChildren(t,e,r,t.hasRenderContent?t._selectionDepth+1:t._selectionDepth));const n=t.parent,i=Boolean(!n||n._shouldRefine),o=!s;t.hasRenderContent?t.refine===ei?(this.loadTile(t,e),this.selectTile(t,e)):t.refine===ri&&(this.loadTile(t,e),o&&this.selectTile(t,e)):(this.emptyTiles[t.id]=t,this.loadTile(t,e),o&&this.selectTile(t,e)),this.touchTile(t,e),t._shouldRefine=s&&i}this.options.onTraversalEnd(e)}updateChildTiles(t,e){const r=t.children;for(const t of r)this.updateTile(t,e);return!0}updateAndPushChildren(t,e,r,s){const{loadSiblings:n,skipLevelOfDetail:i}=this.options,o=t.children;o.sort(this.compareDistanceToCamera.bind(this));const a=t.refine===ri&&t.hasRenderContent&&!i;let c=!1,h=!0;for(const t of o)if(t._selectionDepth=s,t.isVisibleAndInRequestVolume?(r.find(t)&&r.delete(t),r.push(t),c=!0):(a||n)&&(this.loadTile(t,e),this.touchTile(t,e)),a){let r;if(r=!!t._inRequestVolume&&(t.hasRenderContent?t.contentAvailable:this.executeEmptyTraversal(t,e)),h=h&&r,!h)return!1}return c||(h=!1),h}updateTile(t,e){this.updateTileVisibility(t,e)}selectTile(t,e){this.shouldSelectTile(t)&&(t._selectedFrame=e.frameNumber,this.selectedTiles[t.id]=t)}loadTile(t,e){this.shouldLoadTile(t)&&(t._requestedFrame=e.frameNumber,t._priority=t._getPriority(),this.requestedTiles[t.id]=t)}touchTile(t,e){t.tileset._cache.touch(t),t._touchedFrame=e.frameNumber}canTraverse(t,e,r=!1,s=!1){return!!t.hasChildren&&(t.hasTilesetContent?!t.contentExpired:!(!s&&!t.isVisibleAndInRequestVolume)&&this.shouldRefine(t,e,r))}shouldLoadTile(t){return t.hasUnloadedContent||t.contentExpired}shouldSelectTile(t){return t.contentAvailable&&!this.options.skipLevelOfDetail}shouldRefine(t,e,r){let s=t._screenSpaceError;return r&&(s=t.getScreenSpaceError(e,!0)),s>this.options.maximumScreenSpaceError}updateTileVisibility(t,e){const r=[];if(this.options.viewportTraversersMap)for(const t in this.options.viewportTraversersMap){this.options.viewportTraversersMap[t]===e.viewport.id&&r.push(t)}else r.push(e.viewport.id);t.updateVisibility(e,r)}compareDistanceToCamera(t,e){return t._distanceToCamera-e._distanceToCamera}anyChildrenVisible(t,e){let r=!1;for(const s of t.children)s.updateVisibility(e),r=r||s.isVisibleAndInRequestVolume;return r}executeEmptyTraversal(t,e){let r=!0;const s=this._emptyTraversalStack;for(s.push(t);s.length>0&&r;){const t=s.pop();this.updateTile(t,e),t.isVisibleAndInRequestVolume||this.loadTile(t,e),this.touchTile(t,e);if(!t.hasRenderContent&&this.canTraverse(t,e,!1,!0)){const e=t.children;for(const t of e)s.find(t)&&s.delete(t),s.push(t)}else t.contentAvailable||(r=!1)}return r}}const xi=new ur;class Ai{constructor(t,e,r,s=""){B(this,"tileset",void 0),B(this,"header",void 0),B(this,"id",void 0),B(this,"url",void 0),B(this,"parent",void 0),B(this,"refine",void 0),B(this,"type",void 0),B(this,"contentUrl",void 0),B(this,"lodMetricType",void 0),B(this,"lodMetricValue",void 0),B(this,"boundingVolume",void 0),B(this,"content",void 0),B(this,"contentState",void 0),B(this,"gpuMemoryUsageInBytes",void 0),B(this,"children",void 0),B(this,"depth",void 0),B(this,"viewportIds",void 0),B(this,"transform",void 0),B(this,"userData",void 0),B(this,"computedTransform",void 0),B(this,"hasEmptyContent",void 0),B(this,"hasTilesetContent",void 0),B(this,"traverser",void 0),B(this,"_cacheNode",void 0),B(this,"_frameNumber",void 0),B(this,"_lodJudge",void 0),B(this,"_expireDate",void 0),B(this,"_expiredContent",void 0),B(this,"_shouldRefine",void 0),B(this,"_distanceToCamera",void 0),B(this,"_centerZDepth",void 0),B(this,"_screenSpaceError",void 0),B(this,"_visibilityPlaneMask",void 0),B(this,"_visible",void 0),B(this,"_inRequestVolume",void 0),B(this,"_stackLength",void 0),B(this,"_selectionDepth",void 0),B(this,"_touchedFrame",void 0),B(this,"_visitedFrame",void 0),B(this,"_selectedFrame",void 0),B(this,"_requestedFrame",void 0),B(this,"_priority",void 0),B(this,"_contentBoundingVolume",void 0),B(this,"_viewerRequestVolume",void 0),B(this,"_initialTransform",void 0),this.header=e,this.tileset=t,this.id=s||e.id,this.url=e.url,this.parent=r,this.refine=this._getRefine(e.refine),this.type=e.type,this.contentUrl=e.contentUrl,this.lodMetricType="geometricError",this.lodMetricValue=0,this.boundingVolume=null,this.content=null,this.contentState=Yn,this.gpuMemoryUsageInBytes=0,this.children=[],this.hasEmptyContent=!1,this.hasTilesetContent=!1,this.depth=0,this.viewportIds=[],this.userData={},this._priority=0,this._touchedFrame=0,this._visitedFrame=0,this._selectedFrame=0,this._requestedFrame=0,this._screenSpaceError=0,this._cacheNode=null,this._frameNumber=null,this._cacheNode=null,this.traverser=new Si({}),this._shouldRefine=!1,this._distanceToCamera=0,this._centerZDepth=0,this._visible=void 0,this._inRequestVolume=!1,this._stackLength=0,this._selectionDepth=0,this._initialTransform=new Br,this.transform=new Br,this._initializeLodMetric(e),this._initializeTransforms(e),this._initializeBoundingVolumes(e),this._initializeContent(e),this._initializeRenderingState(e),this._lodJudge=null,this._expireDate=null,this._expiredContent=null,Object.seal(this)}destroy(){this.header=null}isDestroyed(){return null===this.header}get selected(){return this._selectedFrame===this.tileset._frameNumber}get isVisible(){return this._visible}get isVisibleAndInRequestVolume(){return this._visible&&this._inRequestVolume}get hasRenderContent(){return!this.hasEmptyContent&&!this.hasTilesetContent}get hasChildren(){return this.children.length>0||this.header.children&&this.header.children.length>0}get contentReady(){return this.contentState===Jn||this.hasEmptyContent}get contentAvailable(){return Boolean(this.contentReady&&this.hasRenderContent||this._expiredContent&&!this.contentFailed)}get hasUnloadedContent(){return this.hasRenderContent&&this.contentUnloaded}get contentUnloaded(){return this.contentState===Yn}get contentExpired(){return this.contentState===Xn}get contentFailed(){return this.contentState===ti}getScreenSpaceError(t,e){switch(this.tileset.type){case ai:return Ti(this,t);case ci:return function(t,e,r){const s=t.tileset,n=t.parent&&t.parent.lodMetricValue||t.lodMetricValue,i=r?n:t.lodMetricValue;if(0===i)return 0;const o=Math.max(t._distanceToCamera,1e-7),{height:a,sseDenominator:c}=e,{viewDistanceScale:h}=s.options;let u=i*a*(h||1)/(o*c);return u-=yi(s,o),u}(this,t,e);default:throw new Error("Unsupported tileset type")}}_getPriority(){const t=this.tileset._traverser,{skipLevelOfDetail:e}=t.options,r=this.refine===ei||e;if(r&&!this.isVisible&&void 0!==this._visible)return-1;if(this.tileset._frameNumber-this._touchedFrame>=1)return-1;if(this.contentState===Yn)return-1;const s=this.parent,n=s&&(!r||0===this._screenSpaceError||s.hasTilesetContent)?s._screenSpaceError:this._screenSpaceError,i=t.root?t.root._screenSpaceError:0;return Math.max(i-n,0)}async loadContent(){if(this.hasEmptyContent)return!1;if(this.content)return!0;this.contentExpired&&(this._expireDate=null),this.contentState=Zn;const t=await this.tileset._requestScheduler.scheduleRequest(this.id,this._getPriority.bind(this));if(!t)return this.contentState=Yn,!1;try{const e=this.tileset.getTileUrl(this.contentUrl),r=this.tileset.loader,s={...this.tileset.loadOptions,[r.id]:{...this.tileset.loadOptions[r.id],isTileset:"json"===this.type,...this._getLoaderSpecificOptions(r.id)}};return this.content=await xe(e,r,s),this.tileset.options.contentLoader&&await this.tileset.options.contentLoader(this),this._isTileset()&&this.tileset._initializeTileHeaders(this.content,this),this.contentState=Jn,this._onContentLoaded(),!0}catch(t){throw this.contentState=ti,t}finally{t.done()}}unloadContent(){return this.content&&this.content.destroy&&this.content.destroy(),this.content=null,this.header.content&&this.header.content.destroy&&this.header.content.destroy(),this.header.content=null,this.contentState=Yn,!0}updateVisibility(t,e){if(this._frameNumber===t.frameNumber)return;const r=this.parent,s=r?r._visibilityPlaneMask:Pn.MASK_INDETERMINATE;if(this.tileset._traverser.options.updateTransforms){const t=r?r.computedTransform:this.tileset.modelMatrix;this._updateTransform(t)}this._distanceToCamera=this.distanceToTile(t),this._screenSpaceError=this.getScreenSpaceError(t,!1),this._visibilityPlaneMask=this.visibility(t,s),this._visible=this._visibilityPlaneMask!==Pn.MASK_OUTSIDE,this._inRequestVolume=this.insideViewerRequestVolume(t),this._frameNumber=t.frameNumber,this.viewportIds=e}visibility(t,e){const{cullingVolume:r}=t,{boundingVolume:s}=this;return r.computeVisibilityWithPlaneMask(s,e)}contentVisibility(){return!0}distanceToTile(t){const e=this.boundingVolume;return Math.sqrt(Math.max(e.distanceSquaredTo(t.camera.position),0))}cameraSpaceZDepth({camera:t}){const e=this.boundingVolume;return xi.subVectors(e.center,t.position),t.direction.dot(xi)}insideViewerRequestVolume(t){const e=this._viewerRequestVolume;return!e||e.distanceSquaredTo(t.camera.position)<=0}updateExpiration(){if(null!=this._expireDate&&this.contentReady&&!this.hasEmptyContent){const t=Date.now();Date.lessThan(this._expireDate,t)&&(this.contentState=Xn,this._expiredContent=this.content)}}get extras(){return this.header.extras}_initializeLodMetric(t){"lodMetricType"in t?this.lodMetricType=t.lodMetricType:(this.lodMetricType=this.parent&&this.parent.lodMetricType||this.tileset.lodMetricType,console.warn("3D Tile: Required prop lodMetricType is undefined. Using parent lodMetricType")),"lodMetricValue"in t?this.lodMetricValue=t.lodMetricValue:(this.lodMetricValue=this.parent&&this.parent.lodMetricValue||this.tileset.lodMetricValue,console.warn("3D Tile: Required prop lodMetricValue is undefined. Using parent lodMetricValue"))}_initializeTransforms(t){this.transform=t.transform?new Br(t.transform):new Br;const e=this.parent,r=this.tileset,s=e&&e.computedTransform?e.computedTransform.clone():r.modelMatrix.clone();this.computedTransform=new Br(s).multiplyRight(this.transform);const n=e&&e._initialTransform?e._initialTransform.clone():new Br;this._initialTransform=new Br(n).multiplyRight(this.transform)}_initializeBoundingVolumes(t){this._contentBoundingVolume=null,this._viewerRequestVolume=null,this._updateBoundingVolume(t)}_initializeContent(t){this.content={_tileset:this.tileset,_tile:this},this.hasEmptyContent=!0,this.contentState=Yn,this.hasTilesetContent=!1,t.contentUrl&&(this.content=null,this.hasEmptyContent=!1)}_initializeRenderingState(t){this.depth=t.level||(this.parent?this.parent.depth+1:0),this._shouldRefine=!1,this._distanceToCamera=0,this._centerZDepth=0,this._screenSpaceError=0,this._visibilityPlaneMask=Pn.MASK_INDETERMINATE,this._visible=void 0,this._inRequestVolume=!1,this._stackLength=0,this._selectionDepth=0,this._frameNumber=0,this._touchedFrame=0,this._visitedFrame=0,this._selectedFrame=0,this._requestedFrame=0,this._priority=0}_getRefine(t){return t||this.parent&&this.parent.refine||ri}_isTileset(){return-1!==this.contentUrl.indexOf(".json")}_onContentLoaded(){switch(this.content&&this.content.type){case"vctr":case"geom":this.tileset._traverser.disableSkipLevelOfDetail=!0}this._isTileset()&&(this.hasTilesetContent=!0)}_updateBoundingVolume(t){this.boundingVolume=pi(t.boundingVolume,this.computedTransform,this.boundingVolume);const e=t.content;e&&(e.boundingVolume&&(this._contentBoundingVolume=pi(e.boundingVolume,this.computedTransform,this._contentBoundingVolume)),t.viewerRequestVolume&&(this._viewerRequestVolume=pi(t.viewerRequestVolume,this.computedTransform,this._viewerRequestVolume)))}_updateTransform(t=new Br){const e=t.clone().multiplyRight(this.transform);!e.equals(this.computedTransform)&&(this.computedTransform=e,this._updateBoundingVolume(this.header))}_getLoaderSpecificOptions(t){switch(t){case"i3s":return{...this.tileset.options.i3s,tile:this.header,tileset:this.tileset.tileset,isTileHeader:!1};case"3d-tiles":case"cesium-ion":default:return{assetGltfUpAxis:(e=this.tileset.tileset).asset&&e.asset.gltfUpAxis||"Y"}}var e}}class Mi extends Si{compareDistanceToCamera(t,e){return 0===e._distanceToCamera&&0===t._distanceToCamera?e._centerZDepth-t._centerZDepth:e._distanceToCamera-t._distanceToCamera}updateTileVisibility(t,e){if(super.updateTileVisibility(t,e),!t.isVisibleAndInRequestVolume)return;const r=t.children.length>0;if(t.hasTilesetContent&&r){const r=t.children[0];return this.updateTileVisibility(r,e),void(t._visible=r._visible)}if(this.meetsScreenSpaceErrorEarly(t,e))return void(t._visible=!1);const s=t.refine===ri,n=t._optimChildrenWithinParent===ui;s&&n&&r&&!this.anyChildrenVisible(t,e)&&(t._visible=!1)}meetsScreenSpaceErrorEarly(t,e){const{parent:r}=t;return!(!r||r.hasTilesetContent||r.refine!==ei)&&!this.shouldRefine(t,e,!0)}}const Oi="REQUESTED",Ii="COMPLETED",Ni="ERROR";class Ri{constructor(){B(this,"_statusMap",void 0),this._statusMap={}}add(t,e,r,s){this._statusMap[e]||(this._statusMap[e]={request:t,callback:r,key:e,frameState:s,status:Oi},t().then((t=>{this._statusMap[e].status=Ii,this._statusMap[e].callback(t,s)})).catch((t=>{this._statusMap[e].status=Ni,r(t)})))}update(t,e){this._statusMap[t]&&(this._statusMap[t].frameState=e)}find(t){return this._statusMap[t]}}class Ci extends Si{constructor(t){super(t),B(this,"_tileManager",void 0),this._tileManager=new Ri}shouldRefine(t,e){return t._lodJudge=function(t,e){const r=e.viewport,s=r.metersPerPixel,n=t.header.mbs[1],i=t.header.mbs[0],o=t.header.mbs[2],a=t.header.mbs[3],{height:c,width:h,latitude:u,longitude:l}=r,d=[l,u],f=[i,n,o],m=[l,n],p=[i,u],g=Math.sqrt(c*c+h*h)*s[0],y=.5*c+a/6378137,w=.5*h+a/6378137;if(_i(d,f)>g+a/6378137)return"OUT";if(_i(d,m)>y)return"OUT";if(_i(d,p)>w)return"OUT";if(0===t.lodMetricValue)return"DIG";let b=Ti(t,e);return b*=wi,b<.5?"OUT":!t.header.children||b<=t.lodMetricValue?"DRAW":t.header.children?"DIG":"OUT"}(t,e),"DIG"===t._lodJudge}updateChildTiles(t,e){const r=t.header.children||[],s=t.children,n=t.tileset;for(const i of r){const r=`${i.id}-${e.viewport.id}`,o=s&&s.find((t=>t.id===r));if(o)o&&this.updateTile(o,e);else{let s=()=>this._loadTile(i.id,n);this._tileManager.find(r)?this._tileManager.update(r,e):(n.tileset.nodePages&&(s=()=>n.tileset.nodePagesTile.formTileFromNodePages(i.id)),this._tileManager.add(s,r,(e=>this._onTileLoad(e,t,r)),e))}}return!1}async _loadTile(t,e){const{loader:r}=e,s=e.getTileUrl(`${e.url}/nodes/${t}`),n={...e.loadOptions,i3s:{...e.loadOptions.i3s,isTileHeader:!0,loadContent:!1}};return await xe(s,r,n)}_onTileLoad(t,e,r){const s=new Ai(e.tileset,t,e,r);e.children.push(s);const n=this._tileManager.find(s.id).frameState;this.updateTile(s,n),this._frameNumber===n.frameNumber&&this.executeTraversal(s,n)}}const Li={description:"",ellipsoid:en.WGS84,modelMatrix:new Br,throttleRequests:!0,maxRequests:64,maximumMemoryUsage:32,onTileLoad:()=>{},onTileUnload:()=>{},onTileError:()=>{},onTraversalComplete:t=>t,contentLoader:void 0,viewDistanceScale:1,maximumScreenSpaceError:8,loadTiles:!0,updateTransforms:!0,viewportTraversersMap:null,loadOptions:{fetch:{}},attributions:[],basePath:"",i3s:{}};class Pi{constructor(t,e){B(this,"options",void 0),B(this,"loadOptions",void 0),B(this,"type",void 0),B(this,"tileset",void 0),B(this,"loader",void 0),B(this,"url",void 0),B(this,"basePath",void 0),B(this,"modelMatrix",void 0),B(this,"ellipsoid",void 0),B(this,"lodMetricType",void 0),B(this,"lodMetricValue",void 0),B(this,"refine",void 0),B(this,"root",void 0),B(this,"roots",void 0),B(this,"asset",void 0),B(this,"description",void 0),B(this,"properties",void 0),B(this,"extras",void 0),B(this,"attributions",void 0),B(this,"credits",void 0),B(this,"stats",void 0),B(this,"traverseCounter",void 0),B(this,"geometricError",void 0),B(this,"selectedTiles",void 0),B(this,"cartographicCenter",void 0),B(this,"cartesianCenter",void 0),B(this,"zoom",void 0),B(this,"boundingVolume",void 0),B(this,"gpuMemoryUsageInBytes",void 0),B(this,"dynamicScreenSpaceErrorComputedDensity",void 0),B(this,"_traverser",void 0),B(this,"_cache",void 0),B(this,"_requestScheduler",void 0),B(this,"_frameNumber",void 0),B(this,"_queryParamsString",void 0),B(this,"_queryParams",void 0),B(this,"_extensionsUsed",void 0),B(this,"_tiles",void 0),B(this,"_pendingCount",void 0),B(this,"lastUpdatedVieports",void 0),B(this,"_requestedTiles",void 0),B(this,"_emptyTiles",void 0),B(this,"frameStateData",void 0),B(this,"maximumMemoryUsage",void 0),M(t),this.options={...Li,...e},this.tileset=t,this.loader=t.loader,this.type=t.type,this.url=t.url,this.basePath=t.basePath||mt(this.url),this.modelMatrix=this.options.modelMatrix,this.ellipsoid=this.options.ellipsoid,this.lodMetricType=t.lodMetricType,this.lodMetricValue=t.lodMetricValue,this.refine=t.root.refine,this.loadOptions=this.options.loadOptions||{},this.root=null,this.roots={},this.cartographicCenter=null,this.cartesianCenter=null,this.zoom=1,this.boundingVolume=null,this.traverseCounter=0,this.geometricError=0,this._traverser=this._initializeTraverser(),this._cache=new on,this._requestScheduler=new ft({throttleRequests:this.options.throttleRequests,maxRequests:this.options.maxRequests}),this._frameNumber=0,this._pendingCount=0,this._tiles={},this.selectedTiles=[],this._emptyTiles=[],this._requestedTiles=[],this.frameStateData={},this.lastUpdatedVieports=null,this._queryParams={},this._queryParamsString="",this.maximumMemoryUsage=this.options.maximumMemoryUsage||32,this.gpuMemoryUsageInBytes=0,this.stats=new lt({id:this.url}),this._initializeStats(),this._extensionsUsed=void 0,this.dynamicScreenSpaceErrorComputedDensity=0,this.extras=null,this.asset={},this.credits={},this.description=this.options.description||"",this._initializeTileSet(t)}destroy(){this._destroy()}isLoaded(){return 0===this._pendingCount&&0!==this._frameNumber}get tiles(){return Object.values(this._tiles)}get frameNumber(){return this._frameNumber}get queryParams(){return this._queryParamsString||(this._queryParamsString=function(t){const e=[];for(const r of Object.keys(t))e.push(`${r}=${t[r]}`);switch(e.length){case 0:return"";case 1:return`?${e[0]}`;default:return`?${e.join("&")}`}}(this._queryParams)),this._queryParamsString}setProps(t){this.options={...this.options,...t}}setOptions(t){this.options={...this.options,...t}}getTileUrl(t){return t.startsWith("data:")?t:`${t}${this.queryParams}`}hasExtension(t){return Boolean(this._extensionsUsed&&this._extensionsUsed.indexOf(t)>-1)}update(t){if("loadTiles"in this.options&&!this.options.loadTiles)return;if(this.traverseCounter>0)return;!t&&this.lastUpdatedVieports?t=this.lastUpdatedVieports:this.lastUpdatedVieports=t,t instanceof Array||(t=[t]),this._cache.reset(),this._frameNumber++,this.traverseCounter=t.length;const e=[];for(const r of t){const t=r.id;this._needTraverse(t)?e.push(t):this.traverseCounter--}for(const r of t){const t=r.id;if(this.roots[t]||(this.roots[t]=this._initializeTileHeaders(this.tileset,null)),!e.includes(t))continue;const s=Hn(r,this._frameNumber);this._traverser.traverse(this.roots[t],s,this.options)}}_needTraverse(t){let e=t;return this.options.viewportTraversersMap&&(e=this.options.viewportTraversersMap[t]),e===t}_onTraversalEnd(t){const e=t.viewport.id;this.frameStateData[e]||(this.frameStateData[e]={selectedTiles:[],_requestedTiles:[],_emptyTiles:[]});const r=this.frameStateData[e],s=Object.values(this._traverser.selectedTiles);r.selectedTiles=s,r._requestedTiles=Object.values(this._traverser.requestedTiles),r._emptyTiles=Object.values(this._traverser.emptyTiles),this.traverseCounter--,this.traverseCounter>0||this._updateTiles()}_updateTiles(){this.selectedTiles=[],this._requestedTiles=[],this._emptyTiles=[];for(const t in this.frameStateData){const e=this.frameStateData[t];this.selectedTiles=this.selectedTiles.concat(e.selectedTiles),this._requestedTiles=this._requestedTiles.concat(e._requestedTiles),this._emptyTiles=this._emptyTiles.concat(e._emptyTiles)}this.selectedTiles=this.options.onTraversalComplete(this.selectedTiles);for(const t of this.selectedTiles)this._tiles[t.id]=t;this._loadTiles(),this._unloadTiles(),this._updateStats()}_tilesChanged(t,e){if(t.length!==e.length)return!0;const r=new Set(t.map((t=>t.id))),s=new Set(e.map((t=>t.id)));let n=t.filter((t=>!s.has(t.id))).length>0;return n=n||e.filter((t=>!r.has(t.id))).length>0,n}_loadTiles(){for(const t of this._requestedTiles)t.contentUnloaded&&this._loadTile(t)}_unloadTiles(){this._cache.unloadTiles(this,((t,e)=>t._unloadTile(e)))}_updateStats(){let t=0,e=0;for(const r of this.selectedTiles)r.contentAvailable&&r.content&&(t++,r.content.pointCount&&(e+=r.content.pointCount));this.stats.get("Tiles In View").count=this.selectedTiles.length,this.stats.get("Tiles To Render").count=t,this.stats.get("Points").count=e}_initializeTileSet(t){this.root=this._initializeTileHeaders(t,null),this.type===ci&&this._initializeCesiumTileset(t),this.type===ai&&this._initializeI3STileset(),this._calculateViewProps()}_calculateViewProps(){const t=this.root;M(t);const{center:e}=t.boundingVolume;if(!e)return console.warn("center was not pre-calculated for the root tile"),this.cartographicCenter=new ur,void(this.zoom=1);this.cartographicCenter=en.WGS84.cartesianToCartographic(e,new ur),this.cartesianCenter=e,this.zoom=Kn(t.boundingVolume)}_initializeStats(){this.stats.get("Tiles In Tileset(s)"),this.stats.get("Tiles Loading"),this.stats.get("Tiles In Memory"),this.stats.get("Tiles In View"),this.stats.get("Tiles To Render"),this.stats.get("Tiles Loaded"),this.stats.get("Tiles Unloaded"),this.stats.get("Failed Tile Loads"),this.stats.get("Points","memory"),this.stats.get("Tile Memory Use","memory")}_initializeTileHeaders(t,e){const r=new Ai(this,t.root,e);if(e&&(e.children.push(r),r.depth=e.depth+1),this.type===ci){const t=[];for(t.push(r);t.length>0;){const e=t.pop();this.stats.get("Tiles In Tileset(s)").incrementCount();const r=e.header.children||[];for(const s of r){const r=new Ai(this,s,e);e.children.push(r),r.depth=e.depth+1,t.push(r)}}}return r}_initializeTraverser(){let t;switch(this.type){case ci:t=Mi;break;case ai:t=Ci;break;default:t=Si}return new t({basePath:this.basePath,onTraversalEnd:this._onTraversalEnd.bind(this)})}_destroyTileHeaders(t){this._destroySubtree(t)}async _loadTile(t){let e;try{this._onStartTileLoading(),e=await t.loadContent()}catch(e){this._onTileLoadError(t,e)}finally{this._onEndTileLoading(),this._onTileLoad(t,e)}}_onTileLoadError(t,e){this.stats.get("Failed Tile Loads").incrementCount();const r=e.message||e.toString(),s=t.url;console.error(`A 3D tile failed to load: ${t.url} ${r}`),this.options.onTileError(t,r,s)}_onTileLoad(t,e){e&&(t&&t.content&&function(t,e){M(t),M(e);const{rtcCenter:r,gltfUpAxis:s}=e,{computedTransform:n,boundingVolume:{center:i}}=t;let o=new Br(n);switch(r&&o.translate(r),s){case"Z":break;case"Y":const t=(new Br).rotateX(Math.PI/2);o=o.multiplyRight(t);break;case"X":const e=(new Br).rotateY(-Math.PI/2);o=o.multiplyRight(e)}e.isQuantized&&o.translate(e.quantizedVolumeOffset).scale(e.quantizedVolumeScale);const a=new ur(i);e.cartesianModelMatrix=o,e.cartesianOrigin=a;const c=en.WGS84.cartesianToCartographic(a,new ur),h=en.WGS84.eastNorthUpToFixedFrame(a).invert();e.cartographicModelMatrix=h.multiplyRight(o),e.cartographicOrigin=c,e.modelMatrix=e.cartographicModelMatrix}(t,t.content),this._addTileToCache(t),this.options.onTileLoad(t))}_onStartTileLoading(){this._pendingCount++,this.stats.get("Tiles Loading").incrementCount()}_onEndTileLoading(){this._pendingCount--,this.stats.get("Tiles Loading").decrementCount()}_addTileToCache(t){this._cache.add(this,t,(e=>e._updateCacheStats(t)))}_updateCacheStats(t){this.stats.get("Tiles Loaded").incrementCount(),this.stats.get("Tiles In Memory").incrementCount(),this.gpuMemoryUsageInBytes+=t.content.byteLength||0,this.stats.get("Tile Memory Use").count=this.gpuMemoryUsageInBytes}_unloadTile(t){this.gpuMemoryUsageInBytes-=t.content&&t.content.byteLength||0,this.stats.get("Tiles In Memory").decrementCount(),this.stats.get("Tiles Unloaded").incrementCount(),this.stats.get("Tile Memory Use").count=this.gpuMemoryUsageInBytes,this.options.onTileUnload(t),t.unloadContent()}_destroy(){const t=[];for(this.root&&t.push(this.root);t.length>0;){const e=t.pop();for(const r of e.children)t.push(r);this._destroyTile(e)}this.root=null}_destroySubtree(t){const e=t,r=[];for(r.push(e);r.length>0;){t=r.pop();for(const e of t.children)r.push(e);t!==e&&this._destroyTile(t)}e.children=[]}_destroyTile(t){this._cache.unloadTile(this,t),this._unloadTile(t),t.destroy()}_initializeCesiumTileset(t){if(this.asset=t.asset,!this.asset)throw new Error("Tileset must have an asset property.");if("0.0"!==this.asset.version&&"1.0"!==this.asset.version)throw new Error("The tileset must be 3D Tiles version 0.0 or 1.0.");"tilesetVersion"in this.asset&&(this._queryParams.v=this.asset.tilesetVersion),this.credits={attributions:this.options.attributions||[]},this.description=this.options.description||"",this.properties=t.properties,this.geometricError=t.geometricError,this._extensionsUsed=t.extensionsUsed,this.extras=t.extras}_initializeI3STileset(){this.loadOptions.i3s&&"token"in this.loadOptions.i3s&&(this._queryParams.token=this.loadOptions.i3s.token)}}const ki="cmpt",Ui="pnts",Di="b3dm",ji="i3dm";function Bi(t,e,r){M(t instanceof ArrayBuffer);const s=new TextDecoder("utf8"),n=new Uint8Array(t,e,r);return s.decode(n)}const Vi={name:"Draco",id:"draco",module:"draco",version:"3.0.10",worker:!0,extensions:["drc"],mimeTypes:["application/octet-stream"],binary:!0,tests:["DRACO"],options:{draco:{decoderType:"object"==typeof WebAssembly?"wasm":"js",libraryPath:"libs/",extraAttributes:{},attributeNameEntry:void 0}}};class Fi{constructor(t,e){B(this,"fields",void 0),B(this,"metadata",void 0),function(t,e){if(!t)throw new Error(e||"loader assertion failed.")}(Array.isArray(t)),function(t){const e={};for(const r of t)e[r.name]&&console.warn("Schema: duplicated field name",r.name,r),e[r.name]=!0}(t),this.fields=t,this.metadata=e||new Map}compareTo(t){if(this.metadata!==t.metadata)return!1;if(this.fields.length!==t.fields.length)return!1;for(let e=0;e<this.fields.length;++e)if(!this.fields[e].compareTo(t.fields[e]))return!1;return!0}select(...t){const e=Object.create(null);for(const r of t)e[r]=!0;const r=this.fields.filter((t=>e[t.name]));return new Fi(r,this.metadata)}selectAt(...t){const e=t.map((t=>this.fields[t])).filter(Boolean);return new Fi(e,this.metadata)}assign(t){let e,r=this.metadata;if(t instanceof Fi){const s=t;e=s.fields,r=qi(qi(new Map,this.metadata),s.metadata)}else e=t;const s=Object.create(null);for(const t of this.fields)s[t.name]=t;for(const t of e)s[t.name]=t;const n=Object.values(s);return new Fi(n,r)}}function qi(t,e){return new Map([...t||new Map,...e||new Map])}class zi{constructor(t,e,r=!1,s=new Map){B(this,"name",void 0),B(this,"type",void 0),B(this,"nullable",void 0),B(this,"metadata",void 0),this.name=t,this.type=e,this.nullable=r,this.metadata=s}get typeId(){return this.type&&this.type.typeId}clone(){return new zi(this.name,this.type,this.nullable,this.metadata)}compareTo(t){return this.name===t.name&&this.type===t.type&&this.nullable===t.nullable&&this.metadata===t.metadata}toString(){return`${this.type}${this.nullable?", nullable":""}${this.metadata?`, metadata: ${this.metadata}`:""}`}}let Gi,$i,Wi,Hi;!function(t){t[t.NONE=0]="NONE",t[t.Null=1]="Null",t[t.Int=2]="Int",t[t.Float=3]="Float",t[t.Binary=4]="Binary",t[t.Utf8=5]="Utf8",t[t.Bool=6]="Bool",t[t.Decimal=7]="Decimal",t[t.Date=8]="Date",t[t.Time=9]="Time",t[t.Timestamp=10]="Timestamp",t[t.Interval=11]="Interval",t[t.List=12]="List",t[t.Struct=13]="Struct",t[t.Union=14]="Union",t[t.FixedSizeBinary=15]="FixedSizeBinary",t[t.FixedSizeList=16]="FixedSizeList",t[t.Map=17]="Map",t[t.Dictionary=-1]="Dictionary",t[t.Int8=-2]="Int8",t[t.Int16=-3]="Int16",t[t.Int32=-4]="Int32",t[t.Int64=-5]="Int64",t[t.Uint8=-6]="Uint8",t[t.Uint16=-7]="Uint16",t[t.Uint32=-8]="Uint32",t[t.Uint64=-9]="Uint64",t[t.Float16=-10]="Float16",t[t.Float32=-11]="Float32",t[t.Float64=-12]="Float64",t[t.DateDay=-13]="DateDay",t[t.DateMillisecond=-14]="DateMillisecond",t[t.TimestampSecond=-15]="TimestampSecond",t[t.TimestampMillisecond=-16]="TimestampMillisecond",t[t.TimestampMicrosecond=-17]="TimestampMicrosecond",t[t.TimestampNanosecond=-18]="TimestampNanosecond",t[t.TimeSecond=-19]="TimeSecond",t[t.TimeMillisecond=-20]="TimeMillisecond",t[t.TimeMicrosecond=-21]="TimeMicrosecond",t[t.TimeNanosecond=-22]="TimeNanosecond",t[t.DenseUnion=-23]="DenseUnion",t[t.SparseUnion=-24]="SparseUnion",t[t.IntervalDayTime=-25]="IntervalDayTime",t[t.IntervalYearMonth=-26]="IntervalYearMonth"}(Gi||(Gi={}));class Qi{static isNull(t){return t&&t.typeId===Gi.Null}static isInt(t){return t&&t.typeId===Gi.Int}static isFloat(t){return t&&t.typeId===Gi.Float}static isBinary(t){return t&&t.typeId===Gi.Binary}static isUtf8(t){return t&&t.typeId===Gi.Utf8}static isBool(t){return t&&t.typeId===Gi.Bool}static isDecimal(t){return t&&t.typeId===Gi.Decimal}static isDate(t){return t&&t.typeId===Gi.Date}static isTime(t){return t&&t.typeId===Gi.Time}static isTimestamp(t){return t&&t.typeId===Gi.Timestamp}static isInterval(t){return t&&t.typeId===Gi.Interval}static isList(t){return t&&t.typeId===Gi.List}static isStruct(t){return t&&t.typeId===Gi.Struct}static isUnion(t){return t&&t.typeId===Gi.Union}static isFixedSizeBinary(t){return t&&t.typeId===Gi.FixedSizeBinary}static isFixedSizeList(t){return t&&t.typeId===Gi.FixedSizeList}static isMap(t){return t&&t.typeId===Gi.Map}static isDictionary(t){return t&&t.typeId===Gi.Dictionary}get typeId(){return Gi.NONE}compareTo(t){return this===t}}$i=Symbol.toStringTag;class Ki extends Qi{constructor(t,e){super(),B(this,"isSigned",void 0),B(this,"bitWidth",void 0),this.isSigned=t,this.bitWidth=e}get typeId(){return Gi.Int}get[$i](){return"Int"}toString(){return`${this.isSigned?"I":"Ui"}nt${this.bitWidth}`}}class Yi extends Ki{constructor(){super(!0,8)}}class Zi extends Ki{constructor(){super(!0,16)}}class Ji extends Ki{constructor(){super(!0,32)}}class Xi extends Ki{constructor(){super(!1,8)}}class to extends Ki{constructor(){super(!1,16)}}class eo extends Ki{constructor(){super(!1,32)}}const ro=32,so=64;Wi=Symbol.toStringTag;class no extends Qi{constructor(t){super(),B(this,"precision",void 0),this.precision=t}get typeId(){return Gi.Float}get[Wi](){return"Float"}toString(){return`Float${this.precision}`}}class io extends no{constructor(){super(ro)}}class oo extends no{constructor(){super(so)}}Hi=Symbol.toStringTag;class ao extends Qi{constructor(t,e){super(),B(this,"listSize",void 0),B(this,"children",void 0),this.listSize=t,this.children=[e]}get typeId(){return Gi.FixedSizeList}get valueType(){return this.children[0].type}get valueField(){return this.children[0]}get[Hi](){return"FixedSizeList"}toString(){return`FixedSizeList[${this.listSize}]<${this.valueType}>`}}function co(t,e,r){const s=r?ho(r.metadata):void 0,n=function(t){switch(t.constructor){case Int8Array:return new Yi;case Uint8Array:return new Xi;case Int16Array:return new Zi;case Uint16Array:return new to;case Int32Array:return new Ji;case Uint32Array:return new eo;case Float32Array:return new io;case Float64Array:return new oo;default:throw new Error("array type not supported")}}(e.value);return new zi(t,new ao(e.size,new zi("value",n)),!1,s)}function ho(t){const e=new Map;for(const r in t)e.set(`${r}.string`,JSON.stringify(t[r]));return e}const uo={POSITION:"POSITION",NORMAL:"NORMAL",COLOR:"COLOR_0",TEX_COORD:"TEXCOORD_0"},lo={1:Int8Array,2:Uint8Array,3:Int16Array,4:Uint16Array,5:Int32Array,6:Uint32Array,9:Float32Array};class fo{constructor(t){B(this,"draco",void 0),B(this,"decoder",void 0),B(this,"metadataQuerier",void 0),this.draco=t,this.decoder=new this.draco.Decoder,this.metadataQuerier=new this.draco.MetadataQuerier}destroy(){this.draco.destroy(this.decoder),this.draco.destroy(this.metadataQuerier)}parseSync(t,e={}){const r=new this.draco.DecoderBuffer;r.Init(new Int8Array(t),t.byteLength),this._disableAttributeTransforms(e);const s=this.decoder.GetEncodedGeometryType(r),n=s===this.draco.TRIANGULAR_MESH?new this.draco.Mesh:new this.draco.PointCloud;try{let t;switch(s){case this.draco.TRIANGULAR_MESH:t=this.decoder.DecodeBufferToMesh(r,n);break;case this.draco.POINT_CLOUD:t=this.decoder.DecodeBufferToPointCloud(r,n);break;default:throw new Error("DRACO: Unknown geometry type.")}if(!t.ok()||!n.ptr){const e=`DRACO decompression failed: ${t.error_msg()}`;throw new Error(e)}const i=this._getDracoLoaderData(n,s,e),o=this._getMeshData(n,i,e),a=function(t){let e=1/0,r=1/0,s=1/0,n=-1/0,i=-1/0,o=-1/0;const a=t.POSITION?t.POSITION.value:[],c=a&&a.length;for(let t=0;t<c;t+=3){const c=a[t],h=a[t+1],u=a[t+2];e=c<e?c:e,r=h<r?h:r,s=u<s?u:s,n=c>n?c:n,i=h>i?h:i,o=u>o?u:o}return[[e,r,s],[n,i,o]]}(o.attributes),c=function(t,e,r){const s=ho(e.metadata),n=[],i=function(t){const e={};for(const r in t){const s=t[r];e[s.name||"undefined"]=s}return e}(e.attributes);for(const e in t){const r=co(e,t[e],i[e]);n.push(r)}if(r){const t=co("indices",r);n.push(t)}return new Fi(n,s)}(o.attributes,i,o.indices);return{loader:"draco",loaderData:i,header:{vertexCount:n.num_points(),boundingBox:a},...o,schema:c}}finally{this.draco.destroy(r),n&&this.draco.destroy(n)}}_getDracoLoaderData(t,e,r){const s=this._getTopLevelMetadata(t),n=this._getDracoAttributes(t,r);return{geometry_type:e,num_attributes:t.num_attributes(),num_points:t.num_points(),num_faces:t instanceof this.draco.Mesh?t.num_faces():0,metadata:s,attributes:n}}_getDracoAttributes(t,e){const r={};for(let s=0;s<t.num_attributes();s++){const n=this.decoder.GetAttribute(t,s),i=this._getAttributeMetadata(t,s);r[n.unique_id()]={unique_id:n.unique_id(),attribute_type:n.attribute_type(),data_type:n.data_type(),num_components:n.num_components(),byte_offset:n.byte_offset(),byte_stride:n.byte_stride(),normalized:n.normalized(),attribute_index:s,metadata:i};const o=this._getQuantizationTransform(n,e);o&&(r[n.unique_id()].quantization_transform=o);const a=this._getOctahedronTransform(n,e);a&&(r[n.unique_id()].octahedron_transform=a)}return r}_getMeshData(t,e,r){const s=this._getMeshAttributes(e,t,r);if(!s.POSITION)throw new Error("DRACO: No position attribute found.");if(t instanceof this.draco.Mesh)switch(r.topology){case"triangle-strip":return{topology:"triangle-strip",mode:4,attributes:s,indices:{value:this._getTriangleStripIndices(t),size:1}};case"triangle-list":default:return{topology:"triangle-list",mode:5,attributes:s,indices:{value:this._getTriangleListIndices(t),size:1}}}return{topology:"point-list",mode:0,attributes:s}}_getMeshAttributes(t,e,r){const s={};for(const n of Object.values(t.attributes)){const t=this._deduceAttributeName(n,r);n.name=t;const{value:i,size:o}=this._getAttributeValues(e,n);s[t]={value:i,size:o,byteOffset:n.byte_offset,byteStride:n.byte_stride,normalized:n.normalized}}return s}_getTriangleListIndices(t){const e=3*t.num_faces(),r=4*e,s=this.draco._malloc(r);try{return this.decoder.GetTrianglesUInt32Array(t,r,s),new Uint32Array(this.draco.HEAPF32.buffer,s,e).slice()}finally{this.draco._free(s)}}_getTriangleStripIndices(t){const e=new this.draco.DracoInt32Array;try{return this.decoder.GetTriangleStripsFromMesh(t,e),function(t){const e=t.size(),r=new Int32Array(e);for(let s=0;s<e;s++)r[s]=t.GetValue(s);return r}(e)}finally{this.draco.destroy(e)}}_getAttributeValues(t,e){const r=lo[e.data_type],s=e.num_components,n=t.num_points()*s,i=n*r.BYTES_PER_ELEMENT,o=function(t,e){switch(e){case Float32Array:return t.DT_FLOAT32;case Int8Array:return t.DT_INT8;case Int16Array:return t.DT_INT16;case Int32Array:return t.DT_INT32;case Uint8Array:return t.DT_UINT8;case Uint16Array:return t.DT_UINT16;case Uint32Array:return t.DT_UINT32;default:return t.DT_INVALID}}(this.draco,r);let a;const c=this.draco._malloc(i);try{const s=this.decoder.GetAttribute(t,e.attribute_index);this.decoder.GetAttributeDataArrayForAllPoints(t,s,o,i,c),a=new r(this.draco.HEAPF32.buffer,c,n).slice()}finally{this.draco._free(c)}return{value:a,size:s}}_deduceAttributeName(t,e){const r=t.unique_id;for(const[t,s]of Object.entries(e.extraAttributes||{}))if(s===r)return t;const s=t.attribute_type;for(const t in uo){if(this.draco[t]===s)return uo[t]}const n=e.attributeNameEntry||"name";return t.metadata[n]?t.metadata[n].string:`CUSTOM_ATTRIBUTE_${r}`}_getTopLevelMetadata(t){const e=this.decoder.GetMetadata(t);return this._getDracoMetadata(e)}_getAttributeMetadata(t,e){const r=this.decoder.GetAttributeMetadata(t,e);return this._getDracoMetadata(r)}_getDracoMetadata(t){if(!t||!t.ptr)return{};const e={},r=this.metadataQuerier.NumEntries(t);for(let s=0;s<r;s++){const r=this.metadataQuerier.GetEntryName(t,s);e[r]=this._getDracoMetadataField(t,r)}return e}_getDracoMetadataField(t,e){const r=new this.draco.DracoInt32Array;try{this.metadataQuerier.GetIntEntryArray(t,e,r);const s=function(t){const e=t.size(),r=new Int32Array(e);for(let s=0;s<e;s++)r[s]=t.GetValue(s);return r}(r);return{int:this.metadataQuerier.GetIntEntry(t,e),string:this.metadataQuerier.GetStringEntry(t,e),double:this.metadataQuerier.GetDoubleEntry(t,e),intArray:s}}finally{this.draco.destroy(r)}}_disableAttributeTransforms(t){const{quantizedAttributes:e=[],octahedronAttributes:r=[]}=t,s=[...e,...r];for(const t of s)this.decoder.SkipAttributeTransform(this.draco[t])}_getQuantizationTransform(t,e){const{quantizedAttributes:r=[]}=e,s=t.attribute_type();if(r.map((t=>this.decoder[t])).includes(s)){const e=new this.draco.AttributeQuantizationTransform;try{if(e.InitFromAttribute(t))return{quantization_bits:e.quantization_bits(),range:e.range(),min_values:new Float32Array([1,2,3]).map((t=>e.min_value(t)))}}finally{this.draco.destroy(e)}}return null}_getOctahedronTransform(t,e){const{octahedronAttributes:r=[]}=e,s=t.attribute_type();if(r.map((t=>this.decoder[t])).includes(s)){const e=new this.draco.AttributeQuantizationTransform;try{if(e.InitFromAttribute(t))return{quantization_bits:e.quantization_bits()}}finally{this.draco.destroy(e)}}return null}}const mo="https://www.gstatic.com/draco/versioned/decoders/1.4.1/draco_decoder.js",po="https://www.gstatic.com/draco/versioned/decoders/1.4.1/draco_wasm_wrapper.js",go="https://www.gstatic.com/draco/versioned/decoders/1.4.1/draco_decoder.wasm";let yo;async function wo(t){const e=t.modules||{};return yo=e.draco3d?yo||e.draco3d.createDecoderModule({}).then((t=>({draco:t}))):yo||async function(t){let e,r;switch(t.draco&&t.draco.decoderType){case"js":e=await X(mo,"draco",t);break;case"wasm":default:[e,r]=await Promise.all([await X(po,"draco",t),await X(go,"draco",t)])}return e=e||globalThis.DracoDecoderModule,await function(t,e){const r={};e&&(r.wasmBinary=e);return new Promise((e=>{t({...r,onModuleLoaded:t=>e({draco:t})})}))}(e,r)}(t),await yo}const bo={...Vi,parse:async function(t,e){const{draco:r}=await wo(e),s=new fo(r);try{return s.parseSync(t,null==e?void 0:e.draco)}finally{s.destroy()}}};const _o={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DOUBLE:5130},To={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,..._o},vo={[_o.DOUBLE]:Float64Array,[_o.FLOAT]:Float32Array,[_o.UNSIGNED_SHORT]:Uint16Array,[_o.UNSIGNED_INT]:Uint32Array,[_o.UNSIGNED_BYTE]:Uint8Array,[_o.BYTE]:Int8Array,[_o.SHORT]:Int16Array,[_o.INT]:Int32Array},Eo={DOUBLE:_o.DOUBLE,FLOAT:_o.FLOAT,UNSIGNED_SHORT:_o.UNSIGNED_SHORT,UNSIGNED_INT:_o.UNSIGNED_INT,UNSIGNED_BYTE:_o.UNSIGNED_BYTE,BYTE:_o.BYTE,SHORT:_o.SHORT,INT:_o.INT};class So{static fromTypedArray(t){t=ArrayBuffer.isView(t)?t.constructor:t;for(const e in vo){if(vo[e]===t)return e}throw new Error("Failed to convert GL type")}static fromName(t){const e=Eo[t];if(!e)throw new Error("Failed to convert GL type");return e}static getArrayType(t){switch(t){case _o.UNSIGNED_SHORT_5_6_5:case _o.UNSIGNED_SHORT_4_4_4_4:case _o.UNSIGNED_SHORT_5_5_5_1:return Uint16Array;default:const e=vo[t];if(!e)throw new Error("Failed to convert GL type");return e}}static getByteSize(t){return So.getArrayType(t).BYTES_PER_ELEMENT}static validate(t){return Boolean(So.getArrayType(t))}static createTypedArray(t,e,r=0,s){void 0===s&&(s=(e.byteLength-r)/So.getByteSize(t));return new(So.getArrayType(t))(e,r,s)}}function xo(t,e=[0,0,0]){const r=t>>11&31,s=t>>5&63,n=31&t;return e[0]=r<<3,e[1]=s<<2,e[2]=n<<3,e}function Ao(t,e=255){return function(t,e,r){return Ce(t,(t=>Math.max(e,Math.min(r,t))))}(t,0,e)/e*2-1}function Mo(t){return t<0?-1:1}function Oo(t,e,r,s){if(function(t,e){if(!t)throw new Error(`math.gl assertion failed. ${e}`)}(s),t<0||t>r||e<0||e>r)throw new Error(`x and y must be unsigned normalized integers between 0 and ${r}`);if(s.x=Ao(t,r),s.y=Ao(e,r),s.z=1-(Math.abs(s.x)+Math.abs(s.y)),s.z<0){const t=s.x;s.x=(1-Math.abs(s.y))*Mo(t),s.y=(1-Math.abs(t))*Mo(s.y)}return s.normalize()}new Qe,new ur,new Qe,new Qe;class Io{constructor(t,e){this.json=t,this.buffer=e,this.featuresLength=0,this._cachedTypedArrays={}}getExtension(t){return this.json.extensions&&this.json.extensions[t]}hasProperty(t){return Boolean(this.json[t])}getGlobalProperty(t,e=To.UNSIGNED_INT,r=1){const s=this.json[t];return s&&Number.isFinite(s.byteOffset)?this._getTypedArrayFromBinary(t,e,r,1,s.byteOffset):s}getPropertyArray(t,e,r){const s=this.json[t];return s&&Number.isFinite(s.byteOffset)?("componentType"in s&&(e=So.fromName(s.componentType)),this._getTypedArrayFromBinary(t,e,r,this.featuresLength,s.byteOffset)):this._getTypedArrayFromArray(t,e,s)}getProperty(t,e,r,s,n){const i=this.json[t];if(!i)return i;const o=this.getPropertyArray(t,e,r);if(1===r)return o[s];for(let t=0;t<r;++t)n[t]=o[r*s+t];return n}_getTypedArrayFromBinary(t,e,r,s,n){const i=this._cachedTypedArrays;let o=i[t];return o||(o=So.createTypedArray(e,this.buffer.buffer,this.buffer.byteOffset+n,s*r),i[t]=o),o}_getTypedArrayFromArray(t,e,r){const s=this._cachedTypedArrays;let n=s[t];return n||(n=So.createTypedArray(e,r),s[t]=n),n}}const No={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Ro={SCALAR:(t,e)=>t[e],VEC2:(t,e)=>[t[2*e+0],t[2*e+1]],VEC3:(t,e)=>[t[3*e+0],t[3*e+1],t[3*e+2]],VEC4:(t,e)=>[t[4*e+0],t[4*e+1],t[4*e+2],t[4*e+3]],MAT2:(t,e)=>[t[4*e+0],t[4*e+1],t[4*e+2],t[4*e+3]],MAT3:(t,e)=>[t[9*e+0],t[9*e+1],t[9*e+2],t[9*e+3],t[9*e+4],t[9*e+5],t[9*e+6],t[9*e+7],t[9*e+8]],MAT4:(t,e)=>[t[16*e+0],t[16*e+1],t[16*e+2],t[16*e+3],t[16*e+4],t[16*e+5],t[16*e+6],t[16*e+7],t[16*e+8],t[16*e+9],t[16*e+10],t[16*e+11],t[16*e+12],t[16*e+13],t[16*e+14],t[16*e+15]]},Co={SCALAR:(t,e,r)=>{e[r]=t},VEC2:(t,e,r)=>{e[2*r+0]=t[0],e[2*r+1]=t[1]},VEC3:(t,e,r)=>{e[3*r+0]=t[0],e[3*r+1]=t[1],e[3*r+2]=t[2]},VEC4:(t,e,r)=>{e[4*r+0]=t[0],e[4*r+1]=t[1],e[4*r+2]=t[2],e[4*r+3]=t[3]},MAT2:(t,e,r)=>{e[4*r+0]=t[0],e[4*r+1]=t[1],e[4*r+2]=t[2],e[4*r+3]=t[3]},MAT3:(t,e,r)=>{e[9*r+0]=t[0],e[9*r+1]=t[1],e[9*r+2]=t[2],e[9*r+3]=t[3],e[9*r+4]=t[4],e[9*r+5]=t[5],e[9*r+6]=t[6],e[9*r+7]=t[7],e[9*r+8]=t[8],e[9*r+9]=t[9]},MAT4:(t,e,r)=>{e[16*r+0]=t[0],e[16*r+1]=t[1],e[16*r+2]=t[2],e[16*r+3]=t[3],e[16*r+4]=t[4],e[16*r+5]=t[5],e[16*r+6]=t[6],e[16*r+7]=t[7],e[16*r+8]=t[8],e[16*r+9]=t[9],e[16*r+10]=t[10],e[16*r+11]=t[11],e[16*r+12]=t[12],e[16*r+13]=t[13],e[16*r+14]=t[14],e[16*r+15]=t[15]}};const Lo=t=>void 0!==t;function Po(t,e,r){if(!e)return null;let s=t.getExtension("3DTILES_batch_table_hierarchy");const n=e.HIERARCHY;return n&&(console.warn("3D Tile Parser: HIERARCHY is deprecated. Use 3DTILES_batch_table_hierarchy."),e.extensions=e.extensions||{},e.extensions["3DTILES_batch_table_hierarchy"]=n,s=n),s?function(t,e){let r,s,n;const i=t.instancesLength,o=t.classes;let a,c=t.classIds,h=t.parentCounts,u=t.parentIds,l=i;Lo(c.byteOffset)&&(c.componentType=defaultValue(c.componentType,GL.UNSIGNED_SHORT),c.type=AttributeType.SCALAR,n=getBinaryAccessor(c),c=n.createArrayBufferView(e.buffer,e.byteOffset+c.byteOffset,i));if(Lo(h))for(Lo(h.byteOffset)&&(h.componentType=defaultValue(h.componentType,GL.UNSIGNED_SHORT),h.type=AttributeType.SCALAR,n=getBinaryAccessor(h),h=n.createArrayBufferView(e.buffer,e.byteOffset+h.byteOffset,i)),a=new Uint16Array(i),l=0,r=0;r<i;++r)a[r]=l,l+=h[r];Lo(u)&&Lo(u.byteOffset)&&(u.componentType=defaultValue(u.componentType,GL.UNSIGNED_SHORT),u.type=AttributeType.SCALAR,n=getBinaryAccessor(u),u=n.createArrayBufferView(e.buffer,e.byteOffset+u.byteOffset,l));const d=o.length;for(r=0;r<d;++r){const t=o[r].length,s=o[r].instances,n=getBinaryProperties(t,s,e);o[r].instances=combine(n,s)}const f=new Array(d).fill(0),m=new Uint16Array(i);for(r=0;r<i;++r)s=c[r],m[r]=f[s],++f[s];const p={classes:o,classIds:c,classIndexes:m,parentCounts:h,parentIndexes:a,parentIds:u};return function(t){const e=t.classIds.length;for(let r=0;r<e;++r)Uo(t,r,stack)}(p),p}(s,r):null}function ko(t,e,r){if(!t)return;const s=t.parentCounts;return t.parentIds?r(t,e):s>0?function(t,e,r){const s=t.classIds,n=t.parentCounts,i=t.parentIds,o=t.parentIndexes,a=s.length,c=scratchVisited;c.length=Math.max(c.length,a);const h=++marker,u=scratchStack;u.length=0,u.push(e);for(;u.length>0;){if(c[e=u.pop()]===h)continue;c[e]=h;const s=r(t,e);if(Lo(s))return s;const a=n[e],l=o[e];for(let t=0;t<a;++t){const r=i[l+t];r!==e&&u.push(r)}}return null}(t,e,r):function(t,e,r){let s=!0;for(;s;){const n=r(t,e);if(Lo(n))return n;const i=t.parentIds[e];s=i!==e,e=i}throw new Error("traverseHierarchySingleParent")}(t,e,r)}function Uo(t,e,r){const s=t.parentCounts,n=t.parentIds,i=t.parentIndexes,o=t.classIds.length;if(!Lo(n))return;assert(e<o,`Parent index ${e} exceeds the total number of instances: ${o}`),assert(-1===r.indexOf(e),"Circular dependency detected in the batch table hierarchy."),r.push(e);const a=Lo(s)?s[e]:1,c=Lo(s)?i[e]:e;for(let s=0;s<a;++s){const i=n[c+s];i!==e&&Uo(t,i,r)}r.pop(e)}function Do(t){return null!=t}const jo=(t,e)=>t,Bo={HIERARCHY:!0,extensions:!0,extras:!0};class Vo{constructor(t,e,r,s={}){var n;M(r>=0),this.json=t||{},this.binary=e,this.featureCount=r,this._extensions=(null===(n=this.json)||void 0===n?void 0:n.extensions)||{},this._properties={};for(const t in this.json)Bo[t]||(this._properties[t]=this.json[t]);this._binaryProperties=this._initializeBinaryProperties(),s["3DTILES_batch_table_hierarchy"]&&(this._hierarchy=Po(this,this.json,this.binary))}getExtension(t){return this.json&&this.json.extensions&&this.json.extensions[t]}memorySizeInBytes(){return 0}isClass(t,e){if(this._checkBatchId(t),M("string"==typeof e,e),this._hierarchy){return Do(ko(this._hierarchy,t,((t,r)=>{const s=t.classIds[r];return t.classes[s].name===e})))}return!1}isExactClass(t,e){return M("string"==typeof e,e),this.getExactClassName(t)===e}getExactClassName(t){if(this._checkBatchId(t),this._hierarchy){const e=this._hierarchy.classIds[t];return this._hierarchy.classes[e].name}}hasProperty(t,e){return this._checkBatchId(t),M("string"==typeof e,e),Do(this._properties[e])||this._hasPropertyInHierarchy(t,e)}getPropertyNames(t,e){this._checkBatchId(t),(e=Do(e)?e:[]).length=0;const r=Object.keys(this._properties);return e.push(...r),this._hierarchy&&this._getPropertyNamesInHierarchy(t,e),e}getProperty(t,e){if(this._checkBatchId(t),M("string"==typeof e,e),this._binaryProperties){const r=this._binaryProperties[e];if(Do(r))return this._getBinaryProperty(r,t)}const r=this._properties[e];if(Do(r))return jo(r[t]);if(this._hierarchy){const r=this._getHierarchyProperty(t,e);if(Do(r))return r}}setProperty(t,e,r){const s=this.featureCount;if(this._checkBatchId(t),M("string"==typeof e,e),this._binaryProperties){const s=this._binaryProperties[e];if(s)return void this._setBinaryProperty(s,t,r)}if(this._hierarchy&&this._setHierarchyProperty(this,t,e,r))return;let n=this._properties[e];Do(n)||(this._properties[e]=new Array(s),n=this._properties[e]),n[t]=jo(r)}_checkBatchId(t){if(!(t>=0&&t<this.featureCount))throw new Error("batchId not in range [0, featureCount - 1].")}_getBinaryProperty(t,e){return t.unpack(t.typedArray,e)}_setBinaryProperty(t,e,r){t.pack(r,t.typedArray,e)}_initializeBinaryProperties(){let t=null;for(const e in this._properties){const r=this._properties[e],s=this._initializeBinaryProperty(e,r);s&&(t=t||{},t[e]=s)}return t}_initializeBinaryProperty(t,e){if("byteOffset"in e){const r=e;M(this.binary,`Property ${t} requires a batch table binary.`),M(r.type,`Property ${t} requires a type.`);const s=function(t,e,r,s){const{componentType:n}=t;M(t.componentType);const i="string"==typeof n?So.fromName(n):n,o=No[t.type],a=Ro[t.type],c=Co[t.type];return r+=t.byteOffset,{values:So.createTypedArray(i,e,r,o*s),type:i,size:o,unpacker:a,packer:c}}(r,this.binary.buffer,0|this.binary.byteOffset,this.featureCount);return{typedArray:s.values,componentCount:s.size,unpack:s.unpacker,pack:s.packer}}return null}_hasPropertyInHierarchy(t,e){if(!this._hierarchy)return!1;const r=ko(this._hierarchy,t,((t,r)=>{const s=t.classIds[r];return Do(t.classes[s].instances[e])}));return Do(r)}_getPropertyNamesInHierarchy(t,e){ko(this._hierarchy,t,((t,r)=>{const s=t.classIds[r],n=t.classes[s].instances;for(const t in n)n.hasOwnProperty(t)&&-1===e.indexOf(t)&&e.push(t)}))}_getHierarchyProperty(t,e){return ko(this._hierarchy,t,((t,r)=>{const s=t.classIds[r],n=t.classes[s],i=t.classIndexes[r],o=n.instances[e];return Do(o)?Do(o.typedArray)?this._getBinaryProperty(o,i):jo(o[i]):null}))}_setHierarchyProperty(t,e,r,s){const n=ko(this._hierarchy,e,((t,n)=>{const i=t.classIds[n],o=t.classes[i],a=t.classIndexes[n],c=o.instances[r];return!!Do(c)&&(M(n===e,`Inherited property "${r}" is read-only.`),Do(c.typedArray)?this._setBinaryProperty(c,a,s):c[a]=jo(s),!0)}));return Do(n)}}function Fo(t,e,r=0){const s=new DataView(e);if(t.magic=s.getUint32(r,!0),r+=4,t.version=s.getUint32(r,!0),r+=4,t.byteLength=s.getUint32(r,!0),r+=4,1!==t.version)throw new Error(`3D Tile Version ${t.version} not supported`);return r}function qo(t,e,r){const s=new DataView(e);let n;t.header=t.header||{};let i=s.getUint32(r,!0);r+=4;let o=s.getUint32(r,!0);r+=4;let a=s.getUint32(r,!0);r+=4;let c=s.getUint32(r,!0);return r+=4,a>=570425344?(r-=8,n=i,a=o,c=0,i=0,o=0,console.warn("b3dm tile in legacy format.")):c>=570425344&&(r-=4,n=a,a=i,c=o,i=0,o=0,console.warn("b3dm tile in legacy format.")),t.header.featureTableJsonByteLength=i,t.header.featureTableBinaryByteLength=o,t.header.batchTableJsonByteLength=a,t.header.batchTableBinaryByteLength=c,t.header.batchLength=n,r}function zo(t,e,r,s){return r=function(t,e,r,s){const{featureTableJsonByteLength:n,featureTableBinaryByteLength:i,batchLength:o}=t.header;if(t.featureTableJson={BATCH_LENGTH:o||0},n>0){const s=Bi(e,r,n);t.featureTableJson=JSON.parse(s)}return r+=n,t.featureTableBinary=new Uint8Array(e,r,i),r+=i}(t,e,r),r=function(t,e,r,s){const{batchTableJsonByteLength:n,batchTableBinaryByteLength:i}=t.header;if(n>0){const s=Bi(e,r,n);t.batchTableJson=JSON.parse(s),r+=n,i>0&&(t.batchTableBinary=new Uint8Array(e,r,i),t.batchTableBinary=new Uint8Array(t.batchTableBinary),r+=i)}return r}(t,e,r)}function Go(t,e,r){if(!(e||t&&t.batchIds&&r))return null;const{batchIds:s,isRGB565:n,pointCount:i}=t;if(s&&r){const t=new Uint8ClampedArray(3*i);for(let e=0;e<i;e++){const n=s[e],i=r.getProperty(n,"dimensions").map((t=>255*t));t[3*e]=i[0],t[3*e+1]=i[1],t[3*e+2]=i[2]}return{type:To.UNSIGNED_BYTE,value:t,size:3,normalized:!0}}if(n){const t=new Uint8ClampedArray(3*i);for(let r=0;r<i;r++){const s=xo(e[r]);t[3*r]=s[0],t[3*r+1]=s[1],t[3*r+2]=s[2]}return{type:To.UNSIGNED_BYTE,value:t,size:3,normalized:!0}}return e&&e.length===3*i?{type:To.UNSIGNED_BYTE,value:e,size:3,normalized:!0}:{type:To.UNSIGNED_BYTE,value:e,size:4,normalized:!0}}const $o=new ur;function Wo(t,e,r){return t.isQuantized?r["3d-tiles"]&&r["3d-tiles"].decodeQuantizedPositions?(t.isQuantized=!1,function(t,e){const r=new ur,s=new Float32Array(3*t.pointCount);for(let n=0;n<t.pointCount;n++)r.set(e[3*n],e[3*n+1],e[3*n+2]).scale(1/t.quantizedRange).multiply(t.quantizedVolumeScale).add(t.quantizedVolumeOffset).toArray(s,3*n);return s}(t,e)):{type:To.UNSIGNED_SHORT,value:e,size:3,normalized:!0}:e}async function Ho(t,e,r,s,n){r=zo(t,e,r=qo(t,e,r=Fo(t,e,r))),function(t){t.attributes={positions:null,colors:null,normals:null,batchIds:null},t.isQuantized=!1,t.isTranslucent=!1,t.isRGB565=!1,t.isOctEncoded16P=!1}(t);const{featureTable:i,batchTable:o}=function(t){const e=new Io(t.featureTableJson,t.featureTableBinary),r=e.getGlobalProperty("POINTS_LENGTH");if(!Number.isFinite(r))throw new Error("POINTS_LENGTH must be defined");e.featuresLength=r,t.featuresLength=r,t.pointsLength=r,t.pointCount=r,t.rtcCenter=e.getGlobalProperty("RTC_CENTER",To.FLOAT,3);const s=function(t,e){let r=null;if(!t.batchIds&&e.hasProperty("BATCH_ID")&&(t.batchIds=e.getPropertyArray("BATCH_ID",To.UNSIGNED_SHORT,1),t.batchIds)){const s=e.getGlobalProperty("BATCH_LENGTH");if(!s)throw new Error("Global property: BATCH_LENGTH must be defined when BATCH_ID is defined.");const{batchTableJson:n,batchTableBinary:i}=t;r=new Vo(n,i,s)}return r}(t,e);return{featureTable:e,batchTable:s}}(t);return await async function(t,e,r,s,n){let i,o,a;const c=t.batchTableJson&&t.batchTableJson.extensions&&t.batchTableJson.extensions["3DTILES_draco_point_compression"];c&&(a=c.properties);const h=e.getExtension("3DTILES_draco_point_compression");if(h){o=h.properties;const e=h.byteOffset,r=h.byteLength;if(!o||!Number.isFinite(e)||!r)throw new Error("Draco properties, byteOffset, and byteLength must be defined");i=t.featureTableBinary.slice(e,e+r),t.hasPositions=Number.isFinite(o.POSITION),t.hasColors=Number.isFinite(o.RGB)||Number.isFinite(o.RGBA),t.hasNormals=Number.isFinite(o.NORMAL),t.hasBatchIds=Number.isFinite(o.BATCH_ID),t.isTranslucent=Number.isFinite(o.RGBA)}if(!i)return!0;const u={buffer:i,properties:{...o,...a},featureTableProperties:o,batchTableProperties:a,dequantizeInShader:!1};return await async function(t,e,r,s){const{parse:n}=s,i={...r,draco:{...r.draco,extraAttributes:e.batchTableProperties||{}}};delete i["3d-tiles"];const o=await n(e.buffer,bo,i),a=o.attributes.POSITION&&o.attributes.POSITION.value,c=o.attributes.COLOR_0&&o.attributes.COLOR_0.value,h=o.attributes.NORMAL&&o.attributes.NORMAL.value,u=o.attributes.BATCH_ID&&o.attributes.BATCH_ID.value,l=a&&o.attributes.POSITION.value.quantization,d=h&&o.attributes.NORMAL.value.quantization;if(l){const e=o.POSITION.data.quantization,r=e.range;t.quantizedVolumeScale=new ur(r,r,r),t.quantizedVolumeOffset=new ur(e.minValues),t.quantizedRange=(1<<e.quantizationBits)-1,t.isQuantizedDraco=!0}d&&(t.octEncodedRange=(1<<o.NORMAL.data.quantization.quantizationBits)-1,t.isOctEncodedDraco=!0);const f={};if(e.batchTableProperties)for(const t of Object.keys(e.batchTableProperties))o.attributes[t]&&o.attributes[t].value&&(f[t.toLowerCase()]=o.attributes[t].value);t.attributes={positions:a,colors:Go(t,c),normals:h,batchIds:u,...f}}(t,u,s,n)}(t,i,0,s,n),function(t,e,r){if(!t.attributes.positions)if(e.hasProperty("POSITION"))t.attributes.positions=e.getPropertyArray("POSITION",To.FLOAT,3);else if(e.hasProperty("POSITION_QUANTIZED")){const s=e.getPropertyArray("POSITION_QUANTIZED",To.UNSIGNED_SHORT,3);if(t.isQuantized=!0,t.quantizedRange=65535,t.quantizedVolumeScale=e.getGlobalProperty("QUANTIZED_VOLUME_SCALE",To.FLOAT,3),!t.quantizedVolumeScale)throw new Error("QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");if(t.quantizedVolumeOffset=e.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",To.FLOAT,3),!t.quantizedVolumeOffset)throw new Error("QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");t.attributes.positions=Wo(t,s,r)}if(!t.attributes.positions)throw new Error("Either POSITION or POSITION_QUANTIZED must be defined.")}(t,i,s),function(t,e,r){if(!t.attributes.colors){let s=null;e.hasProperty("RGBA")?(s=e.getPropertyArray("RGBA",To.UNSIGNED_BYTE,4),t.isTranslucent=!0):e.hasProperty("RGB")?s=e.getPropertyArray("RGB",To.UNSIGNED_BYTE,3):e.hasProperty("RGB565")&&(s=e.getPropertyArray("RGB565",To.UNSIGNED_SHORT,1),t.isRGB565=!0),t.attributes.colors=Go(t,s,r)}e.hasProperty("CONSTANT_RGBA")&&(t.constantRGBA=e.getGlobalProperty("CONSTANT_RGBA",To.UNSIGNED_BYTE,4))}(t,i,o),function(t,e){if(!t.attributes.normals){let r=null;e.hasProperty("NORMAL")?r=e.getPropertyArray("NORMAL",To.FLOAT,3):e.hasProperty("NORMAL_OCT16P")&&(r=e.getPropertyArray("NORMAL_OCT16P",To.UNSIGNED_BYTE,2),t.isOctEncoded16P=!0),t.attributes.normals=function(t,e){if(!e)return null;if(t.isOctEncoded16P){const r=new Float32Array(3*t.pointsLength);for(let s=0;s<t.pointsLength;s++)Oo(e[2*s],e[2*s+1],255,$o),$o.toArray(r,3*s);return{type:To.FLOAT,size:2,value:r}}return{type:To.FLOAT,size:2,value:e}}(t,r)}}(t,i),r}function Qo(t,e){if(!t)throw new Error(e)}const Ko={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:"undefined"!=typeof global&&global,document:"undefined"!=typeof document&&document},Yo=Ko.global||Ko.self||Ko.window,Zo="object"!=typeof process||"[object process]"!==String(process)||process.browser,Jo="undefined"!=typeof process&&process.version&&/v([0-9]*)/.exec(process.version);Jo&&parseFloat(Jo[1]);const{_parseImageNode:Xo}=Yo,ta="undefined"!=typeof Image,ea="undefined"!=typeof ImageBitmap,ra=Boolean(Xo),sa=!!Zo||ra;function na(t){const e=function(t){if("undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap)return"imagebitmap";if("undefined"!=typeof Image&&t instanceof Image)return"image";if(t&&"object"==typeof t&&t.data&&t.width&&t.height)return"data";return null}(t);if(!e)throw new Error("Not an image");return e}const ia=/^data:image\/svg\+xml/,oa=/\.svg((\?|#).*)?$/;function aa(t){return t&&(ia.test(t)||oa.test(t))}function ca(t,e){if(aa(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(t)])}async function ha(t,e,r){const s=function(t,e){if(aa(e)){let e=(new TextDecoder).decode(t);try{"function"==typeof unescape&&"function"==typeof encodeURIComponent&&(e=unescape(encodeURIComponent(e)))}catch(t){throw new Error(t.message)}return`data:image/svg+xml;base64,${btoa(e)}`}return ca(t,e)}(t,r),n=self.URL||self.webkitURL,i="string"!=typeof s&&n.createObjectURL(s);try{return await async function(t,e){const r=new Image;if(r.src=t,e.image&&e.image.decode&&r.decode)return await r.decode(),r;return await new Promise(((e,s)=>{try{r.onload=()=>e(r),r.onerror=e=>s(new Error(`Could not load image ${t}: ${e}`))}catch(t){s(t)}}))}(i||s,e)}finally{i&&n.revokeObjectURL(i)}}const ua={};let la=!0;async function da(t,e,r){let s;if(aa(r)){s=await ha(t,e,r)}else s=ca(t,r);const n=e&&e.imagebitmap;return await async function(t,e=null){!function(t){for(const e in t||ua)return!1;return!0}(e)&&la||(e=null);if(e)try{return await createImageBitmap(t,e)}catch(t){console.warn(t),la=!1}return await createImageBitmap(t)}(s,n)}function fa(t){const e=ma(t);return function(t){const e=ma(t);if(!(e.byteLength>=24&&2303741511===e.getUint32(0,false)))return null;return{mimeType:"image/png",width:e.getUint32(16,false),height:e.getUint32(20,false)}}(e)||function(t){const e=ma(t);if(!(e.byteLength>=3&&65496===e.getUint16(0,false)&&255===e.getUint8(2)))return null;const{tableMarkers:r,sofMarkers:s}=function(){const t=new Set([65499,65476,65484,65501,65534]);for(let e=65504;e<65520;++e)t.add(e);const e=new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502]);return{tableMarkers:t,sofMarkers:e}}();let n=2;for(;n+9<e.byteLength;){const t=e.getUint16(n,false);if(s.has(t))return{mimeType:"image/jpeg",height:e.getUint16(n+5,false),width:e.getUint16(n+7,false)};if(!r.has(t))return null;n+=2,n+=e.getUint16(n,false)}return null}(e)||function(t){const e=ma(t);if(!(e.byteLength>=10&&1195984440===e.getUint32(0,false)))return null;return{mimeType:"image/gif",width:e.getUint16(6,true),height:e.getUint16(8,true)}}(e)||function(t){const e=ma(t);if(!(e.byteLength>=14&&16973===e.getUint16(0,false)&&e.getUint32(2,true)===e.byteLength))return null;return{mimeType:"image/bmp",width:e.getUint32(18,true),height:e.getUint32(22,true)}}(e)}function ma(t){if(t instanceof DataView)return t;if(ArrayBuffer.isView(t))return new DataView(t.buffer);if(t instanceof ArrayBuffer)return new DataView(t);throw new Error("toDataView")}const pa={id:"image",module:"images",name:"Images",version:"3.0.10",mimeTypes:["image/png","image/jpeg","image/gif","image/webp","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],extensions:["png","jpg","jpeg","gif","webp","bmp","ico","svg"],parse:async function(t,e,r){const s=((e=e||{}).image||{}).type||"auto",{url:n}=r||{};let i;switch(function(t){switch(t){case"auto":case"data":return function(){if(ea)return"imagebitmap";if(ta)return"image";if(sa)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}();default:return function(t){switch(t){case"auto":return ea||ta||sa;case"imagebitmap":return ea;case"image":return ta;case"data":return sa;default:throw new Error(`@loaders.gl/images: image ${t} not supported in this environment`)}}(t),t}}(s)){case"imagebitmap":i=await da(t,e,n);break;case"image":i=await ha(t,e,n);break;case"data":i=await function(t,e){const{mimeType:r}=fa(t)||{},{_parseImageNode:s}=Yo;return Qo(s),s(t,r,e)}(t,e);break;default:Qo(!1)}return"data"===s&&(i=function(t){switch(na(t)){case"data":return t;case"image":case"imagebitmap":const e=document.createElement("canvas"),r=e.getContext("2d");if(!r)throw new Error("getImageData");return e.width=t.width,e.height=t.height,r.drawImage(t,0,0),r.getImageData(0,0,t.width,t.height);default:throw new Error("getImageData")}}(i)),i},tests:[t=>Boolean(fa(new DataView(t)))],options:{image:{type:"auto",decode:!0}}};function ga(t,e){if(!t)throw new Error(e||"assert failed: gltf")}function ya(t,e){if(t.startsWith("data:")||t.startsWith("http:")||t.startsWith("https:"))return t;const r=e.baseUri||e.uri;if(!r)throw new Error(`'baseUri' must be provided to resolve relative url ${t}`);return r.substr(0,r.lastIndexOf("/")+1)+t}const wa=["SCALAR","VEC2","VEC3","VEC4"],ba=[[Int8Array,5120],[Uint8Array,5121],[Int16Array,5122],[Uint16Array,5123],[Uint32Array,5125],[Float32Array,5126],[Float64Array,5130]],_a=new Map(ba),Ta={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},va={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},Ea={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function Sa(t){return wa[t-1]||wa[0]}function xa(t){const e=_a.get(t.constructor);if(!e)throw new Error("Illegal typed array");return e}function Aa(t,e){const r=Ea[t.componentType],s=Ta[t.type],n=va[t.componentType],i=t.count*s,o=t.count*s*n;return ga(o>=0&&o<=e.byteLength),{ArrayType:r,length:i,byteLength:o}}const Ma={asset:{version:"2.0",generator:"loaders.gl"},buffers:[]};class Oa{constructor(t){B(this,"gltf",void 0),B(this,"sourceBuffers",void 0),B(this,"byteLength",void 0),this.gltf=t||{json:{...Ma},buffers:[]},this.sourceBuffers=[],this.byteLength=0,this.gltf.buffers&&this.gltf.buffers[0]&&(this.byteLength=this.gltf.buffers[0].byteLength,this.sourceBuffers=[this.gltf.buffers[0]])}get json(){return this.gltf.json}getApplicationData(t){return this.json[t]}getExtraData(t){return(this.json.extras||{})[t]}getExtension(t){const e=this.getUsedExtensions().find((e=>e===t)),r=this.json.extensions||{};return e?r[t]||!0:null}getRequiredExtension(t){return this.getRequiredExtensions().find((e=>e===t))?this.getExtension(t):null}getRequiredExtensions(){return this.json.extensionsRequired||[]}getUsedExtensions(){return this.json.extensionsUsed||[]}getObjectExtension(t,e){return(t.extensions||{})[e]}getScene(t){return this.getObject("scenes",t)}getNode(t){return this.getObject("nodes",t)}getSkin(t){return this.getObject("skins",t)}getMesh(t){return this.getObject("meshes",t)}getMaterial(t){return this.getObject("materials",t)}getAccessor(t){return this.getObject("accessors",t)}getTexture(t){return this.getObject("textures",t)}getSampler(t){return this.getObject("samplers",t)}getImage(t){return this.getObject("images",t)}getBufferView(t){return this.getObject("bufferViews",t)}getBuffer(t){return this.getObject("buffers",t)}getObject(t,e){if("object"==typeof e)return e;const r=this.json[t]&&this.json[t][e];if(!r)throw new Error(`glTF file error: Could not find ${t}[${e}]`);return r}getTypedArrayForBufferView(t){const e=(t=this.getBufferView(t)).buffer,r=this.gltf.buffers[e];ga(r);const s=(t.byteOffset||0)+r.byteOffset;return new Uint8Array(r.arrayBuffer,s,t.byteLength)}getTypedArrayForAccessor(t){t=this.getAccessor(t);const e=this.getBufferView(t.bufferView),r=this.getBuffer(e.buffer).data,{ArrayType:s,length:n}=Aa(t,e);return new s(r,e.byteOffset+t.byteOffset,n)}getTypedArrayForImageData(t){t=this.getAccessor(t);const e=this.getBufferView(t.bufferView),r=this.getBuffer(e.buffer).data,s=e.byteOffset||0;return new Uint8Array(r,s,e.byteLength)}addApplicationData(t,e){return this.json[t]=e,this}addExtraData(t,e){return this.json.extras=this.json.extras||{},this.json.extras[t]=e,this}addObjectExtension(t,e,r){return t.extensions=t.extensions||{},t.extensions[e]=r,this.registerUsedExtension(e),this}setObjectExtension(t,e,r){(t.extensions||{})[e]=r}removeObjectExtension(t,e){const r=t.extensions||{},s=r[e];return delete r[e],s}addExtension(t,e={}){return ga(e),this.json.extensions=this.json.extensions||{},this.json.extensions[t]=e,this.registerUsedExtension(t),e}addRequiredExtension(t,e={}){return ga(e),this.addExtension(t,e),this.registerRequiredExtension(t),e}registerUsedExtension(t){this.json.extensionsUsed=this.json.extensionsUsed||[],this.json.extensionsUsed.find((e=>e===t))||this.json.extensionsUsed.push(t)}registerRequiredExtension(t){this.registerUsedExtension(t),this.json.extensionsRequired=this.json.extensionsRequired||[],this.json.extensionsRequired.find((e=>e===t))||this.json.extensionsRequired.push(t)}removeExtension(t){this.json.extensionsRequired&&this._removeStringFromArray(this.json.extensionsRequired,t),this.json.extensionsUsed&&this._removeStringFromArray(this.json.extensionsUsed,t),this.json.extensions&&delete this.json.extensions[t]}setDefaultScene(t){this.json.scene=t}addScene(t){const{nodeIndices:e}=t;return this.json.scenes=this.json.scenes||[],this.json.scenes.push({nodes:e}),this.json.scenes.length-1}addNode(t){const{meshIndex:e,matrix:r}=t;this.json.nodes=this.json.nodes||[];const s={mesh:e};return r&&(s.matrix=r),this.json.nodes.push(s),this.json.nodes.length-1}addMesh(t){const{attributes:e,indices:r,material:s,mode:n=4}=t,i={primitives:[{attributes:this._addAttributes(e),mode:n}]};if(r){const t=this._addIndices(r);i.primitives[0].indices=t}return Number.isFinite(s)&&(i.primitives[0].material=s),this.json.meshes=this.json.meshes||[],this.json.meshes.push(i),this.json.meshes.length-1}addPointCloud(t){const e={primitives:[{attributes:this._addAttributes(t),mode:0}]};return this.json.meshes=this.json.meshes||[],this.json.meshes.push(e),this.json.meshes.length-1}addImage(t,e){const r=fa(t),s=e||(null==r?void 0:r.mimeType),n={bufferView:this.addBufferView(t),mimeType:s};return this.json.images=this.json.images||[],this.json.images.push(n),this.json.images.length-1}addBufferView(t){const e=t.byteLength;ga(Number.isFinite(e)),this.sourceBuffers=this.sourceBuffers||[],this.sourceBuffers.push(t);const r={buffer:0,byteOffset:this.byteLength,byteLength:e};return this.byteLength+=ot(e,4),this.json.bufferViews=this.json.bufferViews||[],this.json.bufferViews.push(r),this.json.bufferViews.length-1}addAccessor(t,e){const r={bufferView:t,type:Sa(e.size),componentType:e.componentType,count:e.count,max:e.max,min:e.min};return this.json.accessors=this.json.accessors||[],this.json.accessors.push(r),this.json.accessors.length-1}addBinaryBuffer(t,e={size:3}){const r=this.addBufferView(t);let s={min:e.min,max:e.max};s.min&&s.max||(s=this._getAccessorMinMax(t,e.size));const n={size:e.size,componentType:xa(t),count:Math.round(t.length/e.size),min:s.min,max:s.max};return this.addAccessor(r,Object.assign(n,e))}addTexture(t){const{imageIndex:e}=t,r={source:e};return this.json.textures=this.json.textures||[],this.json.textures.push(r),this.json.textures.length-1}addMaterial(t){return this.json.materials=this.json.materials||[],this.json.materials.push(t),this.json.materials.length-1}createBinaryChunk(){var t,e;this.gltf.buffers=[];const r=this.byteLength,s=new ArrayBuffer(r),n=new Uint8Array(s);let i=0;for(const t of this.sourceBuffers||[])i=at(t,n,i);null!==(t=this.json)&&void 0!==t&&null!==(e=t.buffers)&&void 0!==e&&e[0]?this.json.buffers[0].byteLength=r:this.json.buffers=[{byteLength:r}],this.gltf.binary=s,this.sourceBuffers=[s]}_removeStringFromArray(t,e){let r=!0;for(;r;){const s=t.indexOf(e);s>-1?t.splice(s,1):r=!1}}_addAttributes(t={}){const e={};for(const r in t){const s=t[r],n=this._getGltfAttributeName(r),i=this.addBinaryBuffer(s.value,s);e[n]=i}return e}_addIndices(t){return this.addBinaryBuffer(t,{size:1})}_getGltfAttributeName(t){switch(t.toLowerCase()){case"position":case"positions":case"vertices":return"POSITION";case"normal":case"normals":return"NORMAL";case"color":case"colors":return"COLOR_0";case"texcoord":case"texcoords":return"TEXCOORD_0";default:return t}}_getAccessorMinMax(t,e){const r={min:null,max:null};if(t.length<e)return r;r.min=[],r.max=[];const s=t.subarray(0,e);for(const t of s)r.min.push(t),r.max.push(t);for(let s=e;s<t.length;s+=e)for(let n=0;n<e;n++)r.min[0+n]=Math.min(r.min[0+n],t[s+n]),r.max[0+n]=Math.max(r.max[0+n],t[s+n]);return r}}function Ia(t){const{buffer:e,size:r,count:s}=function(t){let e=t,r=1,s=0;t&&t.value&&(e=t.value,r=t.size||1);e&&(ArrayBuffer.isView(e)||(e=function(t,e,r=!1){if(!t)return null;if(Array.isArray(t))return new e(t);if(r&&!(t instanceof e))return new e(t);return t}(e,Float32Array)),s=e.length/r);return{buffer:e,size:r,count:s}}(t);return{value:e,size:r,byteOffset:0,count:s,type:Sa(r),componentType:xa(e)}}async function Na(t,e,r,s){const n=t.getObjectExtension(e,"KHR_draco_mesh_compression");if(!n)return;const i=t.getTypedArrayForBufferView(n.bufferView),o=it(i.buffer,i.byteOffset),{parse:a}=s,c={...r};delete c["3d-tiles"];const h=await a(o,bo,c,s),u=function(t){const e={};for(const r in t){const s=t[r];if("indices"!==r){const t=Ia(s);e[r]=t}}return e}(h.attributes);for(const[r,s]of Object.entries(u))if(r in e.attributes){const n=e.attributes[r],i=t.getAccessor(n);null!=i&&i.min&&null!=i&&i.max&&(s.min=i.min,s.max=i.max)}e.attributes=u,h.indices&&(e.indices=Ia(h.indices)),function(t){if(!t.attributes&&Object.keys(t.attributes).length>0)throw new Error("glTF: Empty primitive detected: Draco decompression failure?")}(e)}function Ra(t,e,r=4,s,n){var i;if(!s.DracoWriter)throw new Error("options.gltf.DracoWriter not provided");const o=s.DracoWriter.encodeSync({attributes:t}),a=null==n||null===(i=n.parseSync)||void 0===i?void 0:i.call(n,{attributes:t}),c=s._addFauxAttributes(a.attributes);return{primitives:[{attributes:c,mode:r,extensions:{KHR_draco_mesh_compression:{bufferView:s.addBufferView(o),attributes:c}}}]}}function Ca(t,e){const r=Object.assign({},t.values);return Object.keys(t.uniforms||{}).forEach((e=>{t.uniforms[e].value&&!(e in r)&&(r[e]=t.uniforms[e].value)})),Object.keys(r).forEach((t=>{"object"==typeof r[t]&&void 0!==r[t].index&&(r[t].texture=e.getTexture(r[t].index))})),r}const La={KHR_draco_mesh_compression:Object.freeze({__proto__:null,decode:async function(t,e,r){var s;if(null==e||null===(s=e.gltf)||void 0===s||!s.decompressMeshes)return;const n=new Oa(t),i=[];for(const t of function*(t){for(const e of t.json.meshes||[])for(const t of e.primitives)yield t}(n))n.getObjectExtension(t,"KHR_draco_mesh_compression")&&i.push(Na(n,t,e,r));await Promise.all(i),n.removeExtension("KHR_draco_mesh_compression")},encode:function(t,e={}){const r=new Oa(t);for(const t of r.json.meshes||[])Ra(t),r.addRequiredExtension("KHR_draco_mesh_compression")}}),KHR_materials_unlit:Object.freeze({__proto__:null,decode:async function(t){const e=new Oa(t),{json:r}=e;e.removeExtension("KHR_materials_unlit");for(const t of r.materials||[]){t.extensions&&t.extensions.KHR_materials_unlit&&(t.unlit=!0),e.removeObjectExtension(t,"KHR_materials_unlit")}},encode:function(t){const e=new Oa(t),{json:r}=e;if(e.materials)for(const t of r.materials||[])t.unlit&&(delete t.unlit,e.addObjectExtension(t,"KHR_materials_unlit",{}),e.addExtension("KHR_materials_unlit"))}}),KHR_lights_punctual:Object.freeze({__proto__:null,decode:async function(t){const e=new Oa(t),{json:r}=e,s=e.getExtension("KHR_lights_punctual");s&&(e.json.lights=s.lights,e.removeExtension("KHR_lights_punctual"));for(const t of r.nodes||[]){const r=e.getObjectExtension(t,"KHR_lights_punctual");r&&(t.light=r.light),e.removeObjectExtension(t,"KHR_lights_punctual")}},encode:async function(t){const e=new Oa(t),{json:r}=e;if(r.lights){const t=e.addExtension("KHR_lights_punctual");ga(!t.lights),t.lights=r.lights,delete r.lights}if(e.json.lights){for(const t of e.json.lights){const r=t.node;e.addObjectExtension(r,"KHR_lights_punctual",t)}delete e.json.lights}}}),KHR_techniques_webgl:Object.freeze({__proto__:null,decode:async function(t){const e=new Oa(t),{json:r}=e,s=e.getExtension("KHR_techniques_webgl");if(s){const t=function(t,e){const{programs:r=[],shaders:s=[],techniques:n=[]}=t,i=new TextDecoder;return s.forEach((t=>{if(!Number.isFinite(t.bufferView))throw new Error("KHR_techniques_webgl: no shader code");t.code=i.decode(e.getTypedArrayForBufferView(t.bufferView))})),r.forEach((t=>{t.fragmentShader=s[t.fragmentShader],t.vertexShader=s[t.vertexShader]})),n.forEach((t=>{t.program=r[t.program]})),n}(s,e);for(const s of r.materials||[]){const r=e.getObjectExtension(s,"KHR_techniques_webgl");r&&(s.technique=Object.assign({},r,t[r.technique]),s.technique.values=Ca(s.technique,e)),e.removeObjectExtension(s,"KHR_techniques_webgl")}e.removeExtension("KHR_techniques_webgl")}},encode:async function(t,e){}})};const Pa={accessors:"accessor",animations:"animation",buffers:"buffer",bufferViews:"bufferView",images:"image",materials:"material",meshes:"mesh",nodes:"node",samplers:"sampler",scenes:"scene",skins:"skin",textures:"texture"},ka={accessor:"accessors",animations:"animation",buffer:"buffers",bufferView:"bufferViews",image:"images",material:"materials",mesh:"meshes",node:"nodes",sampler:"samplers",scene:"scenes",skin:"skins",texture:"textures"};class Ua{constructor(t){this.idToIndexMap={animations:{},accessors:{},buffers:{},bufferViews:{},images:{},materials:{},meshes:{},nodes:{},samplers:{},scenes:{},skins:{},textures:{}}}normalize(t,e){this.json=t.json;const r=t.json;switch(r.asset&&r.asset.version){case"2.0":return;case void 0:case"1.0":break;default:return void console.warn(`glTF: Unknown version ${r.asset.version}`)}if(!e.normalize)throw new Error("glTF v1 is not supported.");console.warn("Converting glTF v1 to glTF v2 format. This is experimental and may fail."),this._addAsset(r),this._convertTopLevelObjectsToArrays(r),function(t){const e=new Oa(t),{json:r}=e;for(const t of r.images||[]){const r=e.removeObjectExtension(t,"KHR_binary_glTF");r&&Object.assign(t,r)}r.buffers&&r.buffers[0]&&delete r.buffers[0].uri,e.removeExtension("KHR_binary_glTF")}(t),this._convertObjectIdsToArrayIndices(r),this._updateObjects(r),this._updateMaterial(r)}_addAsset(t){t.asset=t.asset||{},t.asset.version="2.0",t.asset.generator=t.asset.generator||"Normalized to glTF 2.0 by loaders.gl"}_convertTopLevelObjectsToArrays(t){for(const e in Pa)this._convertTopLevelObjectToArray(t,e)}_convertTopLevelObjectToArray(t,e){const r=t[e];if(r&&!Array.isArray(r)){t[e]=[];for(const s in r){const n=r[s];n.id=n.id||s;const i=t[e].length;t[e].push(n),this.idToIndexMap[e][s]=i}}}_convertObjectIdsToArrayIndices(t){for(const e in Pa)this._convertIdsToIndices(t,e);"scene"in t&&(t.scene=this._convertIdToIndex(t.scene,"scene"));for(const e of t.textures)this._convertTextureIds(e);for(const e of t.meshes)this._convertMeshIds(e);for(const e of t.nodes)this._convertNodeIds(e);for(const e of t.scenes)this._convertSceneIds(e)}_convertTextureIds(t){t.source&&(t.source=this._convertIdToIndex(t.source,"image"))}_convertMeshIds(t){for(const e of t.primitives){const{attributes:t,indices:r,material:s}=e;for(const e in t)t[e]=this._convertIdToIndex(t[e],"accessor");r&&(e.indices=this._convertIdToIndex(r,"accessor")),s&&(e.material=this._convertIdToIndex(s,"material"))}}_convertNodeIds(t){t.children&&(t.children=t.children.map((t=>this._convertIdToIndex(t,"node")))),t.meshes&&(t.meshes=t.meshes.map((t=>this._convertIdToIndex(t,"mesh"))))}_convertSceneIds(t){t.nodes&&(t.nodes=t.nodes.map((t=>this._convertIdToIndex(t,"node"))))}_convertIdsToIndices(t,e){t[e]||(console.warn(`gltf v1: json doesn't contain attribute ${e}`),t[e]=[]);for(const r of t[e])for(const t in r){const e=r[t],s=this._convertIdToIndex(e,t);r[t]=s}}_convertIdToIndex(t,e){const r=ka[e];if(r in this.idToIndexMap){const s=this.idToIndexMap[r][t];if(!Number.isFinite(s))throw new Error(`gltf v1: failed to resolve ${e} with id ${t}`);return s}return t}_updateObjects(t){for(const t of this.json.buffers)delete t.type}_updateMaterial(t){for(const e of t.materials){e.pbrMetallicRoughness={baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1};const r=e.values&&e.values.tex,s=t.textures.findIndex((t=>t.id===r));-1!==s&&(e.pbrMetallicRoughness.baseColorTexture={index:s})}}}const Da={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ja={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},Ba={TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,REPEAT:10497,LINEAR:9729,NEAREST_MIPMAP_LINEAR:9986},Va={magFilter:Ba.TEXTURE_MAG_FILTER,minFilter:Ba.TEXTURE_MIN_FILTER,wrapS:Ba.TEXTURE_WRAP_S,wrapT:Ba.TEXTURE_WRAP_T},Fa={[Ba.TEXTURE_MAG_FILTER]:Ba.LINEAR,[Ba.TEXTURE_MIN_FILTER]:Ba.NEAREST_MIPMAP_LINEAR,[Ba.TEXTURE_WRAP_S]:Ba.REPEAT,[Ba.TEXTURE_WRAP_]:Ba.REPEAT};class qa{postProcess(t,e={}){const{json:r,buffers:s=[],images:n=[],baseUri:i=""}=t;return ga(r),this.baseUri=i,this.json=r,this.buffers=s,this.images=n,this._resolveTree(this.json,e),this.json}_resolveTree(t,e={}){t.bufferViews&&(t.bufferViews=t.bufferViews.map(((t,e)=>this._resolveBufferView(t,e)))),t.images&&(t.images=t.images.map(((t,e)=>this._resolveImage(t,e)))),t.samplers&&(t.samplers=t.samplers.map(((t,e)=>this._resolveSampler(t,e)))),t.textures&&(t.textures=t.textures.map(((t,e)=>this._resolveTexture(t,e)))),t.accessors&&(t.accessors=t.accessors.map(((t,e)=>this._resolveAccessor(t,e)))),t.materials&&(t.materials=t.materials.map(((t,e)=>this._resolveMaterial(t,e)))),t.meshes&&(t.meshes=t.meshes.map(((t,e)=>this._resolveMesh(t,e)))),t.nodes&&(t.nodes=t.nodes.map(((t,e)=>this._resolveNode(t,e)))),t.skins&&(t.skins=t.skins.map(((t,e)=>this._resolveSkin(t,e)))),t.scenes&&(t.scenes=t.scenes.map(((t,e)=>this._resolveScene(t,e)))),void 0!==t.scene&&(t.scene=t.scenes[this.json.scene])}getScene(t){return this._get("scenes",t)}getNode(t){return this._get("nodes",t)}getSkin(t){return this._get("skins",t)}getMesh(t){return this._get("meshes",t)}getMaterial(t){return this._get("materials",t)}getAccessor(t){return this._get("accessors",t)}getCamera(t){return null}getTexture(t){return this._get("textures",t)}getSampler(t){return this._get("samplers",t)}getImage(t){return this._get("images",t)}getBufferView(t){return this._get("bufferViews",t)}getBuffer(t){return this._get("buffers",t)}_get(t,e){if("object"==typeof e)return e;const r=this.json[t]&&this.json[t][e];return r||console.warn(`glTF file error: Could not find ${t}[${e}]`),r}_resolveScene(t,e){return t.id=t.id||`scene-${e}`,t.nodes=(t.nodes||[]).map((t=>this.getNode(t))),t}_resolveNode(t,e){return t.id=t.id||`node-${e}`,t.children&&(t.children=t.children.map((t=>this.getNode(t)))),void 0!==t.mesh?t.mesh=this.getMesh(t.mesh):void 0!==t.meshes&&t.meshes.length&&(t.mesh=t.meshes.reduce(((t,e)=>{const r=this.getMesh(e);return t.id=r.id,t.primitives=t.primitives.concat(r.primitives),t}),{primitives:[]})),void 0!==t.camera&&(t.camera=this.getCamera(t.camera)),void 0!==t.skin&&(t.skin=this.getSkin(t.skin)),t}_resolveSkin(t,e){return t.id=t.id||`skin-${e}`,t.inverseBindMatrices=this.getAccessor(t.inverseBindMatrices),t}_resolveMesh(t,e){return t.id=t.id||`mesh-${e}`,t.primitives&&(t.primitives=t.primitives.map((t=>{const e=(t={...t}).attributes;t.attributes={};for(const r in e)t.attributes[r]=this.getAccessor(e[r]);return void 0!==t.indices&&(t.indices=this.getAccessor(t.indices)),void 0!==t.material&&(t.material=this.getMaterial(t.material)),t}))),t}_resolveMaterial(t,e){if(t.id=t.id||`material-${e}`,t.normalTexture&&(t.normalTexture={...t.normalTexture},t.normalTexture.texture=this.getTexture(t.normalTexture.index)),t.occlusionTexture&&(t.occlustionTexture={...t.occlustionTexture},t.occlusionTexture.texture=this.getTexture(t.occlusionTexture.index)),t.emissiveTexture&&(t.emmisiveTexture={...t.emmisiveTexture},t.emissiveTexture.texture=this.getTexture(t.emissiveTexture.index)),t.emissiveFactor||(t.emissiveFactor=t.emmisiveTexture?[1,1,1]:[0,0,0]),t.pbrMetallicRoughness){t.pbrMetallicRoughness={...t.pbrMetallicRoughness};const e=t.pbrMetallicRoughness;e.baseColorTexture&&(e.baseColorTexture={...e.baseColorTexture},e.baseColorTexture.texture=this.getTexture(e.baseColorTexture.index)),e.metallicRoughnessTexture&&(e.metallicRoughnessTexture={...e.metallicRoughnessTexture},e.metallicRoughnessTexture.texture=this.getTexture(e.metallicRoughnessTexture.index))}return t}_resolveAccessor(t,e){var r,s;if(t.id=t.id||`accessor-${e}`,void 0!==t.bufferView&&(t.bufferView=this.getBufferView(t.bufferView)),t.bytesPerComponent=(r=t.componentType,ja[r]),t.components=(s=t.type,Da[s]),t.bytesPerElement=t.bytesPerComponent*t.components,t.bufferView){const e=t.bufferView.buffer,{ArrayType:r,byteLength:s}=Aa(t,t.bufferView),n=(t.bufferView.byteOffset||0)+(t.byteOffset||0)+e.byteOffset,i=e.arrayBuffer.slice(n,n+s);t.value=new r(i)}return t}_resolveTexture(t,e){return t.id=t.id||`texture-${e}`,t.sampler="sampler"in t?this.getSampler(t.sampler):Fa,t.source=this.getImage(t.source),t}_resolveSampler(t,e){t.id=t.id||`sampler-${e}`,t.parameters={};for(const e in t){const r=this._enumSamplerParameter(e);void 0!==r&&(t.parameters[r]=t[e])}return t}_enumSamplerParameter(t){return Va[t]}_resolveImage(t,e){t.id=t.id||`image-${e}`,void 0!==t.bufferView&&(t.bufferView=this.getBufferView(t.bufferView));const r=this.images[e];return r&&(t.image=r),t}_resolveBufferView(t,e){t.id=t.id||`bufferView-${e}`;const r=t.buffer;t.buffer=this.buffers[r];const s=this.buffers[r].arrayBuffer;let n=this.buffers[r].byteOffset||0;return"byteOffset"in t&&(n+=t.byteOffset),t.data=new Uint8Array(s,n,t.byteLength),t}_resolveCamera(t,e){return t.id=t.id||`camera-${e}`,t.perspective,t.orthographic,t}}const za=1735152710,Ga=!0;function $a(t,e,r=0,s={}){const n=new DataView(e),i=function(t,e=0){return`${String.fromCharCode(t.getUint8(e+0))}${String.fromCharCode(t.getUint8(e+1))}${String.fromCharCode(t.getUint8(e+2))}${String.fromCharCode(t.getUint8(e+3))}`}(n,r+0),o=n.getUint32(r+4,Ga),a=n.getUint32(r+8,Ga);switch(Object.assign(t,{header:{byteOffset:r,byteLength:a,hasBinChunk:!1},type:i,version:o,json:{},binChunks:[]}),r+=12,t.version){case 1:return function(t,e,r){M(t.header.byteLength>20);const s=e.getUint32(r+0,Ga),n=e.getUint32(r+4,Ga);return r+=8,M(0===n),Wa(t,e,r,s),r+=s,r+=Ha(t,e,r,t.header.byteLength)}(t,n,r);case 2:return function(t,e,r,s){return M(t.header.byteLength>20),function(t,e,r,s){for(;r+8<=t.header.byteLength;){const n=e.getUint32(r+0,Ga),i=e.getUint32(r+4,Ga);switch(r+=8,i){case 1313821514:Wa(t,e,r,n);break;case 5130562:Ha(t,e,r,n);break;case 0:s.strict||Wa(t,e,r,n);break;case 1:s.strict||Ha(t,e,r,n)}r+=ot(n,4)}}(t,e,r,s),r+t.header.byteLength}(t,n,r,{});default:throw new Error(`Invalid GLB version ${t.version}. Only supports v1 and v2.`)}}function Wa(t,e,r,s){const n=new Uint8Array(e.buffer,r,s),i=new TextDecoder("utf8").decode(n);return t.json=JSON.parse(i),ot(s,4)}function Ha(t,e,r,s){return t.header.hasBinChunk=!0,t.binChunks.push({byteOffset:r,byteLength:s,arrayBuffer:e.buffer}),ot(s,4)}async function Qa(t,e,r=0,s,n){var i,o,a,c;!function(t,e,r,s){s.uri&&(t.baseUri=s.uri);if(e instanceof ArrayBuffer&&!function(t,e=0,r={}){const s=new DataView(t),{magic:n=za}=r,i=s.getUint32(e,!1);return i===n||i===za}(e,r,s)){e=(new TextDecoder).decode(e)}if("string"==typeof e)t.json=st(e);else if(e instanceof ArrayBuffer){const n={};r=$a(n,e,r,s.glb),ga("glTF"===n.type,`Invalid GLB magic string ${n.type}`),t._glb=n,t.json=n.json}else ga(!1,"GLTF: must be ArrayBuffer or string");const n=t.json.buffers||[];if(t.buffers=new Array(n.length).fill(null),t._glb&&t._glb.header.hasBinChunk){const{binChunks:e}=t._glb;t.buffers[0]={arrayBuffer:e[0].arrayBuffer,byteOffset:e[0].byteOffset,byteLength:e[0].byteLength}}const i=t.json.images||[];t.images=new Array(i.length).fill({})}(t,e,r,s),function(t,e={}){(new Ua).normalize(t,e)}(t,{normalize:null==s||null===(i=s.gltf)||void 0===i?void 0:i.normalize});const h=[];if(null!=s&&null!==(o=s.gltf)&&void 0!==o&&o.loadBuffers&&t.json.buffers&&await async function(t,e,r){for(let i=0;i<t.json.buffers.length;++i){const o=t.json.buffers[i];if(o.uri){var s,n;const{fetch:a}=r;ga(a);const c=ya(o.uri,e),h=await(null==r||null===(s=r.fetch)||void 0===s?void 0:s.call(r,c)),u=await(null==h||null===(n=h.arrayBuffer)||void 0===n?void 0:n.call(h));t.buffers[i]={arrayBuffer:u,byteOffset:0,byteLength:u.byteLength},delete o.uri}}}(t,s,n),null!=s&&null!==(a=s.gltf)&&void 0!==a&&a.loadImages){const e=async function(t,e,r){const s=t.json.images||[],n=[];for(let i=0;i<s.length;++i)n.push(Ka(t,s[i],i,e,r));return await Promise.all(n)}(t,s,n);h.push(e)}const u=async function(t,e={},r){for(const n in La){var s;const i=(null==e||null===(s=e.gltf)||void 0===s?void 0:s.excludeExtensions)||{};if(!(n in i)||i[n]){const s=La[n];await s.decode(t,e,r)}}}(t,s,n);return h.push(u),await Promise.all(h),null!=s&&null!==(c=s.gltf)&&void 0!==c&&c.postProcess?function(t,e){return(new qa).postProcess(t,e)}(t,s):t}async function Ka(t,e,r,s,n){const{fetch:i,parse:o}=n;let a;if(e.uri){const t=ya(e.uri,s),r=await i(t);a=await r.arrayBuffer()}if(Number.isFinite(e.bufferView)){const r=function(t,e,r){const s=t.bufferViews[r];ga(s);const n=e[s.buffer];ga(n);const i=(s.byteOffset||0)+n.byteOffset;return new Uint8Array(n.arrayBuffer,i,s.byteLength)}(t.json,t.buffers,e.bufferView);a=it(r.buffer,r.byteOffset,r.byteLength)}ga(a,"glTF image has no data");const c=await o(a,pa,{},n);t.images[r]=c}const Ya={name:"glTF",id:"gltf",module:"gltf",version:"3.0.10",extensions:["gltf","glb"],mimeTypes:["model/gltf+json","model/gltf-binary"],text:!0,binary:!0,tests:["glTF"],parse:async function(t,e={},r){(e={...Ya.options,...e}).gltf={...Ya.options.gltf,...e.gltf};const{byteOffset:s=0}=e;return await Qa({},t,s,e,r)},options:{gltf:{normalize:!0,loadBuffers:!0,loadImages:!0,decompressMeshes:!0,postProcess:!0},log:console},deprecatedOptions:{fetchImages:"gltf.loadImages",createImages:"gltf.loadImages",decompress:"gltf.decompressMeshes",postProcess:"gltf.postProcess",gltf:{decompress:"gltf.decompressMeshes"}}};const Za=0,Ja=1;function Xa(t,e,r,s){t.rotateYtoZ=!0;const n=t.byteOffset+t.byteLength-r;if(0===n)throw new Error("glTF byte length must be greater than 0.");return t.gltfUpAxis=s["3d-tiles"]&&s["3d-tiles"].assetGltfUpAxis?s["3d-tiles"].assetGltfUpAxis:"Y",t.gltfArrayBuffer=it(e,r,n),t.gltfByteOffset=0,t.gltfByteLength=n,r%4==0||console.warn(`${t.type}: embedded glb is not aligned to a 4-byte boundary.`),t.byteOffset+t.byteLength}async function tc(t,e,r,s){const n=r["3d-tiles"]||{};if(function(t,e,r){switch(e){case Za:const e=new Uint8Array(t.gltfArrayBuffer,t.gltfByteOffset),r=(new TextDecoder).decode(e);t.gltfUrl=r.replace(/[\s\0]+$/,""),delete t.gltfArrayBuffer,delete t.gltfByteOffset,delete t.gltfByteLength;break;case Ja:break;default:throw new Error("b3dm: Illegal glTF format field")}}(t,e),n.loadGLTF){const{parse:e,fetch:n}=s;t.gltfUrl&&(t.gltfArrayBuffer=await n(t.gltfUrl,r),t.gltfByteOffset=0),t.gltfArrayBuffer&&(t.gltf=await e(t.gltfArrayBuffer,Ya,r,s),delete t.gltfArrayBuffer,delete t.gltfByteOffset,delete t.gltfByteLength)}}async function ec(t,e,r,s,n){var i;r=function(t,e,r,s,n){r=Fo(t,e,r),r=qo(t,e,r),r=zo(t,e,r),r=Xa(t,e,r,s);const i=new Io(t.featureTableJson,t.featureTableBinary);return t.rtcCenter=i.getGlobalProperty("RTC_CENTER",To.FLOAT,3),r}(t,e,r,s),await tc(t,Ja,s,n);const o=null==t||null===(i=t.gltf)||void 0===i?void 0:i.extensions;return o&&o.CESIUM_RTC&&(t.rtcCenter=o.CESIUM_RTC.center),r}async function rc(t,e,r,s,n){return r=function(t,e,r,s,n){if(r=Fo(t,e,r),1!==t.version)throw new Error(`Instanced 3D Model version ${t.version} is not supported`);r=qo(t,e,r);const i=new DataView(e);if(t.gltfFormat=i.getUint32(r,!0),r=zo(t,e,r+=4),r=Xa(t,e,r,s),0===t.featureTableJsonByteLength)throw new Error("i3dm parser: featureTableJsonByteLength is zero.");const o=new Io(t.featureTableJson,t.featureTableBinary),a=o.getGlobalProperty("INSTANCES_LENGTH");if(o.featuresLength=a,!Number.isFinite(a))throw new Error("i3dm parser: INSTANCES_LENGTH must be defined");t.eastNorthUp=o.getGlobalProperty("EAST_NORTH_UP"),t.rtcCenter=o.getGlobalProperty("RTC_CENTER",To.FLOAT,3);new Vo(t.batchTableJson,t.batchTableBinary,a);return function(t,e,r,s){const n=[new Array(s),t._batchTable][0],i=new ur;new ur,new ur,new ur;const o=new wr,a=new ss,c=new ur,h={},u=new Br,l=[],d=[],f=new ur,m=new ur;for(let r=0;r<s;r++){let s;if(e.hasProperty("POSITION"))s=e.getProperty("POSITION",To.FLOAT,3,r,i);else if(e.hasProperty("POSITION_QUANTIZED")){s=e.getProperty("POSITION_QUANTIZED",To.UNSIGNED_SHORT,3,r,i);const t=e.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",To.FLOAT,3,f);if(!t)throw new Error("i3dm parser: QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");const n=e.getGlobalProperty("QUANTIZED_VOLUME_SCALE",To.FLOAT,3,m);if(!n)throw new Error("i3dm parser: QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");const o=65535;for(let e=0;e<3;e++)s[e]=s[e]/o*n[e]+t[e]}if(!s)throw new Error("i3dm: POSITION or POSITION_QUANTIZED must be defined for each instance.");if(i.copy(s),h.translation=i,t.normalUp=e.getProperty("NORMAL_UP",To.FLOAT,3,r,l),t.normalRight=e.getProperty("NORMAL_RIGHT",To.FLOAT,3,r,d),t.normalUp){if(!t.normalRight)throw new Error("i3dm: Custom orientation requires both NORMAL_UP and NORMAL_RIGHT.");t.hasCustomOrientation=!0}else{if(t.octNormalUp=e.getProperty("NORMAL_UP_OCT32P",To.UNSIGNED_SHORT,2,l),t.octNormalRight=e.getProperty("NORMAL_RIGHT_OCT32P",To.UNSIGNED_SHORT,2,d),t.octNormalUp){if(!t.octNormalRight)throw new Error("i3dm: oct-encoded orientation requires NORMAL_UP_OCT32P and NORMAL_RIGHT_OCT32P");throw new Error("i3dm: oct-encoded orientation not implemented")}t.eastNorthUp?(en.WGS84.eastNorthUpToFixedFrame(i,u),u.getRotationMatrix3(o)):o.identity()}a.fromMatrix3(o),h.rotation=a,c.set(1,1,1);const p=e.getProperty("SCALE",To.FLOAT,1,r);Number.isFinite(p)&&c.multiplyByScalar(p);const g=e.getProperty("SCALE_NON_UNIFORM",To.FLOAT,3,r,l);g&&c.scale(g),h.scale=c;let y=e.getProperty("BATCH_ID",To.UNSIGNED_SHORT,1,r);void 0===y&&(y=r);const w=(new Br).fromQuaternion(h.rotation);u.identity(),u.translate(h.translation),u.multiplyRight(w),u.scale(h.scale);const b=u.clone();n[r]={modelMatrix:b,batchId:y}}t.instances=n}(t,o,0,a),r}(t,e,r,s),await tc(t,t.gltfFormat,s,n),r}async function sc(t,e=0,r,s,n={}){switch(n.byteOffset=e,n.type=function(t,e=0){const r=new DataView(t);return`${String.fromCharCode(r.getUint8(e+0))}${String.fromCharCode(r.getUint8(e+1))}${String.fromCharCode(r.getUint8(e+2))}${String.fromCharCode(r.getUint8(e+3))}`}(t,e),n.type){case ki:return await async function(t,e,r,s,n,i){r=Fo(t,e,r);const o=new DataView(e);for(t.tilesLength=o.getUint32(r,!0),r+=4,t.tiles=[];t.tiles.length<t.tilesLength&&t.byteLength-r>12;){const o={};t.tiles.push(o),r=await i(e,r,s,n,o)}return r}(n,t,e,r,s,sc);case Di:return await ec(n,t,e,r,s);case ji:return await rc(n,t,e,r,s);case Ui:return await Ho(n,t,e,r,s);default:throw new Error(`3DTileLoader: unknown type ${n.type}`)}}function nc(t,e){if(t.content){const r=t.content.uri||t.content.url;t.contentUrl=`${e.basePath}/${r}`}return t.id=t.contentUrl,t.lodMetricType=hi,t.lodMetricValue=t.geometricError,t.transformMatrix=t.transform,t.type=function(t){if(!t.contentUrl)return si;const e=t.contentUrl.split(".").pop();switch(e){case"pnts":return ii;case"i3dm":case"b3dm":return ni;default:return e}}(t),t.refine=function(t){switch(t){case"REPLACE":case"replace":return ri;case"ADD":case"add":return ei;default:return t}}(t.refine),t}const ic={id:"3d-tiles",name:"3D Tiles",module:"3d-tiles",version:"3.0.10",extensions:["cmpt","pnts","b3dm","i3dm"],mimeTypes:["application/octet-stream"],tests:["cmpt","pnts","b3dm","i3dm"],parse:async function(t,e,r){const s=e["3d-tiles"]||{};let n;n="auto"===s.isTileset?r.url&&-1!==r.url.indexOf(".json"):s.isTileset;t=n?await async function(t,e,r){const s=JSON.parse((new TextDecoder).decode(t));return s.loader=e.loader||ic,s.url=r.url,s.basePath=function(t){return mt(t.url)}(s),s.root=function(t){const e=t.basePath,r=nc(t.root,t),s=[];for(s.push(r);s.length>0;){const t=s.pop().children||[];for(const r of t)nc(r,{basePath:e}),s.push(r)}return r}(s),s.type=ci,s.lodMetricType=hi,s.lodMetricValue=s.root.lodMetricValue,s}(t,e,r):await async function(t,e,r){const s={content:{featureIds:null}},n=0;return await sc(t,n,e,r,s.content),s.content}(t,e,r);return t},options:{"3d-tiles":{loadGLTF:!0,decodeQuantizedPositions:!1,isTileset:"auto",assetGltfUpAxis:null}}};const oc="https://api.cesium.com/v1/assets";async function ac(t,e){if(!e){const r=await async function(t){M(t);const e=oc,r={Authorization:`Bearer ${t}`},s=await Nt(e,{fetch:{headers:r}});if(!s.ok)throw new Error(s.statusText);return await s.json()}(t);for(const t of r.items)"3DTILES"===t.type&&(e=t.id)}const r=await async function(t,e){M(t,e);const r={Authorization:`Bearer ${t}`},s=`${oc}/${e}`;let n=await Nt(`${s}`,{fetch:{headers:r}});if(!n.ok)throw new Error(n.statusText);let i=await n.json();if(n=await Nt(`${s}/endpoint`,{fetch:{headers:r}}),!n.ok)throw new Error(n.statusText);const o=await n.json();return i={...i,...o},i}(t,e),{type:s,url:n}=r;return M("3DTILES"===s&&n),r.headers={Authorization:`Bearer ${r.accessToken}`},r}const cc={...ic,id:"cesium-ion",name:"Cesium Ion",preload:async function(t,e={}){e=e["cesium-ion"]||{};const{accessToken:r}=e;let s=e.assetId;if(!Number.isFinite(s)){const e=t.match(/\/([0-9]+)\/tileset.json/);s=e&&e[1]}return ac(r,s)},parse:async(t,e,r)=>((e={...e})["3d-tiles"]=e["cesium-ion"],e.loader=cc,ic.parse(t,e,r)),options:{"cesium-ion":{...ic.options["3d-tiles"],accessToken:null}}};function hc(s){const n=64,i=document.createElement("canvas");i.width=n,i.height=n;const o=i.getContext("2d");o.rect(0,0,n,n);const a=o.createLinearGradient(0,0,n,n);for(let t=0;t<s.length;t++){const e=s[t];a.addColorStop(e[0],"#"+e[1].getHexString())}o.fillStyle=a,o.fill();const c=new t(i);return c.needsUpdate=!0,c.minFilter=e,c.wrapS=r,c.wrapT=r,c.repeat.set(2,2),c}function uc(t){t.updateMatrix(),t.updateMatrixWorld(),t.matrixWorldInverse.copy(t.matrixWorld).invert();const e=new s;return e.setFromProjectionMatrix((new n).multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse)),e}function lc(t){const{boundingVolume:e}=t;let r=0;t.content&&(r=Math.min(t.content.byteLength/5e5,1));const s=new d(r,1,0),i=new f(1,1,1),o=new n;e.halfAxes?o.copy(function(t){const e=t;return(new n).fromArray([2*e[0],2*e[1],2*e[2],0,2*e[3],2*e[4],2*e[5],0,2*e[6],2*e[7],2*e[8],0,0,0,0,1])}(e.halfAxes)):e.radius&&i.scale(2*e.radius,2*e.radius,2*e.radius),i.applyMatrix4(o);const c=new m(i),h=new p(c,new g({color:s}));return h.position.copy(new a(...e.center)),h}const dc={SPECTRAL:[[0,new d(.3686,.3098,.6353)],[.1,new d(.1961,.5333,.7412)],[.2,new d(.4,.7608,.6471)],[.3,new d(.6706,.8667,.6431)],[.4,new d(.902,.9608,.5961)],[.5,new d(1,1,.749)],[.6,new d(.9961,.8784,.5451)],[.7,new d(.9922,.6824,.3804)],[.8,new d(.9569,.4275,.2627)],[.9,new d(.8353,.2431,.3098)],[1,new d(.6196,.0039,.2588)]],PLASMA:[[0,new d(.241,.015,.61)],[.1,new d(.387,.001,.654)],[.2,new d(.524,.025,.653)],[.3,new d(.651,.125,.596)],[.4,new d(.752,.227,.513)],[.5,new d(.837,.329,.431)],[.6,new d(.907,.435,.353)],[.7,new d(.963,.554,.272)],[.8,new d(.992,.681,.195)],[.9,new d(.987,.822,.144)],[1,new d(.94,.975,.131)]],YELLOW_GREEN:[[0,new d(.1647,.2824,.3451)],[.1,new d(.1338,.3555,.4227)],[.2,new d(.061,.4319,.4864)],[.3,new d(0,.5099,.5319)],[.4,new d(0,.5881,.5569)],[.5,new d(.137,.665,.5614)],[.6,new d(.2906,.7395,.5477)],[.7,new d(.4453,.8099,.5201)],[.8,new d(.6102,.8748,.485)],[.9,new d(.7883,.9323,.4514)],[1,new d(.9804,.9804,.4314)]],VIRIDIS:[[0,new d(.267,.005,.329)],[.1,new d(.283,.141,.458)],[.2,new d(.254,.265,.53)],[.3,new d(.207,.372,.553)],[.4,new d(.164,.471,.558)],[.5,new d(.128,.567,.551)],[.6,new d(.135,.659,.518)],[.7,new d(.267,.749,.441)],[.8,new d(.478,.821,.318)],[.9,new d(.741,.873,.15)],[1,new d(.993,.906,.144)]],INFERNO:[[0,new d(.077,.042,.206)],[.1,new d(.225,.036,.388)],[.2,new d(.373,.074,.432)],[.3,new d(.522,.128,.42)],[.4,new d(.665,.182,.37)],[.5,new d(.797,.255,.287)],[.6,new d(.902,.364,.184)],[.7,new d(.969,.516,.063)],[.8,new d(.988,.683,.072)],[.9,new d(.961,.859,.298)],[1,new d(.988,.998,.645)]],GRAYSCALE:[[0,new d(0,0,0)],[1,new d(1,1,1)]],TURBO:[[0,new d(.18995,.07176,.23217)],[.07,new d(.25107,.25237,.63374)],[.13,new d(.27628,.42118,.89123)],[.2,new d(.25862,.57958,.99876)],[.27,new d(.15844,.73551,.92305)],[.33,new d(.09267,.86554,.7623)],[.4,new d(.19659,.94901,.59466)],[.47,new d(.42778,.99419,.38575)],[.53,new d(.64362,.98999,.23356)],[.6,new d(.80473,.92452,.20459)],[.67,new d(.93301,.81236,.22667)],[.73,new d(.99314,.67408,.20348)],[.8,new d(.9836,.49291,.12849)],[.87,new d(.92105,.31489,.05475)],[.93,new d(.81608,.18462,.01809)],[1,new d(.66449,.08436,.00424)]],RAINBOW:[[0,new d(.278,0,.714)],[1/6,new d(0,0,1)],[2/6,new d(0,1,1)],[.5,new d(0,1,0)],[4/6,new d(1,1,0)],[5/6,new d(1,.64,0)],[1,new d(1,0,0)]],CONTOUR:[[0,new d(0,0,0)],[.03,new d(0,0,0)],[.04,new d(1,1,1)],[1,new d(1,1,1)]]},fc="\n  varying vec3 vColor;\n  void main() {\n    if (vColor == vec3(0.0, 0.0, 0.0)) {\n      discard;\n    } else {\n      gl_FragColor = vec4( vColor, 1.0 );\n    }\n  }\n",mc="\n  varying vec3 vColor;\n  uniform sampler2D gradient;\n  uniform sampler2D grayscale;\n  attribute float intensity;\n  attribute float classification;\n  uniform vec3 rootCenter;\n  uniform vec3 rootNormal;\n  uniform vec2 elevationRange;\n  uniform int coloring;\n  uniform bool hideGround;\n  uniform float maxIntensity;\n  uniform float intensityContrast;\n\n  #ifdef USE_COLOR\n  vec3 getRGB() {\n      vec3 rgb = color;\n      return rgb;\n  }\n  #endif\n\n  vec3 getElevation(){\n    vec4 world = modelMatrix * vec4( position, 1.0 );\n    float diff = abs(dot(rootNormal, (vec3(world) - rootCenter)));\n    float w = max(diff - elevationRange.x,0.0) / max(elevationRange.y - elevationRange.x,1.0);\n    vec3 cElevation = texture2D(gradient, vec2(w,1.0-w)).rgb;\n\n    return cElevation;\n  }\n\n  vec3 getIntensity(){\n    // TODO: real contrast enhancement. Check https://github.com/yuki-koyama/enhancer/blob/master/shaders/enhancer.fs\n    float intmod = pow(intensity, intensityContrast);\n    vec3 cIntensity = texture2D(grayscale, vec2(intmod / maxIntensity ,1.0-(intmod / maxIntensity))).rgb;\n    return cIntensity;\n  }\n\n  vec3 getClassification(){\n    float classNormalized = classification / 255.0;\n    vec3 cClassification = texture2D(gradient, vec2(classNormalized * 5.0,1.0-classNormalized * 5.0)).rgb;\n    return cClassification;\n  }\n\n  vec3 getColor(){\n      vec3 color;\n      if (hideGround && classification == 2.0) {\n         return vec3(0.0, 0.0, 0.0);               \n      }\n\n      if (coloring == 1) {\n        color = getIntensity();\n      }\n      else if (coloring == 2) {\n        color = getClassification();\n      } else if (coloring == 3) {\n        color = getElevation();\n      } \n      #ifdef USE_COLOR\n      else if (coloring == 4) {\n        color = getRGB();\n      }\n      #endif\n      else {\n        color = vec3(1.0, 1.0, 1.0);\n      }\n      return color;\n  }\n\n  void main() {\n      vColor = getColor();\n\n      gl_PointSize = 1.0;\n      gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n  }\n";var pc,gc;!function(t){t[t.Intensity=1]="Intensity",t[t.Classification=2]="Classification",t[t.Elevation=3]="Elevation",t[t.RGB=4]="RGB",t[t.White=5]="White"}(pc||(pc={})),function(t){t[t.FlatTexture=1]="FlatTexture",t[t.ShadedTexture=2]="ShadedTexture",t[t.ShadedNoTexture=3]="ShadedNoTexture"}(gc||(gc={}));const yc="undefined"!=typeof document?hc(dc.RAINBOW):null,wc="undefined"!=typeof document?hc(dc.GRAYSCALE):null,bc={throttleRequests:!0,maxRequests:64,updateInterval:.1,maxConcurrency:1,maximumScreenSpaceError:16,maximumMemoryUsage:32,viewDistanceScale:1,skipLevelOfDetail:!1,updateTransforms:!0,shading:gc.FlatTexture,pointCloudColoring:pc.White,worker:!0,wireframe:!1,debug:!1,basisTranscoderPath:null,dracoDecoderPath:null,material:null,computeNormals:!1,shaderCallback:null};class _c{static load(t){return A(this,void 0,void 0,(function*(){const e=Object.assign(Object.assign({},bc),t.options),{url:r}=t,s=e.updateInterval,d={};if(e.cesiumIONToken){d["cesium-ion"]={accessToken:e.cesiumIONToken};const t=yield cc.preload(r,d);d.fetch={headers:t.headers}}const f=yield xe(r,ic,Object.assign({},d)),m={},p={},g=[],M=new i,O=new i;e.debug||(O.visible=!1);const I={pointSize:{type:"f",value:1},gradient:{type:"t",value:yc},grayscale:{type:"t",value:wc},rootCenter:{type:"vec3",value:new a},rootNormal:{type:"vec3",value:new a},coloring:{type:"i",value:e.pointCloudColoring},hideGround:{type:"b",value:!0},elevationRange:{type:"vec2",value:new y(0,400)},maxIntensity:{type:"f",value:1},intensityContrast:{type:"f",value:1}};let N=null,R=null;const C=new E;if(e.basisTranscoderPath){const r=new x;r.detectSupport(t.renderer),r.setTranscoderPath(e.basisTranscoderPath+"/"),r.setWorkerLimit(1),C.setKTX2Loader(r)}if(e.dracoDecoderPath){const t=new S;t.setDecoderPath(e.dracoDecoderPath+"/"),t.setWorkerLimit(e.maxConcurrency),C.setDRACOLoader(t)}const L=new w({uniforms:{},vertexShader:"\n  varying vec2 vUv;\n  void main() {\n      vUv = uv;\n      gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n  }\n",fragmentShader:"\n  uniform sampler2D map;\n  varying vec2 vUv;\n\n  void main() {\n    vec4 realColor = texture2D(map, vUv);\n    gl_FragColor = realColor;\n  }\n"}),P={maximumMemoryUsage:e.maximumMemoryUsage,maximumScreenSpaceError:e.maximumScreenSpaceError,viewDistanceScale:e.viewDistanceScale,skipLevelOfDetail:e.skipLevelOfDetail,updateTransforms:e.updateTransforms,throttleRequests:e.throttleRequests,maxRequests:e.maxRequests,contentLoader:t=>A(this,void 0,void 0,(function*(){let r=null;switch(t.type){case ii:r=function(t,e){const r={rtc_center:t.content.rtcCenter,points:t.content.attributes.positions,intensities:t.content.attributes.intensity,classifications:t.content.attributes.classification,rgb:null,rgba:null},{colors:s}=t.content.attributes;s&&3===s.size&&(r.rgb=s.value);s&&4===s.size&&(r.rgba=s.value);const i=new b;i.setAttribute("position",new _(r.points,3));const o=new w({uniforms:e,vertexShader:mc,fragmentShader:fc,transparent:!0});r.rgba?(i.setAttribute("color",new _(r.rgba,4)),o.vertexColors=!0):r.rgb&&(i.setAttribute("color",new T(r.rgb,3,!0)),o.vertexColors=!0);r.intensities&&i.setAttribute("intensity",new T(r.intensities,1,!0));r.classifications&&i.setAttribute("classification",new T(r.classifications,1,!1));const a=new v(i,o);if(r.rtc_center){const t=r.rtc_center;a.applyMatrix4((new n).makeTranslation(t[0],t[1],t[2]))}return a}(t,I);break;case ni:case oi:r=yield function(t,e,r,s,i){return A(this,void 0,void 0,(function*(){return new Promise(((o,c)=>{var h;const l=(new n).makeRotationAxis(new a(1,0,0),Math.PI/2),d="Z"!==(null===(h=e.tileset.asset)||void 0===h?void 0:h.gltfUpAxis),f=(new n).fromArray(e.computedTransform).premultiply(i);d&&f.multiply(l),t.parse(e.content.gltfArrayBuffer,e.contentUrl?e.contentUrl.substr(0,e.contentUrl.lastIndexOf("/")+1):"",(t=>{const e=t.scenes[0];e.applyMatrix4(f),e.traverse((t=>{if(t instanceof u){const e=t.material,n=e.map;s.material?(t.material=s.material.clone(),e.dispose()):s.shading==gc.FlatTexture&&(t.material=r.clone(),e.dispose()),s.shading!=gc.ShadedNoTexture?t.material.uniforms?t.material.uniforms.map={value:n}:t.material.map=n:(n&&n.dispose(),t.material.map=null),s.shaderCallback&&(t.onBeforeRender=s.shaderCallback),t.material.wireframe=s.wireframe,s.computeNormals&&t.geometry.computeVertexNormals()}})),o(e)}),(t=>{c(new Error(`error parsing gltf in tile ${e.id}: ${t}`))}))}))}))}(C,t,L,e,Q)}if(r&&(r.visible=!1,m[t.id]=r,M.add(m[t.id]),e.debug)){const e=lc(t);O.add(e),p[t.id]=e}})),onTileLoad:()=>A(this,void 0,void 0,(function*(){k&&(k._frameNumber++,K(k,m,R,N))})),onTileUnload:t=>{g.push(t)},onTileError:(t,e)=>{console.error("Tile error",t.id,e)}},k=new Pi(f,Object.assign(Object.assign({},P),{loadOptions:Object.assign(Object.assign({},d),{maxConcurrency:e.maxConcurrency,worker:e.worker,gltf:{loadImages:!1},"3d-tiles":{loadGLTF:!1}})}));let U=new n;const D=new n;if(k.root.header.transform){if(D.copy((new n).fromArray(k.root.transform)),1==f.root.children.length&&k.root.children[0].transform){const t=(new n).fromArray(k.root.children[0].transform);D.multiply(t)}}else k.root.header.boundingVolume.region?console.warn("Cannot apply a model matrix to bounding volumes of type region. Tileset stays in place."):D.setPosition(new a(...k.root.boundingVolume.center));U.copy(D).invert();const j=U.clone();let B=new Br(U.toArray());k.modelMatrix=B;let V=!1;const F=new a;I.rootCenter.value.copy(F),I.rootNormal.value.copy(new a(0,0,1).normalize()),k.stats.get("Loader concurrency").count=e.maxConcurrency,k.stats.get("Maximum SSE").count=e.maximumScreenSpaceError,k.stats.get("Maximum mem usage").count=e.maximumMemoryUsage;let q=0;const z=(new n).makeTranslation(1/0,1/0,1/0);let G=null;const $=new a(1/0,1/0,1/0);let W=null;const H=(new n).copy(M.matrixWorld),Q=(new n).copy(H).invert();function K(r,s,n,i){if(V)return;if(!W||i.aspect!=G){const t=new qn({fov:i.fov/180*Math.PI,aspectRatio:i.aspect,near:i.near,far:i.far});W=t.sseDenominator,G=i.aspect,e.debug&&console.log("Updated sse denonimator:",W)}const o=uc(i).planes.map((t=>new Nn(t.normal.toArray(),t.constant))),a=new Pn(o),c=new y;n.getSize(c);const h={camera:{position:$.toArray()},height:c.y,frameNumber:r._frameNumber,sseDenominator:W,cullingVolume:a,viewport:{id:0}};r._cache.reset(),r._traverser.traverse(r.root,h,r.options);for(const t of r.tiles)t.selected?s[t.id]?s[t.id].visible=!0:console.error("TILE SELECTED BUT NOT LOADED!!",t.id):s[t.id]&&(s[t.id].visible=!1);for(;g.length>0;){const t=g.pop();s[t.id]&&t.contentState==Yn&&(M.remove(s[t.id]),vc(s[t.id]),delete s[t.id]),p[t.id]&&(vc(p[t.id]),O.remove(p[t.id]),delete p[t.id])}return t.onProgress&&t.onProgress(r.stats.get("Tiles Loaded").count,r.stats.get("Tiles Loaded").count+r.stats.get("Tiles Loading").count),h}return{model:M,runtime:{getTileset:()=>k,getStats:()=>k.stats,showTiles:t=>{O.visible=t},setWireframe:t=>{e.wireframe=t,M.traverse((e=>{e instanceof u&&(e.material.wireframe=t)}))},setDebug:t=>{e.debug=t,O.visible=t},setShading:t=>{e.shading=t},getTileBoxes:()=>O,setViewDistanceScale:t=>{k.options.viewDistanceScale=t,k._frameNumber++,K(k,m,R,N)},setHideGround:t=>{I.hideGround.value=t},setPointCloudColoring:t=>{I.coloring.value=t},setElevationRange:t=>{I.elevationRange.value.set(t[0],t[1])},setMaxIntensity:t=>{I.maxIntensity.value=t},setIntensityContrast:t=>{I.intensityContrast.value=t},getLatLongHeightFromPosition:t=>{const e=k.ellipsoid.cartesianToCartographic((new a).copy(t).applyMatrix4((new n).copy(U).invert()).toArray());return{lat:e[1],long:e[0],height:e[2]}},getPositionFromLatLongHeight:t=>{const e=k.ellipsoid.cartographicToCartesian([t.long,t.lat,t.height]);return new a(...e).applyMatrix4(U)},getCameraFrustum:t=>{const e=uc(t).planes.map((t=>new Nn(t.normal.toArray(),t.constant))).map((t=>function(t){const e=new i,r=new o(10,5),s=new a(...t.projectPointOntoPlane([0,0,0])),n=new a(t.normal.x,t.normal.y,t.normal.z),d=(new a).copy(s).add(n);r.lookAt(d),r.translate(s.x,s.y,s.z);const f=new c({color:65535,side:h}),m=new u(r,f),p=new l(n,s,5,16776960);return e.add(p),e.add(m),e}(t))),r=new i;for(const t of e)r.add(t);return r},update:function(t,e,r){if(N=r,R=e,q+=t,k&&q>=s){if(!H.equals(M.matrixWorld)){H.copy(M.matrixWorld),U=j.clone(),U.premultiply(H);const t=(new a).setFromMatrixPosition(H);I.rootCenter.value.copy(t),I.rootNormal.value.copy(new a(0,0,1).applyMatrix4(H).normalize()),Q.copy(H).invert(),B=new Br(U.toArray()),k.modelMatrix=B}!(r.matrixWorld.equals(z)&&r.aspect==G)&&(q=0,k._frameNumber++,r.getWorldPosition($),z.copy(r.matrixWorld),K(k,m,e,r))}},dispose:function(){for(V=!0,k._destroy();M.children.length>0;){const t=M.children[0];vc(t),M.remove(t)}for(;O.children.length>0;){const t=O.children[0];O.remove(t),t.geometry.dispose(),t.material.dispose()}}}}}))}}function Tc(t){var e,r,s,n,i,o;(null===(r=null===(e=t)||void 0===e?void 0:e.uniforms)||void 0===r?void 0:r.map)?null===(i=null===(n=null===(s=t)||void 0===s?void 0:s.uniforms)||void 0===n?void 0:n.map.value)||void 0===i||i.dispose():t.map&&(null===(o=t.map)||void 0===o||o.dispose()),t.dispose()}function vc(t){t.traverse((t=>{if(t.isMesh)if(t.geometry.dispose(),t.material.isMaterial)Tc(t.material);else for(const e of t.material)Tc(e)}));for(let e=t.children.length-1;e>=0;e--){const r=t.children[e];t.remove(r)}}export{_c as Loader3DTiles,pc as PointCloudColoring,gc as Shading};
//# sourceMappingURL=three-loader-3dtiles.esm.min.js.map
